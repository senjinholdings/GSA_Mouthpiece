const e=window.__BASE_PATH__??window.SITE_CONFIG?.basePath??"/",t="/"===e||""===e?"":e.replace(/\/+$/,""),n=(()=>{if(!t)return"";const e=t.replace(/\/+$/,"").replace(/\/r\/(\d{1,3})$/i,"");return e?e.startsWith("/")?e:`/${e}`:""})(),i=(()=>{const e=e=>{if(null==e)return null;const t=String(e).match(/\d+/);return t?t[0].padStart(3,"0"):null},t=t=>{const n=(e=>"string"!=typeof e?[]:e.split("/").filter(Boolean))(t);if(0===n.length)return null;const i=n.findIndex(e=>"r"===e.toLowerCase());if(-1!==i&&n[i+1])return e(n[i+1]);for(let t=n.length-1;t>=0;t-=1){const i=n[t].match(/^r[-_]?(\d{1,3})$/i);if(i)return e(i[1])}const a=n[n.length-1];if(a){const t=a.match(/^(\d{1,3})$/);if(t)return e(t[1])}return null},i=t=>{if("string"!=typeof t)return null;try{const n=new URLSearchParams(t);return e(n.get("region_id"))}catch(e){return null}},a=t=>{const n=e(t);return n?("undefined"!=typeof window&&(window.__REGION_ID__=n),n):null},s=t=>{const i=e(t);return i?n?`${n}/r/${i}/`:`/r/${i}/`:null},o=n?`${n}/redirect.html`:"/redirect.html";return{normalizeRegionId:e,detectRegionIdFromPath:t,detectRegionIdFromQuery:i,determineRegionId:({fallback:n="013",prefer:s="path"}={})=>{if("undefined"==typeof window)return n;const o=e(window.__REGION_ID__);if(o)return o;const r=t(window.location.pathname||""),c=i(window.location.search||""),l="query"===s?c||r:r||c;return l?(a(l),l):n},rememberRegionId:a,buildRegionPath:s,buildRedirectPath:()=>o,navigateToRegion:(e,{replace:t=!1}={})=>{const n=s(e);n&&"undefined"!=typeof window&&(a(e),t?window.history.replaceState({},"",n):window.location.assign(n))},getBaseRootPrefix:()=>n}})();function a(e){if("string"!=typeof e||0===e.length)return e;if(/^(?:[a-z][a-z0-9+.-]*:|\/\/|data:|mailto:|tel:)/i.test(e))return e;let n=e.startsWith("./")?e.slice(2):e;try{n=new URL(n,"https://asset-resolver.local").pathname}catch(e){n=n.replace(/^(?:\.\.\/)+/,"")}n.startsWith("/")||(n=`/${n}`);const a=i.getBaseRootPrefix&&i.getBaseRootPrefix()||t;return a&&n.startsWith(`${a}/`)?n:a?`${a}${n}`:n}"undefined"!=typeof window&&(window.RegionUtils=i);class s{getParam(e){return new URLSearchParams(window.location.search).get(e)}setParam(e,t){const n=new URLSearchParams(window.location.search);n.set(e,t),window.history.replaceState({},"",`${window.location.pathname}?${n}`)}getAllParams(){const e=new URLSearchParams(window.location.search),t={};for(const[n,i]of e)t[n]=i;return t}getRegionId(){return i.determineRegionId()}updateRegionId(e,t={}){const n=i.normalizeRegionId(e);n&&(i.rememberRegionId(n),t?.navigate?i.navigateToRegion(n,{replace:!0===t?.replace}):this.setParam("region_id",n))}getClinicUrlWithRegionId(e,t=1){if(!window.dataManager)return"#";const n=this.getRegionId(),a={clinic_id:e,rank:t,region_id:n||"013"},s=new URL(i.buildRedirectPath(),window.location.origin);s.searchParams.set("clinic_id",e),s.searchParams.set("rank",t),n&&s.searchParams.set("region_id",n);const o=JSON.stringify(a);return s.hash=`params=${encodeURIComponent(o)}`,s.toString()}getClinicUrlByNameWithRegionId(e){let t=e;const n=window.dataManager;if(n){const i=(n.clinics||[]).find(t=>t.name===e||t.code===e);i&&(t=i.code)}if(!t)return"#";let a=null,s=1;if(n){const e=(n.clinics||[]).find(e=>e.code===t);if(e){a=e.id;try{if(n.getRankingsByRegion&&"function"==typeof n.getRankingsByRegion){const e=n.getRankingsByRegion(this.getRegionId()).find(e=>e.clinicId==a);e&&(s=e.rank)}else{const e=this.getRegionId();if(n.rankings&&n.rankings[e]){const t=n.rankings[e],i=Object.entries(t.ranks||{});for(const[e,t]of i)if(t==a){s=parseInt(e.replace("no",""))||1;break}}}}catch(e){s=1}}}if(!a)return"#";const o=this.getRegionId();let r=`${i.buildRedirectPath()}?clinic_id=${a}&rank=${s}`;o&&(r+=`&region_id=${o}`);const c=new URLSearchParams(window.location.search),l=c.get("utm_creative"),d=c.get("gclid");return l&&(r+=`&utm_creative=${encodeURIComponent(l)}`),d&&(r+=`&gclid=${encodeURIComponent(d)}`),r}getDirectFormUrl(e,t=1){try{const n=window.dataManager;if(!n)return this.getClinicUrlWithRegionId(e,t);const i=n.getClinicCodeById(e);if(!i)return this.getClinicUrlWithRegionId(e,t);const a=[`直フォームの遷移先URL（${t}位）`,`直フォーム遷移先URL（${t}位）`,`直フォームURL（${t}位）`];for(let e=0;e<a.length;e++){const t=n.getClinicText(i,a[e],"").trim();if(t)return t}const s=["直フォームURL","直フォーム遷移先URL","無料相談フォームURL","予約フォームURL","フォームURL","問い合わせフォームURL","CTA直リンクURL"];for(let e=0;e<s.length;e++){const t=n.getClinicText(i,s[e],"").trim();if(t)return t}return this.getClinicUrlWithRegionId(e,t)}catch(n){return this.getClinicUrlWithRegionId(e,t)}}}class o{constructor(e){this.urlHandler=e,this.regionSelect=document.getElementById("sidebar-region-select"),this.searchInput=document.getElementById("sidebar-clinic-search"),this.selectedRegionName=document.getElementById("selected-region-name"),this.rankingList=document.getElementById("ranking-list"),this.storesList=document.getElementById("stores-list"),this.errorMessage=document.getElementById("error-message"),this.errorText=document.getElementById("error-text"),this.heroRegionBadge=document.getElementById("hero-region-badge"),this.hamburgerMenu=document.getElementById("hamburger-menu"),this.sidebarMenu=document.getElementById("sidebar-menu"),this.sidebarOverlay=document.getElementById("sidebar-overlay"),this.closeSidebar=document.getElementById("close-sidebar")}updateRegionSelector(e,t){if(!this.regionSelect)return void console.warn("Region selector not found");this.regionSelect.innerHTML="";const n=document.createElement("option");n.value="",n.textContent="全地域",n.selected=!0,this.regionSelect.appendChild(n),e.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,this.regionSelect.appendChild(t)})}updateSelectedRegionName(e){this.selectedRegionName&&(this.selectedRegionName.textContent=e||"該当店舗なし"),this.heroRegionBadge&&(this.heroRegionBadge.textContent=e?`${e}版`:"東京版")}updateRankingDisplay(e,t){if(this.rankingList.innerHTML="",!t||0===Object.keys(t.ranks).length)return void(this.rankingList.innerHTML='<div class="empty-state"><p>この地域のランキングデータはありません</p></div>');console.info("[app.js] updateRankingDisplay invoked",{clinicsCount:e?e.length:0,rankingRegion:t.regionId,ranks:t.ranks});Object.entries(t.ranks).sort((e,t)=>parseInt(e[0].replace("no",""))-parseInt(t[0].replace("no",""))).forEach(([t,n])=>{const i=e.find(e=>e.id===n);if(!i)return;const s=parseInt(t.replace("no",""));if(console.debug("[app.js] rendering ranking card",{rank:s,clinicId:n,clinicName:i.name,clinicCode:i.code}),s>5)return;const o=document.createElement("div");o.className=`ranking-item rank-${s}`,o.setAttribute("data-rank",String(s)),o.setAttribute("data-clinic-id",String(i.id));let r="",c=`No.${s}`;1===s?r="gold-medal":2===s?r="silver-medal":3===s&&(r="bronze-medal");const l=window.dataManager.getClinicCodeById(i.id),d=l?parseFloat(window.dataManager.getClinicText(l,"総合評価","4.5")):4.5,g={score:d,stars:d};let m="";const h=Math.floor(g.stars),p=g.stars%1;for(let e=0;e<h;e++)m+='<i class="fas fa-star"></i>';if(p>0){const e=Math.round(100*p);m+=`<i class="fas fa-star" style="background: linear-gradient(90deg, #6bd1d0 ${e}%, transparent ${e}%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>`}for(let e=Math.ceil(g.stars);e<5;e++)m+='<i class="far fa-star"></i>';window.SITE_CONFIG&&window.SITE_CONFIG.imagesPath;const u=window.dataManager.getClinicCodeById(i.id);let f="/common_data/images/clinics/tcb/tcb-logo.webp";if(u){const e=window.dataManager.getClinicText(u,"クリニックロゴ画像パス","");f=e||`/common_data/images/clinics/${u}/${u}-logo.webp`}const y=window.dataManager.getClinicCodeById(i.id),b=y?window.dataManager.getClinicText(y,"ランキングプッシュメッセージ","人気のクリニック"):"人気のクリニック";1!==s||window.__topRankEventPushed||(window.__topRankEventPushed=!0,window.dataLayer=window.dataLayer||[],window.dataLayer.push({event:"ranking_ready",topClinicName:i.name,topClinicCode:y||""}),"dio"===(y||"").toLowerCase()&&window.dataLayer.push({event:"ranking_ready_dio"}));let v="";if(y){const e=window.dataManager.getClinicText(y,"ロゴ画像パス","");if(e)v=e;else{v=`/common_data/images/clinics/${y}/${y}-logo.webp`}}const w=a(v),x=a(`/common_data/images/badges/rank-${s}.svg`);o.innerHTML=`\n                <div class="rank-medal ${r}">\n                    <img src="${x}" alt="${c}" class="medal-image">\n                </div>\n                <div class="clinic-card">\n                    <div class="satisfaction-badge">\n                        <span class="satisfaction-label">満足度</span>\n                    </div>\n                    <div class="rating-section">\n                        <div class="stars">\n                            ${m}\n                        </div>\n                        <div class="rating-score">${g.score}<span class="score-max">/5.0</span></div>\n                    </div>\n                    <div class="clinic-logo-section">\n                        <h3>${i.name}</h3>\n                    </div>\n                    <div class="clinic-banner">\n                        <img src="${w}" alt="${i.name}バナー" onerror="this.style.display='none'">\n                    </div>\n                    <div class="push-message" style="padding: 0px; text-align: center; font-size: clamp(10px, 2.3vw, 15px); line-height: 1.4; color: #333; font-weight: bold; margin: 4px 0; height: 15%;">\n                        ${window.dataManager?.processDecoTags?window.dataManager.processDecoTags(b):b}\n                    </div>\n                    <p class="btn btn_second_primary">\n                        <a href="${this.urlHandler.getClinicUrlWithRegionId(i.id,s)}" target="_blank" rel="noopener">\n                            <span class="bt_s">公式サイト</span>\n                            <span class="btn-arrow">▶</span>\n                        </a>\n                    </p>\n                </div>\n            `,this.rankingList.appendChild(o)})}updateStoresDisplay(e,t){let n=document.querySelector(".brand-section-wrapper");if(!n){n=document.createElement("section"),n.className="brand-section-wrapper";const e=document.querySelector(".ranking-section");e&&e.parentNode?e.parentNode.insertBefore(n,e.nextSibling):document.body.appendChild(n)}if(!e||0===e.length)return void(n.innerHTML='<div style="text-align:center; padding:20px;">この地域には店舗がありません</div>');if(!t||0===t.size)return void(n.innerHTML='<div style="text-align:center; padding:20px;">この地域には店舗がありません</div>');let i='<div class="brand-section" style="max-width: 1200px; margin: 0 auto;">';i+='<h3 style="text-align:center; margin-bottom: 30px; font-size: 24px; color: #333;">東京の店舗一覧</h3>';let a=!1;t.forEach((e,t)=>{e&&e.length>0&&(a=!0,i+=`\n                    <div class="clinic-stores-section" style="margin-bottom: 30px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">\n                        <h4 style="color: #2CC7C5; margin-bottom: 15px; font-size: 20px;">${t.name}の【東京】の店舗</h4>\n                        <div class="stores-list" style="display: grid; gap: 15px;">\n                `,e.forEach(e=>{i+=`\n                        <div class="store-item" style="padding: 15px; background: #f8f9fa; border-left: 3px solid #2CC7C5;">\n                            <div class="store-name" style="font-weight: bold; margin-bottom: 5px;">${e.storeName||e.name||"店舗名不明"}</div>\n                            <div class="store-address" style="color: #666; margin-bottom: 5px;">${e.address||"住所不明"}</div>\n                            <div class="store-access" style="color: #888; font-size: 14px;">${e.access||""}</div>\n                        </div>\n                    `}),i+="\n                        </div>\n                    </div>\n                ")}),a||(i+='<div style="text-align:center; padding:20px;">この地域には店舗がありません</div>'),i+="</div>",n.innerHTML=i}showError(e){this.errorText.textContent=e,this.errorMessage.style.display="block",this.errorTimeout&&clearTimeout(this.errorTimeout),this.errorTimeout=setTimeout(()=>{this.errorMessage.style.display="none"},5e3)}hideError(){this.errorMessage.style.display="none"}updateFooterClinics(e,t){const n=document.querySelectorAll("#footer ul");let i=null;for(const e of n){const t=e.querySelector("h5");if(t&&"人気クリニック"===t.textContent){i=e;break}}if(!i)return;if(i.querySelectorAll("li").forEach(e=>e.remove()),!t||0===Object.keys(t.ranks).length)return;Object.entries(t.ranks).sort((e,t)=>parseInt(e[0].replace("no",""))-parseInt(t[0].replace("no",""))).slice(0,5).forEach(([t,n])=>{const a=e.find(e=>e.id===n);if(!a)return;const s=parseInt(t.replace("no","")),o=document.createElement("li"),r=document.createElement("a");r.href=this.urlHandler.getClinicUrlWithRegionId(a.id,s),r.target="_blank",r.rel="noopener noreferrer",r.textContent=a.name,o.appendChild(r),i.appendChild(o)})}}class r{constructor(){this.regions=[],this.clinics=[],this.stores=[],this.rankings=[],this.storeViews=[],this.campaigns=[],this.siteTexts={},this.clinicTexts={},this.commonDataClinicMap={},this.rankingsByRegion={};const e=e=>e.endsWith("/")?e:`${e}/`;this.dataPath=e(a("/data/")),this.regionDataPath=e(a("/data/ranking/")),this.commonDataPath=e(a("/common_data/data/"))}logClinicTextsLoaded(e){if("undefined"==typeof console||"function"!=typeof console.info)return;const t=this.clinicTexts&&"object"==typeof this.clinicTexts?Object.keys(this.clinicTexts).length:0;console.info(`[DataManager] clinicTexts loaded via ${e}: ${t} entries`)}async init(){try{if(await this.loadFromBundle()||await Promise.all([this.loadRegions(),this.loadClinics(),this.loadRankings(),this.loadStoreViews(),this.loadStores(),this.loadCampaigns().catch(()=>null)]),this.commonTexts&&0!==Object.keys(this.commonTexts).length||(this.commonTexts={},await this.loadCommonTexts()),this.applyCommonTextAssets(),this.clinicTexts&&0!==Object.keys(this.clinicTexts).length||await this.loadClinicTexts(),await this.applyCommonDataOverrides(),!this.campaigns||0===this.campaigns.length)try{await this.loadCampaigns()}catch(e){}if(!this.stores||0===this.stores.length)try{this.stores=[],this.clinics.forEach(e=>{e.stores&&e.stores.forEach(t=>{this.stores.push({id:t.id,clinicName:e.name,storeName:t.name,name:t.name,address:t.address,zipcode:t.zipcode,access:t.access,regionId:this.getRegionIdFromAddress(t.address)})})})}catch(e){}}catch(e){throw e}}async loadFromBundle(){try{const e=await this.fetchJsonWithFallback([this.dataPath+"compiled-data.json",this.dataPath+"data-bundle.json"]);if(!e||Array.isArray(e))return!1;const{regions:t=[],clinics:n=[],rankings:i=[],storeViews:a=[],stores:s=[],campaigns:o=[],commonTexts:r={},clinicTexts:c={}}=e;return this.regions=this.normalizeRegions(t),this.clinics=this.normalizeClinics(n),this.rankings=this.normalizeRankings(i),this.rankingsByRegion=this.createRankingsMap(this.rankings),this.storeViews=this.normalizeStoreViews(a),this.stores=this.normalizeStores(s),this.campaigns=this.normalizeCampaigns(o),this.commonTexts=r,this.clinicTexts=c,this.logClinicTextsLoaded("bundle"),!0}catch(e){return console.warn("⚠️ compiled-data.json 読込エラー:",e),!1}}applyCommonTextAssets(){this.commonTexts&&0!==Object.keys(this.commonTexts).length&&setTimeout(()=>{if(this.commonTexts){if(this.commonTexts["MV画像パス"]){const e=document.querySelector(".hero-image"),t=document.querySelector(".hero-image-wrapper source");e&&(e.src=this.commonTexts["MV画像パス"]),t&&(t.srcset=this.commonTexts["MV画像パス"])}if(this.commonTexts["ランキングバナー画像パス"]){document.querySelectorAll(".ranking-banner-image").forEach(e=>{e.src=this.commonTexts["ランキングバナー画像パス"]})}if(this.commonTexts["Tips1画像パス"]){const e=document.querySelector('.tab-content[data-tab="0"] img');e&&(e.src=this.commonTexts["Tips1画像パス"])}if(this.commonTexts["Tips2画像パス"]){const e=document.querySelector('.tab-content[data-tab="1"] img');e&&(e.src=this.commonTexts["Tips2画像パス"])}if(this.commonTexts["Tips3画像パス"]){const e=document.querySelector('.tab-content[data-tab="2"] img');e&&(e.src=this.commonTexts["Tips3画像パス"])}if(this.commonTexts["詳細バナー画像パス"]){const e=document.querySelector(".details-banner-image");e&&(e.src=this.commonTexts["詳細バナー画像パス"])}}},100)}normalizeRegions(e=[]){return(Array.isArray(e)?e:[]).map(e=>{if(!e)return null;const t=e.id??e.regionId??e.parameter_no??e.parameterNo??"",n=e.name??e.region??"",i=String(t||"").padStart(3,"0");return i&&n?{id:i,name:n}:null}).filter(Boolean)}normalizeClinics(e=[]){return(Array.isArray(e)?e:[]).map(e=>{if(!e)return null;const t=e.id??e.clinic_id??e.clinicId??"",n=e.name??e.clinic_name??e.clinicName??"",i=e.code??e.clinic_code??e.clinicCode??"";return t&&n?{id:String(t),name:n,code:i||""}:null}).filter(Boolean)}normalizeStores(e=[]){return(Array.isArray(e)?e:[]).map(e=>{if(!e)return null;const t=e.id??e.store_id??e.storeId??"",n=e.clinicName??e.clinic_name??"",i=e.storeName??e.store_name??e.name??"",a=e.address??e.adress??"",s=e.zipcode??e.Zipcode??"",o=e.access??"",r=e.regionId??e.region_id??null,c=null!=r&&""!==r?String(r).padStart(3,"0"):null;return t&&n?{id:String(t),clinicName:n,storeName:i,name:i,zipcode:s,address:a,access:o,regionId:c}:null}).filter(Boolean)}normalizeRankings(e=[]){if(!Array.isArray(e))return[];if(e.every(e=>e&&e.ranks))return e.map(e=>({regionId:String(e.regionId??"").padStart(3,"0"),ranks:e.ranks||{}})).filter(e=>e.regionId);const t={};return e.forEach(e=>{if(!e)return;const n=String(e.parameter_no||e.region_id||e.parameterNo||"").padStart(3,"0");n&&"NaN"!==n&&(t[n]||(t[n]={regionId:n,ranks:{}}),Object.keys(e).forEach(i=>{if(!i||!i.startsWith("no"))return;const a=e[i];a&&"-"!==a&&(t[n].ranks[i]=a)}))}),Object.values(t)}normalizeStoreViews(e=[]){return(Array.isArray(e)?e:[]).map(e=>{if(!e)return null;const t=String(e.regionId??e.region_id??e.parameter_no??e.parameterNo??"").padStart(3,"0"),n={};return e.clinicStores&&"object"==typeof e.clinicStores?Object.keys(e.clinicStores).forEach(t=>{const i=e.clinicStores[t];i&&(n[t]=Array.isArray(i)?i:String(i).split(/[\\/|]/).map(e=>e.trim()).filter(Boolean))}):Object.keys(e).forEach(t=>{if(!t||"parameter_no"===t||"parameterNo"===t||"regionId"===t||"region_id"===t)return;if(!/_stores$/.test(t))return;const i=e[t];i&&"-"!==i&&(n[t]=String(i).split(/[\\/|]/).map(e=>e.trim()).filter(Boolean))}),{regionId:t,clinicStores:n}}).filter(e=>e&&e.regionId)}normalizeCampaigns(e=[]){return(Array.isArray(e)?e:[]).map(e=>{if(!e)return null;const t=e.id??e.campaign_id??"",n=e.regionId??e.region_id??"",i=e.clinicId??e.clinic_id??"",a=e.title??"",s=e.headerText??e.header_text??"",o=e.logoSrc??e.logo_src??"",r=e.logoAlt??e.logo_alt??"",c=e.description??"",l=e.ctaText??e.cta_text??"",d=e.ctaUrl??e.cta_url??"",g=e.footerText??e.footer_text??"";return t||i||a?{id:t,regionId:n,clinicId:i,title:a,headerText:s,logoSrc:o,logoAlt:r,description:c,ctaText:l,ctaUrl:d,footerText:g}:null}).filter(Boolean)}async loadCommonTexts(){this.commonTexts={};let e=!1;try{const t=await this.fetchJsonWithFallback([this.dataPath+"site-common-texts.json",this.dataPath+"appeal_text/site-common-texts.json"]);t&&!Array.isArray(t)&&(this.commonTexts={...this.commonTexts,...t},e=!0)}catch(e){console.warn("⚠️ site-common-texts.json 読込エラー:",e)}e||await this.loadCommonTextsFromCsvLegacy();try{const e=await this.fetchJsonWithFallback([this.commonDataPath+"site-common-texts.json",a("/common_data/data/site-common-texts.json")]);e&&!Array.isArray(e)&&(this.commonTexts={...this.commonTexts,...e})}catch(e){console.warn("⚠️ common_dataのsite-common-texts.json読み込みエラー:",e)}if(this.commonTexts["ファビコン画像パス"]){const e=a(this.commonTexts["ファビコン画像パス"]),t=document.getElementById("favicon");t&&(t.href=e);const n=document.getElementById("header-logo-icon");n&&(n.src=e)}}async loadCommonTextsFromCsvLegacy(){try{const e=this.dataPath+"site-common-texts.csv",t=this.dataPath+"appeal_text/site-common-texts.csv";let n=await fetch(e);if(n.ok||(n=await fetch(t)),n.ok){const e=await this.readSiteCommonCsvFromResponse(n);this.commonTexts={...this.commonTexts,...e}}}catch(e){console.warn("⚠️ ローカル site-common-texts.csv 読込エラー:",e)}}async fetchJsonWithFallback(e=[]){for(const t of e)if(t)try{const e=await fetch(t);if(!e||!e.ok)continue;const n=await e.text();if(!n)continue;const i=n.replace(/^\uFEFF/,"").trim();if(!i)continue;return JSON.parse(i)}catch(e){}return null}async readSiteCommonCsvFromResponse(e){const t=await e.arrayBuffer();let n="";try{n=new TextDecoder("utf-8").decode(t)}catch(e){}const i=(n.match(/\uFFFD|�/g)||[]).length;if(!n||i>5)try{n=new TextDecoder("shift_jis").decode(t)}catch(e){}65279===n.charCodeAt(0)&&(n=n.slice(1));const a=n.split(/\r?\n/).filter(e=>e.trim());if(a.length<=1)return{};const s={};for(let e=1;e<a.length;e++){const t=this.parseCsvLineWithQuotes(a[e]);if(t.length>=3){const e=(t[0]||"").trim();let n=(t[2]||"").trim();if(!e)continue;n.startsWith('"')&&n.endsWith('"')&&(n=n.slice(1,-1).replace(/""/g,'"')),s[e]=n}}return s}parseCsvLineWithQuotes(e){const t=[];let n="",i=!1;for(let a=0;a<e.length;a++){const s=e[a],o=e[a+1];'"'===s?i&&'"'===o?(n+='"',a++):i=!i:","!==s||i?n+=s:(t.push(n),n="")}return t.push(n),t}async loadClinicTexts(){try{const e=await this.fetchJsonWithFallback([this.dataPath+"clinic-texts.json",this.dataPath+"clinic_text/clinic-texts.json"]);if(e&&"object"==typeof e&&!Array.isArray(e))return this.clinicTexts=e,void this.logClinicTextsLoaded("clinic-texts.json")}catch(e){console.warn("⚠️ clinic-texts.json の読み込みに失敗しました:",e)}try{await this.loadClinicTextsFromCsvLegacy()}catch(e){console.warn("⚠️ clinic-texts.csv の読み込みに失敗しました:",e),this.clinicTexts&&"object"==typeof this.clinicTexts||(this.clinicTexts={})}}async loadClinicTextsFromCsvLegacy(){try{const e=this.dataPath+"clinic-texts.csv",t=this.dataPath+"clinic_text/clinic-texts.csv";let n=await fetch(e);if(n.ok||(n=await fetch(t)),!n.ok)throw new Error(`Failed to load clinic-texts.csv: ${n.status}`);const i=await n.arrayBuffer();let a="";try{a=new TextDecoder("utf-8").decode(i)}catch(e){}const s=(a.match(/\uFFFD|�/g)||[]).length;if(!a||s>10)try{a=new TextDecoder("shift_jis").decode(i)}catch(e){}const o=this.parseCsvWithQuotes(a);if(!o||0===o.length)return console.warn("⚠️ clinic-texts.csv にレコードがありません"),void(this.clinicTexts={});const r=o[0].slice(3).map(e=>(e||"").trim()).filter(Boolean),c={},l={},d={};r.forEach(e=>{c[e]={}});for(let e=1;e<o.length;e++){const t=o[e];if(!t||0===t.length)continue;const n=(t[0]||"").trim(),i=(t[1]||"").trim();if(n&&i)if(n.startsWith("comparison")){l[`比較表ヘッダー${n.replace("comparison","")}`]=i;for(let e=0;e<r.length;e++){const n=r[e],a=t[e+3]||"";c[n][i]=a}}else if(n.startsWith("detail")){let e="";switch(i){case"費用":e="priceDetail";break;case"目安期間":e="periods";break;case"矯正範囲":e="ranges";break;case"営業時間":e="hours";break;case"店舗":e="stores";break;case"特徴タグ":e="featureTags";break;default:e=i}e&&"特徴タグ"!==e&&(d[e]=i);for(let e=0;e<r.length;e++){const n=r[e],a=t[e+3]||"";c[n][`詳細_${i}`]=a}}else if(n.startsWith("tags"))for(let e=0;e<r.length;e++){const n=r[e],a=t[e+3]||"";c[n][`詳細_${i}`]=a}else if(n.startsWith("meta"))for(let e=0;e<r.length;e++){const n=r[e],a=t[e+3]||"";c[n][i]=a}else{const e={ohmyteeth:"Oh my teeth",invisalign:"インビザライン",kireilign:"キレイライン矯正",zenyum:"ゼニュム",wesmile:"ウィスマイル"};if(e[n]){const a=e[n];c[a]&&(c[a][i]=t[3]||"")}else for(let e=0;e<r.length;e++){const n=r[e],a=t[e+3]||"";c[n][i]=a}}}const g={};g["比較表ヘッダー設定"]=l,g["詳細フィールドマッピング"]=d,g["詳細フィールドマッピング"].officialSite="公式サイトURL",Object.keys(c).forEach(e=>{g[e]=c[e]}),this.clinicTexts=g,this.logClinicTextsLoaded("clinic-texts.csv")}catch(e){console.warn("⚠️ clinic-texts.csv の読み込み/変換に失敗しました:",e),this.clinicTexts={}}}async applyCommonDataOverrides(){const t=function(){try{const t=(e||window.location.pathname||"").match(/mouthpiece(\d{3})/);return t?t[1]:null}catch(e){return null}}(),n=t?`mouthpiece_clinics_data_${t}.json`:"mouthpiece_clinics_data_001.json",i=[this.commonDataPath+n,a(`/common_data/data/${n}`)];let s=null;try{s=await this.fetchJsonWithFallback(i)}catch(e){console.warn(`⚠️ ${n} の読み込みに失敗しました:`,e)}if(!s||"object"!=typeof s)return!1;const o=Array.isArray(s.clinics)?s.clinics:[],r=this.normalizeCommonDataClinics(o);r.length>0&&(this.clinics=r);const c=this.normalizeCommonRankings(s.rankings,r);if(c.length>0?(this.rankings=c,this.rankingsByRegion=this.createRankingsMap(c)):this.rankingsByRegion=this.createRankingsMap(this.rankings),r.length>0){const e={};r.forEach(t=>{const n=o.find(e=>{const n=e&&(e.id??e.code??e.name);return n&&String(n)===t.id})||null;if(!n)return;const i=this.buildClinicTextEntryFromCommon(n,t);e[t.name]=i;const a=t.code||t.id||t.name;a&&(this.commonDataClinicMap[a]={raw:n,texts:i})}),Object.keys(e).length>0&&(this.clinicTexts={...this.clinicTexts||{},...e},this.logClinicTextsLoaded(n))}return!0}normalizeCommonDataClinics(e=[]){return e.map(e=>this.transformCommonClinic(e)).filter(Boolean)}normalizeCommonRankings(e={},t=[]){if(!e||"object"!=typeof e)return[];const n=new Set(t.map(e=>e.id));return Object.entries(e).map(([e,t])=>{const i=Array.isArray(t)?t:[],a={};return i.forEach((e,t)=>{if(!e&&0!==e)return;const i=String(e);(0===n.size||n.has(i))&&(a[`no${t+1}`]=i)}),{regionId:String(e).padStart(3,"0"),ranks:a}}).filter(e=>e&&Object.keys(e.ranks).length>0)}buildClinicTextEntryFromCommon(e,t){const n=t?.name||e?.name||e?.["クリニック名"]||"",i=(t=[],n="")=>{const i=Array.isArray(t)?t:[t];for(const t of i){if(!t)continue;const n=e[t];if(null!=n&&""!==n)return n}return n},s=(e=[],t="")=>{const n=i(e,t);return"string"!=typeof n||""===n.trim()?t:a(n)},o=i(["公式サイトURL","遷移先URL（1位）"],""),r=i(["説明文"],"詳細はお問い合わせください");return{"クリニック名":n,"ブランド名":i(["ブランド名"],n),"INFORMATIONキャンペーンテキスト":i(["INFORMATIONキャンペーンテキスト","キャンペーン内容（赤タグ内）","キャンペーン","キャンペーンテキスト"],""),"INFORMATIONサブテキスト":i(["INFORMATIONサブテキスト","実績テキスト（ボタン上）","サブテキスト"],""),"INFORMATION確認事項":i(["INFORMATION確認事項","確認事項","注意事項","免責事項"],""),"CTAボタンテキスト":i(["CTAボタンテキスト","CTAテキスト（ボタン内）","CTAテキスト"],""),"CTAテキスト（ボタン内）":i(["CTAテキスト（ボタン内）","CTAテキスト","CTAボタンテキスト"],""),"公式サイトURL":o,"遷移先URL（1位）":o,"遷移先URL（2位）":i(["遷移先URL（2位）"],o),"遷移先URL（3位）":i(["遷移先URL（3位）"],o),"クリニックロゴ画像パス":s(["クリニックロゴ画像パス","ロゴ画像","ロゴ"],""),"ロゴ画像パス":s(["ロゴ画像パス","ロゴ画像","ロゴ"],""),"詳細バナー画像パス":s(["詳細バナー画像パス","バナー画像"],""),"ポイント1":i(["ポイント1"],""),"ポイント説明1":i(["ポイント説明1"],""),"ポイント2":i(["ポイント2"],""),"ポイント説明2":i(["ポイント説明2"],""),"ポイント3":i(["ポイント3"],""),"ポイント説明3":i(["ポイント説明3"],""),"POINT1タイトル":i(["POINT1タイトル","ポイント1"],""),"POINT1内容":i(["POINT1内容","ポイント説明1"],""),"POINT2タイトル":i(["POINT2タイトル","ポイント2"],""),"POINT2内容":i(["POINT2内容","ポイント説明2"],""),"POINT3タイトル":i(["POINT3タイトル","ポイント3"],""),"POINT3内容":i(["POINT3内容","ポイント説明3"],""),"ランキングプッシュメッセージ":i(["ランキングプッシュメッセージ","説明文"],""),"説明文":i(["説明文"],""),"INFORMATIONサブテキスト（ボタン上）":i(["INFORMATIONサブテキスト（ボタン上）","実績テキスト（ボタン上）"],""),"総合評価":i(["総合評価"],"4.5"),"比較表の注意事項":i(["比較表の注意事項","注意事項"],""),"詳細_特徴タグ":i(["詳細_特徴タグ","特徴タグ"],""),"メタディスクリプション":i(["メタディスクリプション"],""),"キャンペーンヘッダー":i(["キャンペーンヘッダー","INFORMATIONヘッダー"],""),"CTAボタン背景色":i(["CTAボタン背景色"],""),"CTAボタンテキスト色":i(["CTAボタンテキスト色"],""),"INFORMATIONボタンテキスト":i(["INFORMATIONボタンテキスト"],""),"INFORMATIONボタンリンク":i(["INFORMATIONボタンリンク"],o),"CTAボタンリンク":o||"#",comparison1:i(["comparison1","総合評価"],"4.5"),comparison2:i(["comparison2","料金","ポイント1"],r),comparison3:i(["comparison3","人気","ポイント説明1"],r),comparison4:i(["comparison4","矯正範囲","ポイント説明2"],r),comparison5:i(["comparison5","目安期間"],"要問い合わせ"),comparison6:i(["comparison6","通院頻度"],"要問い合わせ"),comparison7:i(["comparison7","実績/症例数"],"実績多数"),comparison8:i(["comparison8","ワイヤー矯正の紹介"],r),comparison9:i(["comparison9","サポート"],r),banner:s(["バナー画像","詳細バナー画像パス"],"")}}transformCommonClinic(e){if(!e)return null;const t=e.id??e.code??e.name??e["クリニック名"],n=e.name??e["クリニック名"]??"";if(!t||!n)return null;const i=String(t).trim();if(!i)return null;const s=String(e.code??i),o={...e};o.id=i,o.name=n,o.code=s;const r=new Set(["dio","eminal","omt","tcb","sbc","rize","luna","kireiline","shinagawa","seishin","ws","lula","lieto","zenyum","invisalign","at","dsc","kbc","urara","tbs"]);["バナー画像","ロゴ画像","ヘッダーロゴ","詳細バナー画像パス","店舗写真","症例画像1","症例画像2","症例画像3"].forEach(e=>{o[e]&&(o[e]=a(o[e]))});const c=a(`/common_data/images/clinics/${s}/${s}_detail_bnr.webp`),l=a(`/common_data/images/clinics/${s}/${s}-logo.webp`);!o["バナー画像"]&&r.has(s)&&(o["バナー画像"]=c),!o["ロゴ画像"]&&r.has(s)&&(o["ロゴ画像"]=l),r.has(s)||(o["バナー画像"]=o["バナー画像"]||"/images/ranking_header_banner.webp",o["ロゴ画像"]=o["ロゴ画像"]||"/common_data/images/favicon.png"),o["バナー画像"]||(o["バナー画像"]=a(`/common_data/images/clinics/${s}/${s}_detail_bnr.webp`)),o["ロゴ画像"]||(o["ロゴ画像"]=a(`/common_data/images/clinics/${s}/${s}-logo.webp`));const d=(e,t)=>{for(const t of e)if(o[t]&&""!==String(o[t]).trim())return o[t];return t},g=d(["説明文","ポイント説明1","ポイント説明2","ポイント説明3"],"詳細はお問い合わせください");return o.comparison1=o.comparison1||o["総合評価"]||"4.5",o.comparison2=o.comparison2||d(["料金","ポイント1"],g),o.comparison3=o.comparison3||d(["人気","ポイント説明1"],g),o.comparison4=o.comparison4||d(["矯正範囲","ポイント説明2"],g),o.comparison5=o.comparison5||d(["目安期間"],"要問い合わせ"),o.comparison6=o.comparison6||d(["通院頻度"],"要問い合わせ"),o.comparison7=o.comparison7||d(["実績/症例数"],"実績多数"),o.comparison8=o.comparison8||d(["ワイヤー矯正の紹介"],g),o.comparison9=o.comparison9||d(["サポート"],g),o}createRankingsMap(e=[]){const t={};return e.forEach(e=>{e&&e.regionId&&(t[e.regionId]=e)}),t}getReviewTabLabels(e){try{let t={tcb:"TCB",TCB:"TCB",luna:"LUNAビューティークリニック","LUNAビューティークリニック":"LUNAビューティークリニック",rize:"リゼクリニック","リゼクリニック":"リゼクリニック",shinagawa:"品川美容外科","品川美容外科":"品川美容外科",seishin:"聖心美容クリニック","聖心美容クリニック":"聖心美容クリニック"}[e];if(!t){const n=this.clinics.find(t=>t.code===e);t=n?n.name:null}const n=new Set(["比較表ヘッダー設定","詳細フィールドマッピング"]);if(!t){t=Object.keys(this.clinicTexts||{}).filter(e=>!n.has(e))[0]}const i=this.clinicTexts&&t&&this.clinicTexts[t]||{},a=Object.keys(i),s=new Map;for(let e=0;e<a.length;e++){const t=a[e];let n=t.match(/^口コミ([1-3])タイトル（(.+?)）$/);if(n||(n=t.match(/^口コミ([1-3])タイトル\((.+?)\)$/)),!n)continue;const i=parseInt(n[1],10),o=n[2];if(s.has(o)){const e=s.get(o);i<e.minN&&(e.minN=i)}else s.set(o,{firstIndex:e,minN:i})}let o=Array.from(s.entries()).sort((e,t)=>e[1].minN-t[1].minN||e[1].firstIndex-t[1].firstIndex).map(([e])=>e);return 0===o.length&&(o=["コスパ","スタッフ","サービス"]),o.slice(0,3)}catch(e){return["コスパ","スタッフ","サービス"]}}getClinicReviewsByLabel(e,t){const n=[];for(let i=1;i<=3;i++){let a=this.getClinicText(e,`口コミ${i}タイトル（${t}）`,"");a||(a=this.getClinicText(e,`口コミ${i}タイトル(${t})`,""));let s=this.getClinicText(e,`口コミ${i}内容（${t}）`,"");s||(s=this.getClinicText(e,`口コミ${i}内容(${t})`,"")),(a||s)&&n.push({title:a,content:s})}return n}parseCsvWithQuotes(e){const t=e.split(/\r?\n/),n=[];for(let e=0;e<t.length;e++){const i=t[e];if(null==i)continue;const a=String(i);if(!a.trim())continue;const s=[];let o="",r=!1;for(let e=0;e<a.length;e++){const t=a[e];'"'===t?r&&'"'===a[e+1]?(o+='"',e++):r=!r:","!==t||r?o+=t:(s.push(o),o="")}s.push(o),n.push(s)}return n}getRegionIdFromAddress(e){if(!e)return null;for(const t of this.regions)if(e.includes(t.name))return t.id;return null}async loadCsvFile(e){try{const t=[];e.includes("ranking.csv")?(t.push(this.dataPath+e),t.push(this.regionDataPath+e)):e.includes("items.csv")||e.includes("region.csv")||e.includes("store_view.csv")||e.includes("stores.csv")?t.push(this.commonDataPath+e):t.push(this.dataPath+e);let n=null;for(const e of t)try{const t=await fetch(e);if(t.ok){n=t;break}}catch(e){}if(!n)throw new Error(`Failed to load ${e}`);const i=await n.arrayBuffer();let a="";try{a=new TextDecoder("utf-8").decode(i)}catch(e){}const s=(a.match(/\uFFFD|�/g)||[]).length;if(!a||s>10)try{a=new TextDecoder("shift_jis").decode(i)}catch(e){}const o=this.parseCsvWithQuotes(a);if(!o||0===o.length)return[];const r=o[0].map(e=>(e||"").trim()),c=[];for(let e=1;e<o.length;e++){const t=o[e];if(!t||0===t.length||t.every(e=>""===(e||"").trim()))continue;const n={};r.forEach((e,i)=>{n[e]=(t[i]||"").trim()}),c.push(n)}return c}catch(e){throw e}}async loadRegions(){let e=[];try{const t=await this.fetchJsonWithFallback([this.commonDataPath+"出しわけSS - region.json",this.dataPath+"出しわけSS - region.json"]);Array.isArray(t)&&t.length>0&&(e=t)}catch(e){console.warn("⚠️ 出しわけSS - region.json 読込エラー:",e)}e.length||(e=await this.loadCsvFile("出しわけSS - region.csv")),this.regions=this.normalizeRegions(e)}async loadClinics(){let e=[];try{const t=await this.fetchJsonWithFallback([this.commonDataPath+"出しわけSS - items.json",this.dataPath+"出しわけSS - items.json"]);Array.isArray(t)&&t.length>0&&(e=t)}catch(e){console.warn("⚠️ 出しわけSS - items.json 読込エラー:",e)}e.length||(e=await this.loadCsvFile("出しわけSS - items.csv")),this.clinics=this.normalizeClinics(e)}async loadStores(){let e=[];try{const t=await this.fetchJsonWithFallback([this.commonDataPath+"出しわけSS - stores.json",this.dataPath+"出しわけSS - stores.json"]);Array.isArray(t)&&t.length>0&&(e=t)}catch(e){console.warn("⚠️ 出しわけSS - stores.json 読込エラー:",e)}e.length||(e=await this.loadCsvFile("出しわけSS - stores.csv")),this.stores=this.normalizeStores(e)}async loadRankings(){let e=[];try{const t=await this.fetchJsonWithFallback([this.dataPath+"出しわけSS - ranking.json",this.regionDataPath+"出しわけSS - ranking.json"]);Array.isArray(t)&&t.length>0&&(e=t)}catch(e){console.warn("⚠️ 出しわけSS - ranking.json 読込エラー:",e)}e.length||(e=await this.loadCsvFile("出しわけSS - ranking.csv")),this.rankings=this.normalizeRankings(e),this.rankingsByRegion=this.createRankingsMap(this.rankings)}async loadStoreViews(){let e=[];try{const t=await this.fetchJsonWithFallback([this.commonDataPath+"出しわけSS - store_view.json",this.dataPath+"出しわけSS - store_view.json"]);Array.isArray(t)&&t.length>0&&(e=t)}catch(e){console.warn("⚠️ 出しわけSS - store_view.json 読込エラー:",e)}e.length||(e=await this.loadCsvFile("出しわけSS - store_view.csv")),this.storeViews=this.normalizeStoreViews(e)}async loadCampaigns(){let e=[];try{const t=await this.fetchJsonWithFallback([this.dataPath+"出しわけSS - campaigns.json",this.commonDataPath+"出しわけSS - campaigns.json"]);Array.isArray(t)&&t.length>0&&(e=t)}catch(e){console.warn("⚠️ 出しわけSS - campaigns.json 読込エラー:",e)}e.length||(e=await this.loadCsvFile("出しわけSS - campaigns.csv")),this.campaigns=this.normalizeCampaigns(e)}associateStoresWithRegions(){this.stores.forEach(e=>{for(const t of this.regions)if(e.address.includes(t.name)){e.regionId=t.id;break}})}getAllRegions(){return this.regions}getAllClinics(){return this.clinics}getClinicById(e){return this.clinics.find(t=>t.id==e)}getRegionById(e){if("000"===e||"0"===e){const e=this.regions.find(e=>"0"===e.id||"000"===e.id);return e||{id:"000",name:"全国",parentId:null}}const t=String(e).padStart(3,"0"),n=String(parseInt(e,10));return this.regions.find(i=>i.id===n||i.id===t||i.id===String(e))}getClinicCodeById(e){const t=this.clinics.find(t=>t.id===String(e));return t?t.code:null}getSiteText(e,t,n=""){return this.siteTexts&&this.siteTexts[e]&&this.siteTexts[e][t]?this.siteTexts[e][t]:n}getCommonText(e,t="",n={}){let i=t;return this.commonTexts&&this.commonTexts[e]&&(i=this.commonTexts[e]),Object.keys(n).forEach(e=>{const t=new RegExp(`{{${e}}}`,"g");i=i.replace(t,n[e])}),i}getClinicHeaderConfig(){return this.clinicTexts&&this.clinicTexts["比較表ヘッダー設定"]?this.clinicTexts["比較表ヘッダー設定"]:{}}getClinicText(e,t,n=""){let i=t;if(t.startsWith("comparison")){const e=this.clinicTexts&&this.clinicTexts["比較表ヘッダー設定"];if(e){const n=`比較表ヘッダー${t.replace("comparison","")}`;e[n]&&(i=e[n])}}let a={tcb:"TCB",TCB:"TCB",luna:"LUNAビューティークリニック","LUNAビューティークリニック":"LUNAビューティークリニック",rize:"リゼクリニック","リゼクリニック":"リゼクリニック",shinagawa:"品川美容外科","品川美容外科":"品川美容外科",seishin:"聖心美容クリニック","聖心美容クリニック":"聖心美容クリニック"}[e];if(!a){const t=this.clinics.find(t=>t.code===e);a=t?t.name:null}if("比較表の注意事項"===i&&a&&this.clinicTexts&&this.clinicTexts[a]&&this.clinicTexts[a][i],a&&this.clinicTexts&&this.clinicTexts[a]&&this.clinicTexts[a][i]){return this.clinicTexts[a][i]}return n}getClinicRating(e,t=4.5){const n=this.getClinicText(e,"総合評価",t.toString());return parseFloat(n)||t}getClinicName(e,t="クリニック"){return this.getClinicText(e,"クリニック名",t)}processDecoTags(e){return e&&"string"==typeof e?e.replace(/<deco>(.*?)<\/deco>/g,'<span class="deco-text">$1</span>'):e}getClinicReviews(e){const t={cost:[],access:[],staff:[]};for(let n=1;n<=3;n++){const i=this.getClinicText(e,`口コミ${n}タイトル（コスパ）`,""),a=this.getClinicText(e,`口コミ${n}内容（コスパ）`,"");i&&a&&t.cost.push({title:i,content:a})}for(let n=1;n<=3;n++){const i=this.getClinicText(e,`口コミ${n}タイトル（スタッフ）`,""),a=this.getClinicText(e,`口コミ${n}内容（スタッフ）`,"");i&&a&&t.access.push({title:i,content:a})}for(let n=1;n<=3;n++){const i=this.getClinicText(e,`口コミ${n}タイトル（サービス）`,""),a=this.getClinicText(e,`口コミ${n}内容（サービス）`,"");i&&a&&t.staff.push({title:i,content:a})}return t}getRegionName(e){const t=this.getRegionById(e);return t?t.name:""}getStoreImage(e,t){const n=this.clinics?.find(t=>t.code===e);if(n){const t=this.getClinicText(e,"店舗画像パス","");if(t)return t}const i=String(t).padStart(3,"0"),s=`/images/clinics/${e}/${e}_clinic/clinic_image_${i}.webp`;return a(s)}generateMapIframe(e){if(!e)return"<p>住所情報がありません</p>";return`\n            <iframe src="${`https://maps.google.com/maps?q=${encodeURIComponent(e)}&output=embed&z=16`}" width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Google Maps">\n            </iframe>\n        `}generateStoresDisplay(e,t,n=null){const a=this.getClinicCodeById(e);if(!a)return'<div class="shops"><p class="no-stores">店舗情報がありません</p></div>';const s=this.getRankingByRegionId(t);let o=1;if(s&&s.ranks)for(const[t,n]of Object.entries(s.ranks))if(n===e){o=parseInt(t);break}const r=`遷移先URL（${o}位）`;let c=this.getClinicText(a,r,"");c||(c=this.getClinicText(a,"遷移先URL（1位）",""));const l=n||this.getStoreDataForClinic(a,t);if(!l||0===l.length)return'<div class="shops"><p class="no-stores">この地域には店舗がありません</p></div>';const d=l.slice(0,3),g=l.slice(3),m=`shops-${Date.now()}`;let h=`<div class="shops" id="${m}">`;return d.forEach((n,s)=>{const r=n.name||n.storeName||"店舗名不明",l=n.address||"住所情報なし",d=`${i.buildRedirectPath()}#clinic_id=${e}&rank=${o}&region_id=${t}`,g=c?`onclick="localStorage.setItem('redirectParams', JSON.stringify({clinic_id: '${e}', rank: '${o}', region_id: '${t}'})); setTimeout(() => { window.open('${d}', '_blank'); }, 10); return false;"`:"";h+=`\n                <div class='shop'>\n                    <div class='shop-image'>\n                        <img src="${this.getStoreImage(a,s+1)}" alt="${r}" onerror="this.src='${this.getClinicLogoPath(a)}'" />\n                    </div>\n                    <div class='shop-info'>\n                        <div class='shop-name'>\n                            <a href="#" ${g} style="cursor: pointer;">${r}</a>\n                        </div>\n                        <div class='shop-address line-clamp'>\n                            ${l}\n                        </div>\n                    </div>\n                    <a class="shop-btn map-toggle-btn" href="javascript:void(0);" data-store-id="${m}-${s}">\n                        <i class='fas fa-map-marker-alt btn-icon'></i>\n                        地図\n                    </a>\n                </div>\n            `}),g.forEach((n,s)=>{const r=n.name||n.storeName||"店舗名不明",l=n.address||"住所情報なし",d=`${i.buildRedirectPath()}#clinic_id=${e}&rank=${o}&region_id=${t}`,g=c?`onclick="localStorage.setItem('redirectParams', JSON.stringify({clinic_id: '${e}', rank: '${o}', region_id: '${t}'})); setTimeout(() => { window.open('${d}', '_blank'); }, 10); return false;"`:"";h+=`\n                <div class='shop hidden-content hidden'>\n                    <div class='shop-image'>\n                        <img src="${this.getStoreImage(a,s+4)}" alt="${r}" onerror="this.src='${this.getClinicLogoPath(a)}'" />\n                    </div>\n                    <div class='shop-info'>\n                        <div class='shop-name'>\n                            <a href="#" ${g} style="cursor: pointer;">${r}</a>\n                        </div>\n                        <div class='shop-address line-clamp'>\n                            ${l}\n                        </div>\n                    </div>\n                    <a class="shop-btn map-toggle-btn" href="javascript:void(0);" data-store-id="${m}-${s+3}">\n                        <i class='fas fa-map-marker-alt btn-icon'></i>\n                        地図\n                    </a>\n                </div>\n            `}),g.length>0&&(h+=`\n                <button class="more-button" data-target="#${m}" onclick="toggleStores(this)"><span class="button-text">他${g.length}件のクリニックを見る</span></button>\n            `),h+="</div>",h}getStoreDataForClinic(e,t){const n=this.mapRegionId(t);let i=this.storeViews.find(e=>e.regionId===n);if(!i){const e=String(parseInt(n,10));i=this.storeViews.find(t=>t.regionId===e)}if(!i)return[];if(!this.getRankingByRegionId(t))return[];const a=this.clinics.find(t=>t.code===e);if(!a)return[];if(!a.id)return[];const s=`${e}_stores`,o=i.clinicStores[s]||[];if(0===o.length)return[];const r=[];o.forEach(e=>{if(e.includes("/")){const t=e.split("/");r.push(...t)}else r.push(e)});return this.stores.filter(e=>r.includes(e.id)).map(t=>({name:t.storeName||t.name,address:t.address,access:t.access||"主要駅より徒歩圏内",hours:this.getClinicText(e,"営業時間","10:00〜19:00")}))}generateAddressForRegion(e,t=""){const n=this.getRegionById(e);return n?addressPatterns[e]||`${n.name}の主要エリア内`:t||"住所情報準備中"}getClinicLogoPath(e){const t="kireiline"===e?"kireiline":e,n=this.getClinicText(e,"クリニックロゴ画像パス",`/common_data/images/clinics/${t}/${t}-logo.webp`);return a(n)}getClinicDetailData(e){const t=this.getClinicById(e);if(!t)return null;const n=t.code,i=t.name,s=this.clinicTexts["詳細フィールドマッピング"]||{},o={},r={priceDetail:"費用",periods:"目安期間",ranges:"矯正範囲",hours:"営業時間",stores:"店舗",officialSite:"公式サイト"};Object.entries(s).forEach(([e,t])=>{const i=r[e]||e;let a;a="公式サイトURL"===t?this.getClinicText(n,t,""):this.getClinicText(n,`詳細_${t}`,""),o[i]=a});return{title:this.getClinicText(n,"詳細タイトル","医療痩せプログラム"),subtitle:this.getClinicText(n,"詳細サブタイトル","効果的な痩身治療"),link:`${i} ＞`,banner:this.getClinicText(n,"詳細バナー画像パス",(()=>{const e="kireiline"===n?"kireiline":n,t=`/common_data/images/clinics/${e}/${e}_detail_bnr.webp`;return a(t)})()),features:(()=>this.getClinicText(n,"詳細_特徴タグ","# 医療ダイエット<br># 医療痩身<br># リバウンド防止").split("<br>").map(e=>e.replace(/^#\s*/,"").trim()).filter(e=>e))(),priceMain:this.getClinicText(n,"人気プラン","医療痩身コース"),priceValue:(()=>{const e=this.getClinicText(n,"料金","月々4,900円").match(/月々[\d,]+円/);return e?e[0]:"月々4,900円"})(),priceDetail:o,points:[{icon:"lightbulb",title:this.getClinicText(n,"POINT1タイトル","ポイント1"),description:this.getClinicText(n,"POINT1内容","詳細説明1")},{icon:"phone",title:this.getClinicText(n,"POINT2タイトル","ポイント2"),description:this.getClinicText(n,"POINT2内容","詳細説明2")},{icon:"coin",title:this.getClinicText(n,"POINT3タイトル","ポイント3"),description:this.getClinicText(n,"POINT3内容","詳細説明3")}]}}getCurrentClinic(){const e=new URLSearchParams(window.location.search).get("clinic");if(e)return e;const t=this.getCurrentRegionId(),n=this.getRankingByRegionId(t);if(n&&n.ranks&&n.ranks.no1){const e=n.ranks.no1,t=this.getClinicCodeById(e);if(t)return t}const i=this.clinics&&this.clinics[0];return i?i.code:""}getCurrentRegionId(){return i.determineRegionId({fallback:"000"})}mapRegionId(e){const t=String(e).padStart(3,"0"),n=String(parseInt(e,10));if(this.regions.find(i=>i.id===t||i.id===n||i.id===String(e))){const i=this.rankingsByRegion[t]||this.rankingsByRegion[n]||this.rankings.find(i=>i.regionId===t||i.regionId===n||i.regionId===String(e));if(i)return i.regionId}if("000"===e||"0"===e||"0"===String(e))return"000";const i="undefined"!=typeof window&&window.regionMapping&&"object"==typeof window.regionMapping?window.regionMapping:{"001":"013"};return i&&i[t]?i[t]:(console.warn(`Unknown region ID: ${e}, falling back to Tokyo (013)`),"013")}getRankingByRegionId(e){const t=this.mapRegionId(e),n=String(t).padStart(3,"0"),i=String(parseInt(t,10));let a=this.rankingsByRegion[n]||this.rankingsByRegion[i]||this.rankings.find(e=>e.regionId===n||e.regionId===i);return a||(a=this.rankingsByRegion["013"]||this.rankings.find(e=>"013"===e.regionId)),a||null}getRankingsByRegion(e){const t=this.getRankingByRegionId(e);return t&&t.ranks?Object.entries(t.ranks).sort((e,t)=>parseInt(e[0].replace("no",""),10)-parseInt(t[0].replace("no",""),10)).map(([,e])=>String(e)):[]}getStoresByRegionId(e){const t=this.mapRegionId(e);let n=this.storeViews.find(e=>e.regionId===t);if(!n){const e=String(parseInt(t,10));n=this.storeViews.find(t=>t.regionId===e)}if(!n)return console.warn(`⚠️ region_id ${e} (mapped to ${t}) の店舗ビューが見つかりません。`),[];const i=this.getRankingByRegionId(e);if(!i)return console.warn(`⚠️ region_id ${e} のランキングが見つかりません。`),[];const a=[];Object.entries(i.ranks).forEach(([e,t])=>{const i=this.clinics.find(e=>e.id===t);if(!i)return void console.warn(`  ⚠️ Clinic not found for ID: ${t}`);const s=`${i.code}_stores`;n.clinicStores[s]&&a.push(...n.clinicStores[s])});const s=[];a.forEach(e=>{if(e.includes("/")){const t=e.split("/");s.push(...t)}else s.push(e)});return this.stores.filter(e=>s.includes(e.id))}getStoresByClinicName(e){return this.stores.filter(t=>t.clinicName===e)}getStoresByRegionAndClinic(e,t){return this.stores.filter(n=>n.regionId===e&&n.clinicName===t)}getCampaignsByRegionId(e){return this.campaigns.filter(t=>t.regionId===e)}getCampaignByRegionAndClinic(e,t){return this.campaigns.find(n=>n.regionId===e&&n.clinicId===t)}}class c{constructor(){this.urlHandler=new s,this.displayManager=new o(this.urlHandler),this.dataManager=null,this.currentRegionId=null,this.textsInitialized=!1}normalizeRegionId(e){if(null==e)return"";const t=String(e).trim();if(!t)return"";if(/^\d+$/.test(t)){const e=parseInt(t,10);return Number.isNaN(e)?"":e.toString().padStart(3,"0")}return t}isNationalRegion(e,t=null){if("000"===this.normalizeRegionId(e??t?.id))return!0;return"全国"===(t&&t.name?String(t.name).trim():"")}applyRegionLabels(e,t={}){if(!e&&void 0===t.regionId&&null===this.currentRegionId)return;const n=void 0!==t.regionId?t.regionId:e?.id??this.currentRegionId,i=this.normalizeRegionId(n),a=e&&e.name?e.name:"",s=this.isNationalRegion(i,e),o=document.getElementById("mv-region-name");o&&(o.textContent=s?"最新":a);const r=document.getElementById("detail-region-name");if(r)if(s)r.textContent="[最新版] 人気のクリニック",r.style.left="3%";else{r.textContent=`${a}で人気のクリニック`;const e=a.length;let t="3%";2===e?t="4%":3===e&&(t="1%"),r.style.left=t}const c=document.getElementById("comparison-region-name");c&&(s?(c.textContent="",c.style.display="none"):(c.textContent=a,c.style.removeProperty("display")));const l=document.getElementById("rank-region-name");if(l){const e=this.dataManager&&"function"==typeof this.dataManager.getCommonText?this.dataManager.getCommonText("ランキング地域名テキスト","で人気の脂肪溶解注射はココ！"):"で人気の脂肪溶解注射はココ！";if(s){const t=e.replace(/^で/,"");l.textContent=`いま${t}`,l.style.left="52%"}else{l.textContent=`${a}${e}`;const t=a.length;let n="52%";3===t?n="51%":t>=4&&(n="50%"),l.style.left=n}}}async init(){try{this.dataManager=new r,await this.dataManager.init(),window.dataManager=this.dataManager,window.urlHandler=this.urlHandler,this.currentRegionId=this.urlHandler.getRegionId();const e=this.dataManager.getAllRegions();this.displayManager.updateRegionSelector(e,this.currentRegionId),this.setupEventListeners(),this.updatePageContent(this.currentRegionId);try{"function"==typeof window.__renderPrLine&&window.__renderPrLine()}catch(e){}setTimeout(()=>{this.setupMapAccordions()},100)}catch(e){this.displayManager.showError("データの読み込みに失敗しました。ページを再読み込みしてください。")}}setupEventListeners(){this.initializeSidebar(),this.displayManager.regionSelect&&this.displayManager.regionSelect.addEventListener("change",()=>{this.handleClinicSearch(this.displayManager.searchInput?.value||"")}),this.displayManager.searchInput&&this.displayManager.searchInput.addEventListener("input",e=>{this.handleClinicSearch(e.target.value)});const e=document.getElementById("sidebar-specialty-filter");e&&e.addEventListener("change",()=>{this.handleClinicSearch(this.displayManager.searchInput?.value||"")});const t=document.getElementById("sidebar-hours-filter");t&&t.addEventListener("change",()=>{this.handleClinicSearch(this.displayManager.searchInput?.value||"")});const n=document.querySelector(".sidebar-search-link");n&&n.addEventListener("click",e=>{e.preventDefault();const t=new URLSearchParams,n=document.getElementById("sidebar-region-select");n&&n.value&&t.append("search-region",n.value);const i=document.getElementById("sidebar-clinic-search");i&&i.value&&t.append("clinic",i.value);const a=document.getElementById("sidebar-specialty-filter");a&&a.value&&t.append("bodyPart",a.value);const s=document.getElementById("sidebar-hours-filter");s&&s.value&&t.append("storeCount",s.value),t.append("region_id",this.currentRegionId);const o=`${(window.SITE_CONFIG?window.SITE_CONFIG.basePath:"")||"."}/search-results.html?${t.toString()}`;window.location.href=o}),this.displayManager.hamburgerMenu&&this.displayManager.hamburgerMenu.addEventListener("click",e=>{e.stopPropagation(),this.displayManager.hamburgerMenu.classList.toggle("active"),this.displayManager.sidebarMenu.classList.toggle("active"),this.displayManager.sidebarOverlay.classList.toggle("active")}),this.displayManager.closeSidebar&&this.displayManager.closeSidebar.addEventListener("click",()=>{this.displayManager.hamburgerMenu.classList.remove("active"),this.displayManager.sidebarMenu.classList.remove("active"),this.displayManager.sidebarOverlay.classList.remove("active")}),this.displayManager.sidebarOverlay&&this.displayManager.sidebarOverlay.addEventListener("click",()=>{this.displayManager.hamburgerMenu.classList.remove("active"),this.displayManager.sidebarMenu.classList.remove("active"),this.displayManager.sidebarOverlay.classList.remove("active")})}changeRegion(e){this.currentRegionId=e,this.updatePageContent(e)}getClinicStoresByRegion(e,t){const n=e.replace(/の\d+$/,"").trim(),i=this.dataManager.getStoresByRegionId(t),a=n;return i.filter(e=>e.clinicName===a)}handleClinicSearch(e){const t=e.toLowerCase().trim(),n=document.getElementById("sidebar-region-select")?.value||"",i=document.getElementById("sidebar-specialty-filter")?.value||"",a=document.getElementById("sidebar-hours-filter")?.value||"",s=document.querySelectorAll(".ranking-item");let o=0;s.forEach(e=>{const s=e.querySelector(".clinic-logo-section"),r=s?s.textContent.trim():"",c=""===t||r.toLowerCase().includes(t);let l=!0;if(n){l=this.getClinicStoresByRegion(r,n).length>0}c&&l&&""===i&&""===a?(e.style.display="",o++):e.style.display="none"});const r=document.querySelectorAll("#ranking-tbody tr, #treatment-tbody tr, #service-tbody tr");let c=0;r.forEach(e=>{const i=e.querySelector(".clinic-main-name")?.textContent||"",a=""===t||i.toLowerCase().includes(t);let s=!0;if(n){s=this.getClinicStoresByRegion(i,n).length>0}a&&s?(e.style.display="",c++):e.style.display="none"});document.querySelectorAll(".detail-item").forEach(e=>{const i=e.querySelector(".clinic-name")?.textContent||"",a=""===t||i.toLowerCase().includes(t);let s=!0;if(n){s=this.getClinicStoresByRegion(i,n).length>0}e.style.display=a&&s?"":"none"});const l=document.getElementById("ranking-list"),d=document.getElementById("no-search-results");if(0===o&&""!==t){if(!d){const t=document.createElement("div");t.id="no-search-results",t.className="empty-state",t.innerHTML="<p>「"+e+"」に一致するクリニックが見つかりませんでした</p>",l.appendChild(t)}}else d&&d.remove();const g=document.querySelector(".tab-content.active tbody"),m=document.getElementById("no-search-results-row");if(0===c&&""!==t&&g){if(!m){const e=document.createElement("tr");e.id="no-search-results-row",e.innerHTML='<td colspan="5" class="empty-state"><p>検索結果が見つかりませんでした</p></td>',g.appendChild(e)}}else m&&m.remove()}updatePageContent(e){try{const t=String(parseInt(e,10)),n=this.dataManager.mapRegionId(e);let i;"000"===e||"0"===e||"0"===String(e)?(i={id:"000",name:"全国",parentId:null},console.log("Created 全国 region object:",i)):(i=this.dataManager.getRegionById(String(parseInt(n,10))),i||(console.warn(`Region not found for mapped ID: ${n}, falling back to Tokyo`),i=this.dataManager.getRegionById("13"))),this.displayManager.updateSelectedRegionName(i.name);const a=document.getElementById("mv-region-text");a&&(a.textContent=i.name),this.applyRegionLabels(i,{regionId:e}),this.textsInitialized?(this.updateAllTexts(e),setTimeout(()=>{this.forceUpdateRegionNames(i)},50)):setTimeout(()=>{this.updateAllTexts(e),this.textsInitialized=!0,setTimeout(()=>{this.forceUpdateRegionNames(i)},50)},100),this.applyRegionLabels(i,{regionId:e});const s=document.querySelectorAll(".ranking-banner-image");if(s.length>0){const e=this.dataManager.getCommonText("ランキングバナーAltテキスト","で人気の脂肪溶解注射はココ！");s.forEach(t=>{t.alt=i.name+e})}const o=this.dataManager.getRankingByRegionId(e),r=this.dataManager.getAllClinics();this.displayManager.updateRankingDisplay(r,o),this.displayManager.updateFooterClinics(r,o),this.updateComparisonHeaders(),this.updateComparisonTable(r,o),this.setupComparisonTabs(),this.updateClinicDetails(r,o,t),setTimeout(()=>{try{g()}catch(e){}},0),setTimeout(()=>{l()},100),setTimeout(()=>{this.setupMapAccordions()},100),this.displayManager.hideError()}catch(t){console.error("Error in updatePageContent:",t),this.displayManager.showError("データの表示に問題が発生しました。"),"000"!==e&&this.changeRegion("000")}}restoreRegionNames(e){this.applyRegionLabels(e,{regionId:e?.id??this.currentRegionId})}forceUpdateRegionNames(e){this.applyRegionLabels(e,{regionId:e?.id??this.currentRegionId})}updateAllTexts(e){try{const t=this.dataManager.getCurrentClinic(),n=this.dataManager.mapRegionId(e),i=this.normalizeRegionId(n??e);let a=null;if("000"===i)a={id:"000",name:"全国"};else{const e=this.dataManager.getRegionById(String(parseInt(i||"0",10)));e&&(a={id:this.normalizeRegionId(e.id),name:e.name})}a||(a={id:i||"",name:""});const s=this.isNationalRegion(e,a),o=document.querySelector('meta[name="description"]');if(o){const e=this.dataManager.getClinicText(t,"メタディスクリプション","あなたの地域の優良クリニックを探そう。");o.setAttribute("content",e)}const r=document.querySelector(".site-logo");if(r){const e=this.dataManager.getCommonText("サイト名","医療ダイエット比較.com");r.textContent=e}else console.warn("⚠️ サイトロゴ要素が見つかりません");const c=document.getElementById("mv-left-appeal-text");if(c){const e=this.dataManager.getCommonText("MVアピールテキスト1","コスパ");c.textContent=e}const l=document.querySelector("#mv-main-svg-text text");if(l){const e=this.dataManager.getCommonText("MVSVGテキスト1","脂肪溶解注射");l.textContent=e}const d=document.querySelector("#mv-appeal1-text text");if(d){const t=String(parseInt(e,10)),n=this.dataManager.getRankingByRegionId(t);let i=5;if(n&&n.ranks){const e=Object.entries(n.ranks).filter(([e,t])=>"-"!==t&&null!=t).length;e>0&&(i=Math.min(e,5))}const a=this.dataManager.getCommonText("MVSVGテキスト2","ランキング",{RANK_COUNT:i});d.textContent=a;const s=document.getElementById("detail-rank-best");s&&(s.innerHTML=`${i}<span style="font-size: 0.6em;"> 選！</span>`)}const g=document.querySelector(".ranking-banner-image");if(g){const e=this.dataManager.getCommonText("ランキングバナーalt","で人気の脂肪溶解注射はここ！");g.setAttribute("alt",e)}const m=document.querySelector(".comparison-title");if(m){const e=this.dataManager.getCommonText("比較表タイトル","で人気の脂肪溶解注射"),t=s?e.replace(/^で/,""):e,n=s?' style="display:none;"':"",i=s?"":a?.name||"";m.innerHTML=`<span id="comparison-region-name"${n}>${i}</span>${t}`}const h=document.querySelector(".comparison-subtitle");if(h){const e=this.dataManager.getCommonText("比較表サブタイトル",'クリニックを<span class="pink-text">徹底比較</span>');h.innerHTML=this.dataManager.processDecoTags(e)}this.applyRegionLabels(a,{regionId:e});const p=document.querySelector(".details-banner-image");if(p){const e=this.dataManager.getCommonText("案件詳細バナーalt","コスパ×効果×通いやすさで選ぶ脂肪冷却BEST3");p.setAttribute("alt",e)}const u=document.querySelector(".footer_contents h4 a");if(u){const e=this.dataManager.getCommonText("サイト名","医療ダイエット比較.com");u.textContent=e}const f=document.querySelector(".copyright");if(f){const e="© 2025 "+this.dataManager.getCommonText("サイト名","医療ダイエット比較.com");f.textContent=e}const y=document.querySelectorAll(".tips-container .tab-text");y.length>=3&&(y[0].textContent=this.dataManager.getCommonText("Tipsタブ1タイトル","効果"),y[1].textContent=this.dataManager.getCommonText("Tipsタブ2タイトル","選び方"),y[2].textContent=this.dataManager.getCommonText("Tipsタブ3タイトル","おすすめ"));const b=document.querySelectorAll(".tips-container .tab-content");if(b.length>=3){const e=b[0].querySelector("p");if(e){const t=this.dataManager.getCommonText("Tips1内容","");e.innerHTML=this.dataManager.processDecoTags(t)}const t=b[1].querySelector("p");if(t){const e=this.dataManager.getCommonText("Tips2内容","");t.innerHTML=this.dataManager.processDecoTags(e)}const n=b[2].querySelector("p");if(n){const e=this.dataManager.getCommonText("Tips3内容","");n.innerHTML=this.dataManager.processDecoTags(e)}}if(this.dataManager.getCommonText("注意事項HTML","")){const e=document.querySelector(".disclaimer-accordion");if(e){e.querySelector(".main-disclaimer")}}}catch(e){console.error("❌ updateAllTextsでエラーが発生:",e)}}groupStoresByClinics(e,t,n){const i=new Map;if(!t||!e||0===e.length)return i;return Object.entries(t.ranks).sort((e,t)=>parseInt(e[0].replace("no",""))-parseInt(t[0].replace("no",""))).forEach(([t,a])=>{const s=n.find(e=>e.id===a);if(s){const t=s.name,n=e.filter(e=>e.clinicName===t);i.set(s,n)}}),i}updateComparisonHeaders(){const e=document.getElementById("comparison-header-row");if(!e)return;e.innerHTML="";const t=this.dataManager.clinicTexts["比較表ヘッダー設定"]||{};[{key:null,default:"",class:"",fixed:!0},{key:"比較表ヘッダー1",default:"",class:""},{key:"比較表ヘッダー2",default:"",class:""},{key:"比較表ヘッダー3",default:"",class:""},{key:"比較表ヘッダー10",default:"",class:""},{key:"比較表ヘッダー4",default:"",class:"th-none",style:"display: none;"},{key:"比較表ヘッダー5",default:"",class:"th-none",style:"display: none;"},{key:"比較表ヘッダー6",default:"",class:"th-none",style:"display: none;"},{key:"比較表ヘッダー7",default:"",class:"th-none",style:"display: none;"},{key:"比較表ヘッダー8",default:"",class:"th-none",style:"display: none;"},{key:"比較表ヘッダー9",default:"",class:"th-none",style:"display: none;"},{key:null,default:"",class:"th-none",style:"display: none;",fixed:!0}].forEach(n=>{const i=document.createElement("th");n.fixed?i.textContent=n.default:i.textContent=t[n.key]||n.default,n.class&&(i.className=n.class),n.style&&i.setAttribute("style",n.style),e.appendChild(i)})}createTabButtons(){}setupComparisonTabs(){const e=document.querySelectorAll(".comparison-tab-menu-item");if(!e||0===e.length)return;const t={tab1:["クリニック名","comparison1","comparison2","comparison3","公式サイト"],tab2:["クリニック名","comparison4","comparison5","comparison6","公式サイト"],tab3:["クリニック名","comparison7","comparison8","comparison9","公式サイト"]};e.forEach(e=>{const n=e.cloneNode(!0);e.parentNode.replaceChild(n,e),n.addEventListener("click",e=>{e.preventDefault(),document.querySelectorAll(".comparison-tab-menu-item").forEach(e=>{e.classList.remove("tab-active")}),n.classList.add("tab-active");const i=n.getAttribute("data-tab");this.regenerateTableForTab(i,t[i]||t.tab1)})}),this.regenerateTableForTab("tab1",t.tab1)}regenerateTableForTab(e,t){const n=document.getElementById("comparison-tbody"),s=document.getElementById("comparison-header-row");if(!n||!t)return;const o={comparison1:"比較表ヘッダー1",comparison2:"比較表ヘッダー2",comparison3:"比較表ヘッダー3",comparison4:"比較表ヘッダー4",comparison5:"比較表ヘッダー5",comparison6:"比較表ヘッダー6",comparison7:"比較表ヘッダー7",comparison8:"比較表ヘッダー8",comparison9:"比較表ヘッダー9"};if(s){s.innerHTML="";const e=this.dataManager.clinicTexts["比較表ヘッダー設定"]||{};t.forEach(t=>{const n=document.createElement("th");if("クリニック名"===t)n.textContent="クリニック";else if("公式サイト"===t)n.textContent="公式サイト";else if(o[t]){const i=o[t];n.textContent=e[i]||t}else n.textContent=t;s.appendChild(n)})}n.innerHTML="";this.getCurrentDisplayedClinics().forEach((e,s)=>{const o=document.createElement("tr");0===s?o.style.backgroundColor="#fffbdc":2!==s&&4!==s||(o.style.backgroundColor="rgb(249 249 249)");const r=e.rank||s+1,c=e.id,l=this.currentRegionId||"000",d=e.code;t.forEach(t=>{const n=document.createElement("td");if("クリニック名"===t){window.SITE_CONFIG&&window.SITE_CONFIG.imagesPath;let t=this.dataManager.getClinicText(d,"クリニックロゴ画像パス","");if(!t){const e=d;t=a(`/common_data/images/clinics/${e}/${e}-logo.webp`),"localhost"===window.location.hostname||window.location.hostname}t&&(t=a(t));const s=`${i.buildRedirectPath()}#clinic_id=${c}&rank=${r}&region_id=${l}`,o=`onclick="localStorage.setItem('redirectParams', JSON.stringify({clinic_id: '${c}', rank: '${r}', region_id: '${l}'})); setTimeout(() => { window.open('${s}', '_blank'); }, 10); return false;"`;n.className="ranking-table_td1",n.innerHTML=`\n                        <img src="${t}" alt="${e.name}" width="80" data-rank="${r}" class="comparison-logo">\n                        <a href="#" ${o} class="clinic-link" style="cursor: pointer;">${e.name}</a>\n                    `}else if("comparison1"===t){const e=this.dataManager.getClinicText(d,"comparison1","4.5");n.innerHTML=`\n                        <span class="ranking_evaluation">${e}</span><br>\n                        <span class="star5_rating" data-rate="${e}"></span>\n                    `}else if("公式サイト"===t)n.innerHTML=`\n                        <a class="link_btn" href="${this.urlHandler.getClinicUrlWithRegionId(e.id,e.rank||r)}" target="_blank">公式サイト &gt;</a><br>\n                        <a class="detail_btn" href="#clinic${r}">詳細をみる</a>\n                    `;else if(t.startsWith("comparison")){const e=this.dataManager.getClinicText(d,t,"");e?n.innerHTML=this.dataManager.processDecoTags(e):(n.innerHTML="",console.log(`警告: ${d}の${t}フィールドが空です`))}else{const e=this.dataManager.getClinicText(d,t,"");n.innerHTML=this.dataManager.processDecoTags(e||"")}o.appendChild(n)}),n.appendChild(o)}),this.initializeStarRatings(),this.setupDetailScrollLinks()}initializeSidebar(){const e=this.displayManager.hamburgerMenu,t=this.displayManager.sidebarMenu,n=this.displayManager.sidebarOverlay,i=this.displayManager.closeSidebar;console.log("[Sidebar] Initializing sidebar:",{hamburgerMenu:!!e,sidebarMenu:!!t,sidebarOverlay:!!n,closeSidebar:!!i}),t&&t.classList.remove("active"),n&&n.classList.remove("active"),e?(console.log("[Sidebar] Adding click listener to hamburger menu"),e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),console.log("[Sidebar] Hamburger menu clicked"),t&&(t.classList.toggle("active"),console.log("[Sidebar] Sidebar active:",t.classList.contains("active"))),n&&n.classList.toggle("active")})):console.warn("[Sidebar] Hamburger menu not found!"),i&&i.addEventListener("click",()=>{t&&t.classList.remove("active"),n&&n.classList.remove("active")}),n&&n.addEventListener("click",()=>{t&&t.classList.remove("active"),n&&n.classList.remove("active")})}getCurrentDisplayedClinics(){if(this.dataManager&&void 0!==this.currentRegionId){const e=this.dataManager.getRankingByRegionId(this.currentRegionId),t=this.dataManager.clinics||[];if(e&&e.ranks){const n=[];if(["no1","no2","no3","no4","no5"].forEach((i,a)=>{const s=e.ranks[i];if(s&&"-"!==s){const e=parseInt(s),i=t.find(t=>t.id==s||t.id===e);i&&n.push({...i,rank:a+1})}}),n.length>0)return n}}return this.getLatestRankingData()}getLatestRankingData(){if(console.warn("フォールバックデータが使用されています。実際のランキングデータが取得できませんでした。"),window.dataManager&&window.dataManager.clinics){return window.dataManager.clinics.filter(e=>["1","2","3","4","5"].includes(e.id)).slice(0,5).map((e,t)=>({...e,rank:t+1}))}}initializeStarRatings(){document.querySelectorAll(".star5_rating[data-rate]").forEach(e=>{parseFloat(e.getAttribute("data-rate"))})}updateTableColumns(e,t){if(!e)return;const n=e.querySelector("thead tr");if(n){n.querySelectorAll("th").forEach((e,n)=>{t.includes(n)?(e.style.display="",e.classList.remove("th-none")):(e.style.display="none",e.classList.add("th-none"))})}e.querySelectorAll("tbody tr").forEach(e=>{e.querySelectorAll("td").forEach((e,n)=>{t.includes(n)?(e.style.display="",e.classList.remove("th-none")):(e.style.display="none",e.classList.add("th-none"))})})}updateComparisonTable(e,t){if(!t||0===Object.keys(t.ranks).length)return;const n=[];["no1","no2","no3","no4","no5"].forEach((i,a)=>{const s=t.ranks[i];if(s&&"-"!==s){const t=parseInt(s),i=e.find(e=>e.id==s||e.id===t);i&&n.push({...i,rank:a+1})}}),this.setupComparisonTabs();const i=this.getCurrentDisplayedClinics();i&&i.length>0&&this.updateFirstChoiceRecommendation(i[0]),this.setupReviewTabs(),this.setupDetailScrollLinks()}generateComparisonTable(e){const t=document.getElementById("comparison-tbody");if(!t)return;t.innerHTML="";const n=this.dataManager.clinicTexts["比較表ヘッダー設定"]||{},s=n["比較表ヘッダー2"]||"コスト",o=n["比較表ヘッダー3"]||"人気";e.forEach((e,n)=>{const r=document.createElement("tr");0===n?r.style.backgroundColor="#fffbdc":2!==n&&4!==n||(r.style.backgroundColor="rgb(249 249 249)");const c=e.rank||n+1,l=e.id,d=this.currentRegionId||"000",g=e.code,m=(e,t="")=>this.dataManager.getClinicText(g,e,t);let h=m("meta13","")||m("クリニックロゴ画像パス","");if(!h){h=`/common_data/images/clinics/${g}/${g}-logo.webp`}const p=a(h),u=`onclick="localStorage.setItem('redirectParams', JSON.stringify({clinic_id: '${l}', rank: '${c}', region_id: '${d}'})); setTimeout(() => { window.open('${`${i.buildRedirectPath()}#clinic_id=${l}&rank=${c}&region_id=${d}`}', '_blank'); }, 10); return false;"`;r.innerHTML=`\n                <td class="ranking-table_td1">\n                    <img src="${p}" alt="${e.name}" width="80">\n                    <a href="#" ${u} class="clinic-link" style="cursor: pointer;">${e.name}</a>\n                </td>\n                <td class="" style="">\n                    <span class="ranking_evaluation">${m("総合評価","4.5")}</span><br>\n                    <span class="star5_rating" data-rate="${m("総合評価","4.5")}"></span>\n                </td>\n                <td class="" style="">${this.dataManager.processDecoTags(m(s,""))}</td>\n                <td class="" style="">${this.dataManager.processDecoTags(m(o,""))}</td>\n                <td>\n                    <a class="link_btn" href="${this.urlHandler.getClinicUrlWithRegionId(e.id,e.rank||c)}" target="_blank">公式サイト &gt;</a><br>\n                    <a class="detail_btn" href="#clinic${c}">詳細をみる</a>\n                </td>\n                <td class="th-none" style="display: none;">${this.dataManager.processDecoTags(m("",""))}</td>\n                <td class="th-none" style="display: none;">${this.dataManager.processDecoTags(m("",""))}</td>\n                <td class="th-none" style="display: none;">${this.dataManager.processDecoTags(m("",""))}</td>\n                <td class="th-none" style="display: none;">${this.dataManager.processDecoTags(m("",""))}</td>\n                <td class="th-none" style="display: none;">${this.dataManager.processDecoTags(m("",""))}</td>\n                <td class="th-none" style="display: none;">${this.dataManager.processDecoTags(m("",""))}</td>\n            `,t.appendChild(r)})}updateComparisonDisclaimers(e){const t=document.getElementById("main-content");t?(console.log("updateComparisonDisclaimers called with:",e),t.innerHTML="",e&&0!==e.length?(e.forEach((e,n)=>{const i=document.createElement("div");i.style.cssText="margin-bottom: 15px; padding: 10px; border-left: 3px solid #6bd1d0;";const a=document.createElement("div");a.style.cssText="font-weight: 600; color: #333; margin-bottom: 5px; font-size: 12px;",a.textContent=`【${e.clinicName}】`;const s=document.createElement("div");s.style.cssText="font-size: 10px; line-height: 1.6; color: #666;",s.innerHTML=e.text,i.appendChild(a),i.appendChild(s),t.appendChild(i)}),console.log("Disclaimers added to DOM, child count:",t.children.length)):t.innerHTML='<p style="font-size: 11px; color: #666; padding: 10px;">注意事項はありません。</p>'):console.error("main-content element not found")}updateFirstChoiceRecommendation(e){if(!e)return;const t=window.dataManager.getClinicCodeById(e.id);if(!t)return;window.SITE_CONFIG&&window.SITE_CONFIG.imagesPath;["first-choice-clinic-name","first-choice-title-clinic-name"].forEach(t=>{const n=document.getElementById(t);n&&(n.textContent=e.name)});const n=document.getElementById("first-choice-banner-image");if(n){const i=window.dataManager.getClinicText(t,"詳細バナー画像パス","")||a(`/common_data/images/clinics/${t}/${t}_detail_bnr.webp`);document.querySelectorAll('img[src*="_detail_bnr"]').forEach((e,t)=>{}),n.src=a(i),n.alt=e.name}const i=document.getElementById("point1-title"),s=document.getElementById("point1-description"),o=document.getElementById("point2-title"),r=document.getElementById("point2-description"),c=document.getElementById("point3-title"),l=document.getElementById("point3-description");i&&(i.textContent=window.dataManager.getClinicText(t,"POINT1タイトル","")),s&&(s.innerHTML=window.dataManager.getClinicText(t,"POINT1内容","")),o&&(o.textContent=window.dataManager.getClinicText(t,"POINT2タイトル","")),r&&(r.innerHTML=window.dataManager.getClinicText(t,"POINT2内容","")),c&&(c.textContent=window.dataManager.getClinicText(t,"POINT3タイトル","")),l&&(l.innerHTML=window.dataManager.getClinicText(t,"POINT3内容",""));try{const e=document.querySelectorAll("#first-choice-points .ribbon_point_title2_s i.point-icon-inline"),t=["fa-lightbulb","fa-mobile-alt","fa-yen-sign"];e.forEach((e,n)=>{e.classList.remove("fa-clock","fa-lightbulb","fa-mobile-alt","fa-yen-sign","fa-user-md","fa-coins"),e.classList.add(t[n]||"fa-clock")})}catch(e){}const d=document.getElementById("first-choice-info-logo");if(d){const n=t,i=window.dataManager.getClinicText(t,"meta13","")||window.dataManager.getClinicText(t,"クリニックロゴ画像パス","")||`/common_data/images/clinics/${n}/${n}-logo.webp`;d.src=a(i),d.alt=e.name}const g=document.getElementById("first-choice-campaign-text");if(g){const e=window.dataManager.getClinicText(t,"INFORMATIONキャンペーンテキスト","");g.innerHTML=e}const m=document.getElementById("first-choice-achievement-text");if(m){const e=window.dataManager.getClinicText(t,"INFORMATIONサブテキスト","");m.textContent=e}const h=document.getElementById("first-choice-cta-text");h&&(h.textContent=`${e.name}の公式サイト`);const p=document.getElementById("first-choice-cta-link");p&&(p.href=this.urlHandler.getClinicUrlWithRegionId(e.id,e.rank||1)||"#");const u=document.querySelector("#first-choice-official-link a");if(u){u.href=this.urlHandler.getClinicUrlWithRegionId(e.id,e.rank||1)||"#";const n=u.querySelector("strong"),i=window.dataManager.getClinicText(t,"公式サイトURL","#");n?n.textContent=i:u.textContent=i}const f=document.getElementById("first-choice-disclaimer-title");f&&(f.textContent=`${e.name}の確認事項`);const y=document.getElementById("dio-campaign-first-choice-content");if(y){const e=window.dataManager.getClinicText(t,"INFORMATION確認事項","");e&&(y.innerHTML=`<div style="font-size: 9px; color: #777; line-height: 1.4;">${e}</div>`)}}getClinicDisplayName(e){return e.name}generateGeneralTab(e){const t=document.getElementById("general-tbody");t.innerHTML="",e.forEach((e,n)=>{const i=document.createElement("tr"),a=1===e.rank?"":2===e.rank?"silver":"bronze";i.innerHTML=`\n                <td>\n                    <div class="clinic-name-cell">\n                        <div class="rank-badge ${a}">${e.rank}位</div>\n                        <div class="clinic-info">\n                            <div class="clinic-main-name">${this.getClinicDisplayName(e)}</div>\n                        </div>\n                    </div>\n                </td>\n                <td>\n                    <div class="rating-cell">${getRatingFromJson(e.rank)}</div>\n                    <div class="rating-stars">\n                        ${'<i class="fas fa-star"></i>'.repeat(Math.floor(getRatingFromJson(e.rank)))}\n                        ${getRatingFromJson(e.rank)%1?'<i class="fas fa-star-half-alt"></i>':""}\n                    </div>\n                </td>\n                <td class="achievement-text">${getAchievementFromJson(e.rank)}</td>\n                <td class="benefit-text">${getBenefitFromJson(e.rank)}</td>\n                <td>\n                    <div class="cta-cell">\n                        <a href="${this.urlHandler.getClinicUrlWithRegionId(e.id,e.rank)}" class="cta-button" target="_blank" rel="noopener">公式サイト</a>\n                        <a href="#clinic${e.rank}" class="cta-link detail-scroll-link" data-rank="${e.rank}">詳細を見る</a>\n                    </div>\n                </td>\n            `,t.appendChild(i)})}generateTreatmentTab(e){const t=document.getElementById("treatment-tbody");t.innerHTML="",e.forEach((e,n)=>{const i=document.createElement("tr"),a=1===e.rank?"":2===e.rank?"silver":"bronze";i.innerHTML=`\n                <td>\n                    <div class="clinic-name-cell">\n                        <div class="rank-badge ${a}">${e.rank}位</div>\n                        <div class="clinic-info">\n                            <div class="clinic-main-name">${this.getClinicDisplayName(e)}</div>\n                        </div>\n                    </div>\n                </td>\n                <td></td>\n                <td></td>\n                <td><i class="fas fa-circle feature-icon"></i></td>\n                <td>\n                    <div class="cta-cell">\n                        <a href="${this.urlHandler.getClinicUrlWithRegionId(e.id,e.rank)}" class="cta-button" target="_blank" rel="noopener">公式サイト</a>\n                        <a href="#clinic${e.rank}" class="cta-link detail-scroll-link" data-rank="${e.rank}">詳細を見る</a>\n                    </div>\n                </td>\n            `,t.appendChild(i)})}generateServiceTab(e){const t=document.getElementById("service-tbody");t.innerHTML="",e.forEach((e,n)=>{const i=document.createElement("tr"),a=1===e.rank?"":2===e.rank?"silver":"bronze";i.innerHTML=`\n                <td>\n                    <div class="clinic-name-cell">\n                        <div class="rank-badge ${a}">${e.rank}位</div>\n                        <div class="clinic-info">\n                            <div class="clinic-main-name">${this.getClinicDisplayName(e)}</div>\n                        </div>\n                    </div>\n                </td>\n                <td><i class="fas fa-circle feature-icon"></i></td>\n                <td>${e.rank<=3?'<i class="fas fa-circle feature-icon"></i>':'<i class="fas fa-triangle feature-icon triangle"></i>'}</td>\n                <td>${e.rank<=2?'<i class="fas fa-circle feature-icon"></i>':"-"}</td>\n                <td>\n                    <div class="cta-cell">\n                        <a href="${this.urlHandler.getClinicUrlWithRegionId(e.id,e.rank)}" class="cta-button" target="_blank" rel="noopener">公式サイト</a>\n                        <a href="#clinic${e.rank}" class="cta-link detail-scroll-link" data-rank="${e.rank}">詳細を見る</a>\n                    </div>\n                </td>\n            `,t.appendChild(i)})}setupTabSwitching(){const e=document.querySelectorAll(".tab-button"),t=document.querySelectorAll(".tab-content");e.forEach(n=>{n.addEventListener("click",()=>{const i=n.getAttribute("data-tab");e.forEach(e=>e.classList.remove("active")),t.forEach(e=>e.classList.remove("active")),n.classList.add("active"),document.getElementById(`${i}-tab`).classList.add("active")})})}setupDetailScrollLinks(){setTimeout(()=>{const e=document.querySelectorAll("a");Array.from(e).filter(e=>e.textContent.includes("詳細を見る")||e.textContent.includes("詳細をみる")).forEach((e,t)=>{});document.querySelectorAll(".detail-scroll-link").forEach((e,t)=>{e.hasAttribute("data-listener-attached")||(e.setAttribute("data-listener-attached","true"),e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();let n=parseInt(e.getAttribute("data-rank"));if(!n||Number.isNaN(n)){const t=(e.getAttribute("href")||"").match(/#clinic(\d+)/);t&&(n=parseInt(t[1],10))}n&&!Number.isNaN(n)&&h(n)}))});document.querySelectorAll("#comparison-table td.ranking-table_td1 img.comparison-logo").forEach(e=>{e.hasAttribute("data-listener-attached")||(e.setAttribute("data-listener-attached","true"),e.style.cursor="pointer",e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const n=e.getAttribute("data-rank"),i=parseInt(n,10);i&&!Number.isNaN(i)&&h(i)}))});document.querySelectorAll(".detail-static-link").forEach((e,t)=>{e.addEventListener("click",t=>{t.preventDefault();let n=parseInt(e.getAttribute("data-rank"));if(!n||Number.isNaN(n)){const t=(e.getAttribute("href")||"").match(/#clinic(\d+)/);t&&(n=parseInt(t[1],10))}n&&!Number.isNaN(n)&&h(n)})});const t=document.getElementById("comparison-table");if(t){t.querySelectorAll("a").forEach((e,t)=>{e.textContent.includes("詳細")})}},500)}scrollToClinicDetail(e){e&&!Number.isNaN(e)&&h(e)}setupReviewTabs(){document.addEventListener("click",e=>{const t=e.target.closest(".review_tab2 li");if(t){const e=t.closest("#review_tab_box");if(e){const n=Array.from(t.parentElement.children).indexOf(t);e.querySelectorAll(".review_tab2 li").forEach((e,t)=>{e.classList.remove("select2"),t===n&&e.classList.add("select2")}),e.querySelectorAll(".wrap_long2").forEach((e,t)=>{e.classList.remove("active"),e.classList.add("disnon2"),t===n&&(e.classList.add("active"),e.classList.remove("disnon2"))})}}})}updateClinicDetails(e,t,n){const i=document.getElementById("clinic-details-list");if(!i)return;if(i.innerHTML="",this.updateComparisonTable(e,t),!t)return;if(!t.ranks)return;if(0===Object.keys(t.ranks).length)return;Object.entries(t.ranks).sort((e,t)=>parseInt(e[0].replace("no",""))-parseInt(t[0].replace("no",""))).slice(0,5).forEach(([t,s])=>{const o=parseInt(s),r=e.find(e=>e.id==s||e.id===o);if(!r)return;const c=parseInt(t.replace("no","")),l=Number(r.rank)||c,d=this.urlHandler.getClinicUrlWithRegionId(r.id,l),g=this.urlHandler.getDirectFormUrl(r.id,l),m=document.createElement("div");m.className=`detail-item ranking_box_inner ranking_box_${c}`,m.setAttribute("data-rank",c),m.setAttribute("data-clinic-id",s),m.id=`clinic${c}`;let h="";2===c?h="silver":3===c?h="bronze":4===c?h="ranking4":5===c&&(h="ranking5");const p=this.dataManager.getClinicCodeById(s),u=this.dataManager.getClinicDetailData(s);if(!u)return;if(u.regionId=n,!u.banner){const e=this.dataManager.getClinicCodeById(s),t="kireiline"===e?"kireiline":e;u.banner=a(`/common_data/images/clinics/${t}/${t}_detail_bnr.webp`)}const f=this.dataManager.getStoresByRegionId(n),y=r.name;u.stores=f.filter(e=>e.clinicName===y);const b=a(`/common_data/images/rank_icon/rank${c}.webp`),v=this.dataManager.getRegionName(n)||"",w=this.isNationalRegion(n,{id:n,name:v})||!v?`${r.name}の店舗`:`${r.name}の【${v}】の店舗`,x=p?this.dataManager.getClinicText(p,"INFORMATIONサブテキスト",""):"",C=x?this.dataManager.processDecoTags(x):"",k=C?`<div style="font-size: 12px;">${C}</div>`:"",T='<span class="cta-subtext" style="display:block;font-size: 11px;color: #ff95ad;font-weight: 400;"><span>いつでも変更/キャンセルは可能です</span></span>',I=`<p class="btn btn_outline_pink">\n                        <a class="ctaBtn-direct" href="${g}" target="_blank" rel="noopener noreferrer">\n                            <span class="bt_s">無料相談の空き状況をチェック</span>${T}\n                        </a>\n                    </p>`;if(m.innerHTML=`\n                <div class="ranking_box_in">\n                    <div class="detail-rank">\n                        <div class="detail-rank-header">\n                            <div class="detail-rank-badge has-icon ${h}"><img class="rank-badge-icon" src="${b}" alt="${c}位"></div>\n                            <div class="detail-title">\n                                <h3>${this.dataManager.processDecoTags(u.title)}</h3>\n                                <p>${this.dataManager.processDecoTags(u.subtitle)}</p>\n                            </div>\n                        </div>\n                        <div class="ranking__name">\n                            <a href="${d}" target="_blank" rel="noopener nofollow">${"Oh my teeth"===r.name?"Oh my teeth（オーマイティース）":r.name} ＞</a>\n                        </div>\n                    </div>\n                ${(()=>{const e="kireiline"===p?"kireiline":p,t=[],n=this.dataManager.getClinicText(p,"詳細バナー画像パス","");if(n){const e=a(n);t.push(e)}for(let n=2;n<=10;n++){const i=`/common_data/images/clinics/${e}/${e}_detail_bnr${n}.webp`;t.push(a(i))}const i=Array.from(new Set(t));return i.length?`\n                    <div class="detail-banner banner-slider" data-clinic-id="${s}">\n                        <div class="slider-container">\n                            <div class="slider-counter">1/${i.length}</div>\n                            <button class="slider-nav slider-prev" data-clinic-id="${s}">\n                                <span>‹</span>\n                            </button>\n                            <div class="slider-wrapper">\n                                <div class="slider-track" data-clinic-id="${s}">\n                                    ${i.map((e,t)=>`\n                                        <div class="slider-slide ${0===t?"active":""}" data-index="${t}">\n                                            <img src="${e}" alt="${r.name}キャンペーン${t+1}">\n                                        </div>\n                                    `).join("")}\n                                </div>\n                            </div>\n                            <button class="slider-nav slider-next" data-clinic-id="${s}">\n                                <span>›</span>\n                            </button>\n                            <button class="slider-expand" data-clinic-id="${s}">\n                                <i class="fas fa-magnifying-glass" aria-hidden="true"></i>\n                                <span>画像を拡大</span>\n                            </button>\n                        </div>\n                        <div class="slider-dots">\n                            ${i.map((e,t)=>`\n                                <button class="slider-dot ${0===t?"active":""}" data-index="${t}" data-clinic-id="${s}"></button>\n                            `).join("")}\n                        </div>\n                    </div>\n                    `:""})()}\n                <div class="detail-features">\n                    ${u.features.map(e=>`<span class="feature-tag">${this.dataManager.processDecoTags(e.startsWith("#")?e:"# "+e)}</span>`).join("")}\n                </div>\n                \n                \x3c!-- 拡張版価格表 --\x3e\n                <table class="info-table">\n                    ${Object.entries(u.priceDetail).map(([e,t])=>`\n                        <tr>\n                            <td>${e}</td>\n                            <td>${this.dataManager.processDecoTags(t)}</td>\n                        </tr>\n                    `).join("")}\n                </table>\n                \n                \x3c!-- CTAボタン --\x3e\n                <div class="clinic-cta-button-wrapper">\n                    ${k}\n                    <p class="btn btn_second_primary">\n                        <a href="${d}" target="_blank" rel="noopener noreferrer">\n                            <span class="bt_s">公式サイトで詳細を見る</span>\n                            <span class="btn-arrow">▶</span>\n                        </a>\n                    </p>\n                    ${I}\n                </div>\n\n                ${(()=>{const e=this.dataManager.getClinicCodeById(s),t=e?e.toString().trim().toLowerCase().replace(/[^a-z0-9_-]/g,""):"";if(!t)return"";const n=`${window.SITE_CONFIG&&window.SITE_CONFIG.imagesPath?window.SITE_CONFIG.imagesPath:"./images"}/${t}_treatment.mp4`;return`\n                <div class="clinic-procedure-section" data-procedure-section style="display:none;">\n                    <h4 class="section-title">施術風景</h4>\n                    <div class="procedure-video-wrapper">\n                        ${`<div class="procedure-video-embed" data-clinic-code="${t}" data-video-src="${n}">\n                            <video class="procedure-video" controls playsinline preload="auto" tabindex="0" aria-label="${r.name}の施術風景">\n                                <source src="${n}" type="video/mp4">\n                                お使いのブラウザでは動画を再生できません。\n                            </video>\n                            <button type="button" class="procedure-video-toggle" aria-label="再生">\n                                <span class="procedure-video-toggle-icon"></span>\n                            </button>\n                        </div>`}\n                    </div>\n                </div>\n                    `})()}\n\n                \x3c!-- クリニックのポイント --\x3e\n                <div class="clinic-points-section">\n                    <h4 class="section-title">POINT</h4>\n                    <div class="ribbon_point_box_no">\n                        ${u.points.map((e,t)=>{let n="fa-clock";return"lightbulb"===e.icon?n="fa-lightbulb":"phone"===e.icon?n="fa-mobile-alt":"coins"===e.icon&&(n="fa-yen-sign"),`\n                            <div class="ribbon_point_title2_s">\n                                <i class="fas ${n} point-icon-inline"></i>\n                                <strong>${this.dataManager.processDecoTags(e.title)}</strong>\n                            </div>\n                            <div class="ribbon_point_txt">\n                                <p style="font-size:14px;">${this.dataManager.processDecoTags(e.description)}</p>\n                            </div>\n                            `}).join("")}\n                        <div class="ribbon_point_link">\n                            【公式】<a href="${d}" target="_blank" rel="noopener"><strong>${u.priceDetail["公式サイト"]||"#"}</strong></a>\n                        </div>\n                    </div>\n                </div>\n                \n                ${(()=>{if(1!==c)return"";const e=this.dataManager.getClinicCodeById(s)||"";if(!e)return"";const t=this.dataManager,n=[{fallbacks:[`images/${e}_case01.jpg`],alt:"CASE 01"},{fallbacks:[`images/${e}_case02.jpg`],alt:"CASE 02"},{fallbacks:[`images/${e}_case03.jpg`],alt:"CASE 03"}];if(!n.length)return"";const i=(e,t)=>`<tr><td style="padding: 0 8px !important; background-color: #f8f8f8 !important; font-weight: bold !important; width: 30% !important;">${e}</td><td style="padding: 0 8px !important;">${t}</td></tr>`;return`\n                    <div class="clinic-points-section">\n                        <h4 class="section-title">症例写真</h4>\n                        <div class="case-slider" style="position: relative; overflow: hidden;">\n                            <div class="case-track" style="display:flex;">\n                                ${n.map((n,a)=>{const s=`case${a+1}`,o=t.getClinicText(e,`${s}コース名`,"")||"—",r=t.getClinicText(e,`${s}施術の説明`,"")||"—",c=t.getClinicText(e,`${s}副作用（リスク）`,"")||"—";return`\n                            <div class="case-slide" style="min-width:100%;box-sizing:border-box;">\n                                <img src="${n.fallbacks[0]}" alt="${n.alt}" loading="lazy" style="width:100%;height:auto;object-fit:contain;">\n                                <div class="case-info" style="margin-top: 5px; padding: 0 5%; text-align: left; font-size: 12px; line-height: 1.6; width: 100%;">\n                                    <table class="case-table" style="width: 100% !important; border-collapse: collapse !important; font-size: 8px !important; line-height: 1.6 !important; display: table !important; table-layout: fixed !important;">\n                                        <tbody>\n                                            ${i("コース名",t.processDecoTags(o))}\n                                            ${i("施術の説明",t.processDecoTags(r))}\n                                            ${i("副作用<br>（リスク）",t.processDecoTags(c))}\n                                            ${i("","3ヶ月医療痩身ボディメイクを契約された<br>モニター対象の会員の代表的な事例を提示しています。効果には個人差があります。")}\n                                        </tbody>\n                                    </table>\n                                </div>\n                            </div>\n                        `}).join("")}\n                            </div>\n                            <button class="case-nav case-nav-prev" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.8);border:none;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;z-index:10;">‹</button>\n                            <button class="case-nav case-nav-next" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.8);border:none;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;z-index:10;">›</button>\n                        </div>\n                        <div class="case-dots" style="text-align:center;margin-top:10px;">\n                            ${n.map((e,t)=>`<button type="button" class="case-dot ${0===t?"active":""}" data-index="${t}" style="width:8px;height:8px;border-radius:50%;border:none;background:${0===t?"#2CC7C5":"#ccc"};margin:0 4px;cursor:pointer;"></button>`).join("")}\n                        </div>\n                    </div>\n                    `})()}\n                \n                \n                \x3c!-- 口コミ --\x3e\n                <div class="reviews-section">\n                    <h4 class="section-title-review">REVIEW</h4>\n                    \n                    <section id="review_tab_box">\n                        <nav role="navigation" class="review_tab2">\n                            <ul>\n                                ${(()=>{const e=this.dataManager.getClinicCodeById(s),t=this.dataManager.getReviewTabLabels(e)||[],n=["fa-yen-sign","fa-user-md","fa-heart"];return 0===t.length?"":t.map((e,t)=>`<li class="${0===t?"select2":""}" data-tab="tab-${t}"><i class="fas ${n[t]||"fa-comment-dots"}"></i> ${e}</li>`).join("")})()}\n                            </ul>\n                        </nav>\n                        ${(()=>{const e=this.dataManager.getClinicCodeById(s),t=this.dataManager.getReviewTabLabels(e)||[],n=[1,2,3,4,5,6,7,8,9].map(e=>a(`/common_data/images/review_icon/review_icon${e}.webp`)),i=Array.from({length:n.length},(e,t)=>(t+((c||1)-1))%n.length),o={1:[0,1,2,3,4,5,6,7,8],2:[2,7,0,5,6,1,8,3,4],3:[0,5,8,1,2,3,4,7,6],4:[6,3,4,7,8,1,0,5,2],5:[4,1,6,5,0,3,2,7,8]}[c]||i;let r="";const l=this.dataManager;return t.forEach((t,i)=>{r+=`<div class="wrap_long2 ${0===i?"active":"disnon2"}">`;const a=l.getClinicReviewsByLabel(e,t);a.forEach((e,t)=>{const a=(3*i+t)%o.length,s=o[a];r+=`\n                                        <div class="review_tab_box_in">\n                                            <div class="review_tab_box_img">\n                                                <img src="${n[s]}" alt="レビューアイコン">\n                                                <span>★★★★★</span>\n                                            </div>\n                                            <div class="review_tab_box_r">\n                                                <div class="review_tab_box_title"><strong>${e.title}</strong></div>\n                                                <div class="review_tab_box_txt">\n                                                    ${e.content}\n                                                </div>\n                                            </div>\n                                        </div>\n                                    `}),0===a.length&&(r+='<div class="review_tab_box_in"><div class="review_tab_box_r"><div class="review_tab_box_txt">準備中</div></div></div>'),r+='<p style="font-size:8px;text-align:right">※効果には個人差があります<br>※個人の感想です</p>',r+="</div>"}),r})()}\n                    </section>\n                </div>\n                \n                \x3c!-- 店舗情報 --\x3e\n                <div class="brand-section">\n                    <h4 class="section-heading">\n                        ${w}\n                    </h4>\n                    ${this.dataManager.generateStoresDisplay(s,n)}\n                </div>\n                \n                \x3c!-- キャンペーンセクション --\x3e\n                <div class="campaign-section">\n                    <div class="campaign-container">\n                        ${(()=>{const e=this.dataManager.getClinicCodeById(s),t=this.dataManager.getClinicText(e,"キャンペーンヘッダー","INFORMATION!"),n=this.dataManager.getClinicText(e,"INFORMATIONキャンペーンテキスト",""),i=this.dataManager.getClinicText(e,"INFORMATIONサブテキスト",""),o=this.dataManager.getClinicText(e,"CTAボタンテキスト","キャンペーンの詳細を見る"),c="kireiline"===e?"kireiline":e;return`\n                            <div class="campaign-header">${t}</div>\n                            <div class="campaign-content">\n                                <div class="camp_header3">\n                                    <div class="info_logo">\n                                        <img src="${a(`/common_data/images/clinics/${c}/${c}-logo.webp`)}" alt="${r.name}" onerror="this.onerror=null; this.src='${a(`/common_data/images/clinics/${c}/${c}-logo.jpg`)}';">\n                                    </div>\n                                    <div class="camp_txt">\n                                        ${n}\n                                    </div>\n                                </div>\n                                \n                                <div class="cv_box_img">\n                                    ${i}\n                                    <p class="btn btn_second_primary" style="margin-top: 10px;">\n                                        <a href="${d}" target="_blank" rel="noopener">\n                                            <span class="bt_s">${o}</span>\n                                            <span class="btn-arrow">▶</span>\n                                        </a>\n                                    </p>\n                                    <p class="btn btn_outline_pink">\n                                        <a class="ctaBtn-direct" href="${g}" target="_blank" rel="noopener noreferrer">\n                                            <span class="bt_s">無料相談の空き状況をチェック</span>${T}\n                                        </a>\n                                    </p>\n                                </div>\n                            </div>\n                            `})()}\n                    </div>\n            ${(()=>{const e=this.dataManager.getClinicCodeById(r.id),t=e?this.dataManager.getClinicText(e,"INFORMATION確認事項",""):"";return t&&""!==t.trim()?`\n                    \x3c!-- ${r.name}の確認事項アコーディオン --\x3e\n                    <div class="disclaimer-accordion" style="margin-top: 15px;">\n                        <button class="disclaimer-header" onclick="toggleDisclaimer('${r.code}-campaign')" style="width: 100%; text-align: left; padding: 8px 12px; background-color: #fafafa; border: 1px solid #f0f0f0; border-radius: 3px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">\n                            <span style="font-size: 10px; font-weight: 500; color: #666;">${r.name}の確認事項</span>\n                            <span id="${r.code}-campaign-arrow" style="font-size: 8px; color: #999; transition: transform 0.2s;">▼</span>\n                        </button>\n                        <div id="${r.code}-campaign-content" class="disclaimer-content" style="display: none; padding: 8px 12px; background-color: #fcfcfc; border: 1px solid #f0f0f0; border-top: none; border-radius: 0 0 3px 3px; margin-top: -1px;">\n                            <div style="font-size: 9px; color: #777; line-height: 1.4;">\n                                ${t.split("<br>").map(e=>e.trim()).filter(e=>e).map(e=>`<p>${e}</p>`).join("\n                                ")}\n                            </div>\n                        </div>\n                    </div>\n                    `:""})()}\n                </div>\n            </div>\n            `,i.appendChild(m),this.initializeProcedureVideos(m),1===c)try{const e=m,t=e.querySelector(".case-track");let n=Array.from(e.querySelectorAll(".case-slide"));const i=e.querySelector(".case-dots");let a=Array.from(e.querySelectorAll(".case-dot"));const s=e.querySelector(".case-nav-prev"),o=e.querySelector(".case-nav-next"),r=e.querySelector(".case-slider")?.closest(".clinic-points-section"),c=Array.from(e.querySelectorAll(".case-slider img"));if(!c||0===c.length)return void(r&&(r.style.display="none"));let l=0;const d=()=>{n=Array.from(e.querySelectorAll(".case-slide")),a=Array.from(e.querySelectorAll(".case-dot")),a.forEach((e,t)=>e.setAttribute("data-index",String(t)))},g=()=>{const e=n.length>1;s&&(s.style.display=e?"":"none"),o&&(o.style.display=e?"":"none"),i&&(i.style.display=e?"block":"none")},h=e=>{n.length&&t&&(e<0&&(e=n.length-1),e>=n.length&&(e=0),l=e,t.style.display="flex",t.style.transform=`translateX(-${100*l}%)`,t.style.transition="transform .3s ease",n.forEach(e=>{e.style.minWidth="100%",e.style.boxSizing="border-box"}),a.forEach((e,t)=>{e.classList.toggle("active",t===l),e.style.background=t===l?"#2CC7C5":"#ccc"}))};c.forEach(e=>{e.addEventListener("error",()=>{const t=e.closest(".case-slide");if(!t)return;const i=n.indexOf(t);if(i>=0){const e=a[i];if(e&&e.parentNode&&e.parentNode.removeChild(e),t&&t.parentNode&&t.parentNode.removeChild(t),d(),0===n.length)return void(r&&(r.style.display="none"));l>=n.length&&(l=n.length-1),g(),h(l)}},{once:!0})}),t&&n.length&&(s&&s.addEventListener("click",()=>h(l-1)),o&&o.addEventListener("click",()=>h(l+1)),a.forEach((e,t)=>e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),h(t)})),i&&i.addEventListener("click",e=>{const t=e.target&&1===e.target.nodeType?e.target:e.target&&e.target.parentElement;if(!t)return;const n=t.closest&&t.closest(".case-dot");if(!n)return;e.preventDefault(),e.stopPropagation();const a=n.getAttribute("data-index"),s=a?parseInt(a,10):Array.from(i.querySelectorAll(".case-dot")).indexOf(n);s>=0&&h(s)},{capture:!0}),g(),h(0))}catch(e){}})}initializeProcedureVideos(e=document){(e instanceof HTMLElement?e:document).querySelectorAll(".procedure-video-embed").forEach(e=>{if(!e||"1"===e.dataset.videoInitialized)return;const t=e.querySelector(".procedure-video"),n=e.querySelector(".procedure-video-toggle");if(!t||!n)return;e.dataset.videoInitialized="1";const i=e.closest("[data-procedure-section]")||e.closest(".clinic-procedure-section"),a=t.querySelector("source"),s=e.dataset.videoSrc||(a?a.getAttribute("src"):t.currentSrc),o=window.__treatmentVideoCache=window.__treatmentVideoCache||{},r=()=>{i&&!i.dataset.shown&&(i.style.removeProperty("display"),delete i.dataset.procedurePending,i.dataset.shown="1")},c=()=>{i&&!i.dataset.removed&&(i.dataset.removed="1",i.remove())};if(!s)return void c();if(!1===o[s])return void c();!0===o[s]&&r();const l=()=>{const i=!t.paused&&!t.ended;e.classList.toggle("is-playing",i),n.setAttribute("aria-label",i?"一時停止":"再生")},d=()=>{t.paused||t.ended?(()=>{const e=t.play();e&&"function"==typeof e.then&&e.catch(()=>{})})():t.pause()},g=e=>{e.preventDefault(),e.stopPropagation(),d()},m=()=>{o[s]=!0,r()},h=()=>{o[s]=!1,c()};n.addEventListener("click",g),t.addEventListener("click",g),t.addEventListener("play",()=>{r(),l()}),t.addEventListener("pause",l),t.addEventListener("ended",l),t.addEventListener("error",h,{once:!0});const p=()=>{m(),l()};if(t.addEventListener("loadeddata",p,{once:!0}),t.addEventListener("loadedmetadata",p,{once:!0}),t.addEventListener("keydown",e=>{" "!==e.key&&"Enter"!==e.key||(e.preventDefault(),d())}),t.error)h();else{if(t.readyState>=HTMLMediaElement.HAVE_METADATA)m();else try{t.load()}catch(e){}l()}})}getStoreImage(e,t){const n=String(t).padStart(3,"0");return`${window.SITE_CONFIG?window.SITE_CONFIG.imagesPath+"/images":"/images"}/clinics/${e}/${e}_clinic/clinic_image_${n}.webp`}handleImageError(e,t,n){const i=String(n).padStart(3,"0"),s=window.SITE_CONFIG?window.SITE_CONFIG.imagesPath+"/images":"/images",o=["jpg","png"],r=e.src;let c=-1;r.includes(".webp")?c=-1:r.includes(".jpg")?c=0:r.includes(".png")&&(c=1);const l=c+1;if(l<o.length)e.src=`${s}/clinics/${t}/${t}_clinic/clinic_image_${i}.${o[l]}`;else{const n=a(`/common_data/images/clinics/${t}/${t}-logo.webp`),i=a(`/common_data/images/clinics/${t}/${t}-logo.jpg`);e.src=n,e.onerror=()=>{e.src=i}}}getRegionName(e){if(!window.dataManager)return"";const t=window.dataManager.getRegionById(e);return t?t.name:""}generateMapIframe(e){if(!e)return"<p>住所情報がありません</p>";return`\n            <iframe \n                src="${`https://maps.google.com/maps?q=${encodeURIComponent(e)}&output=embed&z=16`}"\n                width="100%" \n                height="300" \n                style="border:0;" \n                allowfullscreen="" \n                loading="lazy" \n                referrerpolicy="no-referrer-when-downgrade"\n                title="Google Maps">\n            </iframe>\n        `}setupMapAccordions(){const e=document.getElementById("map-modal"),t=document.getElementById("map-modal-close"),n=document.querySelector(".map-modal-overlay"),i=this;this.mapButtonClickHandler&&document.removeEventListener("click",this.mapButtonClickHandler,!0),this.mapButtonClickHandler=e=>{if(e.target.closest(".map-toggle-btn")){e.preventDefault();const t=e.target.closest(".map-toggle-btn").closest(".shop");let n="クリニック";try{const e=t?.closest(".shops"),a=e?.closest(".detail-item"),s=a?.getAttribute("data-clinic-id");if(s&&i.dataManager){const e=i.dataManager.clinics?.find(e=>e.id==s);e&&(n=e.name)}}catch(e){console.warn("Failed to resolve context clinic:",e)}if(t){const e=t.querySelector(".shop-name a"),a=e?.textContent?.trim()||"店舗",s=t.querySelector(".shop-address"),o=s?.textContent?.trim()||"住所情報なし";let r="駅から徒歩圏内";if(i.dataManager){const e=i.dataManager.stores.find(e=>e.storeName===a&&e.address===o);if(e)e.access&&(r=e.access),"クリニック"===n&&e.clinicName&&(n=e.clinicName);else{const e=t.querySelector(".shop-info");if(e){const t=e.textContent.split("\n").map(e=>e.trim()).filter(e=>e).find(e=>e.includes("駅")&&(e.includes("徒歩")||e.includes("分")));t&&(r=t)}}}if("クリニック"===n){const e=t.closest(".shops"),a=e?.closest(".detail-item");if("クリニック"===n){const e=clinicDetailElement?.querySelector("h3");if(e){const t=e.childNodes[0]?.textContent?.trim()||e.textContent?.trim();if(t&&""!==t&&i.dataManager&&i.dataManager.clinics){const e=i.dataManager.clinics.find(e=>t.includes(e.name)||e.name.includes(t));e&&(n=e.name)}if("クリニック"===n){const e=a?.querySelectorAll(".detail_btn_2, .link_btn");if(e.length>0){const t=e[0].getAttribute("href"),a=t?.match(/clinic_id=(\d+)/);if(a){const e=a[1],t=i.dataManager?.clinics?.find(t=>t.id==e);t&&(n=t.name)}}}}}}try{let e=a;a.startsWith("クリニック")?e=n+a.replace("クリニック","").trim():a.includes(n)||(e=n+a),i.showMapModal(e,o,r,n)}catch(e){}}else try{i.showMapModal("テストクリニック","テスト住所","テストアクセス","test")}catch(e){}}},document.addEventListener("click",this.mapButtonClickHandler,!0),t&&t.addEventListener("click",()=>{i.hideMapModal()}),n&&n.addEventListener("click",()=>{i.hideMapModal()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&"none"!==e?.style.display&&i.hideMapModal()})}showMapModal(e,t,n,a){const s=document.getElementById("map-modal"),o=document.getElementById("map-modal-clinic-name"),r=document.getElementById("map-modal-address"),c=document.getElementById("map-modal-access"),l=(document.getElementById("map-modal-hours"),document.getElementById("map-modal-map-container")),d=document.getElementById("map-modal-button");if(s&&o&&r&&c&&l){try{s.parentNode!==document.body&&document.body.appendChild(s)}catch(e){}if(s.style.display="flex",document.body.style.overflow="hidden",o.textContent=e,r.textContent=t,c.textContent=n,l.innerHTML=this.generateMapIframe(t),d)try{let t="";const n=(this.dataManager.clinics||[]).find(t=>t.name===a||e.includes(t.name)||t.name===e);n&&(t=n.code);let s="#";try{window.urlHandler&&(s=window.urlHandler.getClinicUrlByNameWithRegionId(t))}catch(e){}if(!s||"#"===s){const e=i.determineRegionId({fallback:"000"});n&&(s=`${i.buildRedirectPath()}?clinic_id=${n.id}&rank=1&region_id=${e}`)}s&&"#"!==s&&""!==s?(d.href=s,d.target="_blank",d.rel="noopener",d.onclick=null):(d.href="#",d.onclick=e=>{e.preventDefault(),this.hideMapModal();const t=document.querySelector(`[data-clinic-id="${n?.id||"1"}"]`);t&&t.scrollIntoView({behavior:"smooth",block:"center"})});const o=document.getElementById("map-modal-button-text");if(o){const e=n&&n.name||"string"==typeof a&&a||"クリニック";o.textContent=e+"の公式サイト"}}catch(e){d.href="#",d.onclick=e=>{e.preventDefault(),this.hideMapModal()}}}}hideMapModal(){const e=document.getElementById("map-modal");e&&(e.style.display="none",document.body.style.overflow="")}}function l(){const e=document.getElementById("main-content"),t=document.getElementById("ranking-disclaimers-content");if(!window.dataManager)return;if(!e&&!t)return;let n=window.app?.currentRegionId;n||(n=i.determineRegionId()),n||(n="13"),n=String(parseInt(n,10));let a=null;if("function"==typeof window.dataManager.getRankingByRegionId)a=window.dataManager.getRankingByRegionId(n);else if("function"==typeof window.dataManager.getRankingsByRegion){const e=window.dataManager.getRankingsByRegion(n)||[];if(Array.isArray(e)&&e.length>0){const t={};e.forEach((e,n)=>{e&&"-"!==e&&""!==e&&(t[`no${n+1}`]=e)}),a={regionId:String(n).padStart(3,"0"),ranks:t}}}if(!a||!a.ranks||0===Object.keys(a.ranks).length)return e&&(e.innerHTML=""),void(t&&(t.innerHTML=""));const s=[],o=document.getElementById("comparison-tbody");o&&o.children.length>0&&Array.from(o.children).forEach((e,t)=>{const n=e.querySelectorAll("td");if(n.length>0){const e=n[0];if(e){const n=e.textContent.trim(),i=e.querySelector("a");if(n&&""!==n){let e=null;if(i){const t=i.getAttribute("onclick")?.match(/clinic_id:\s*'([^']+)'/);t&&(e=t[1])}if(e){const i=window.dataManager.getClinicCodeById(e);i&&s.push({rank:t+1,id:e,code:i,name:n})}}}}});const r=s.length>0?s:[];if(0===r.length&&a&&a.ranks)for(let e=1;e<=5;e++){const t=a.ranks[`no${e}`];if(t&&"-"!==t&&""!==t){const n=window.dataManager.getClinicById(t);if(n){const i=window.dataManager.getClinicCodeById(t);i&&r.push({rank:e,id:t,code:i,name:n.name})}}}if(r.sort((e,t)=>e.name.localeCompare(t.name)),r.forEach((e,t)=>{}),0===r.length)return e&&(e.innerHTML=""),void(t&&(t.innerHTML=""));const c=(e,t)=>{let n="",i=0;return e.forEach(e=>{const a=window.dataManager.getClinicText(e.code,"比較表の注意事項","");if(a&&""!==a.trim()){i++;const s=e.code.toLowerCase().replace(/\s+/g,""),o=`${t}-${s}`;n+=`\n                    <div class="disclaimer-item">\n                        <button class="disclaimer-header" onclick="return toggleClinicDisclaimer('${o}', event)" style="width: 100%; text-align: left; padding: 6px 10px; background-color: #f8f8f8; border: 1px solid #eeeeee; border-radius: 2px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">\n                            <span style="font-size: 9px; font-weight: 400; color: #777;">${e.name}</span>\n                            <span id="${o}-arrow" style="font-size: 7px; color: #aaa; transition: transform 0.2s;">▼</span>\n                        </button>\n                        <div id="${o}-content" class="disclaimer-content" style="display: none; padding: 6px 10px; background-color: #fefefe; border: 1px solid #eeeeee; border-top: none; border-radius: 0 0 2px 2px; margin-top: -2px;">\n                            <div style="font-size: 9px; color: #777; line-height: 1.4;">\n                                ${a.split("\n").map(e=>e.trim()).filter(e=>e).map(e=>`<p>${e}</p>`).join("\n                            ")}\n                            </div>\n                        </div>\n                    </div>\n                `}}),{html:n,count:i}},l=c(r,"rank");t&&(l.count>0?t.innerHTML=l.html:t.innerHTML='<p style="font-size: 11px; color: #666; padding: 10px;">注意事項はありません。</p>');const d=c(r,"comp");e&&(d.count>0?e.innerHTML=d.html:e.innerHTML='<p style="font-size: 11px; color: #666; padding: 10px;">注意事項はありません。</p>')}function d(e="direct-call"){console.info("[app.js] bootstrapRankingApp",{trigger:e,readyState:document.readyState});const t=new c;window.app=t,console.info("[app.js] RankingApp instance created"),t.init(),console.info("[app.js] RankingApp.init() called"),setTimeout(()=>{l()},100),setTimeout(()=>{try{g()}catch(e){console.warn("[app.js] initializeBannerSliders failed",e)}},200),window.testInitializeDisclaimers=l,window.openClinicDetailModal=h,window.closeClinicDetailModal=p,window.toggleClinicDisclaimer=function(e,t){t&&(t.preventDefault?.(),t.stopPropagation?.());const n=document.querySelector(".clinic-detail-modal"),i=t&&t.target&&t.target.closest(".clinic-detail-modal")||n||document,a=i.querySelector(`#${e}-content`)||document.querySelector(`#${e}-content`),s=i.querySelector(`#${e}-arrow`)||document.querySelector(`#${e}-arrow`);if(a){const e="none"===getComputedStyle(a).display||"none"===a.style.display;a.style.display=e?"block":"none",s&&(s.style.transform=e?"rotate(180deg)":"rotate(0deg)")}return!1},window.toggleDisclaimer=function(e){const t=document.querySelector(".clinic-detail-modal")||document,n=t.querySelector(`#${e}-content`)||document.querySelector(`#${e}-content`),i=t.querySelector(`#${e}-arrow`)||document.querySelector(`#${e}-arrow`);if(n){const e="none"===getComputedStyle(n).display||"none"===n.style.display;n.style.display=e?"block":"none",i&&(i.style.transform=e?"rotate(180deg)":"rotate(0deg)")}return!1},setTimeout(()=>{document.querySelectorAll('a[href*="#clinic"]').forEach(e=>{e.addEventListener("click",t=>{const n=(e.getAttribute("href")||"").match(/#clinic(\d+)/);if(n){t.preventDefault();const e=parseInt(n[1],10);e&&!Number.isNaN(e)&&h(e)}})}),document.addEventListener("click",e=>{const t=e.target.closest('a[href*="#clinic"]');if(!t)return;const n=(t.getAttribute("href")||"").match(/#clinic(\d+)/);if(!n)return;e.preventDefault();const i=parseInt(n[1],10);i&&!Number.isNaN(i)&&h(i)},!0)},500),document.querySelectorAll(".footer-page-link").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=new URLSearchParams(window.location.search);if(t.toString()){const e=new URL(this.href,window.location.origin);for(const[n,i]of t)e.searchParams.set(n,i);window.location.href=e.toString()}else window.location.href=this.href})})}function g(){document.querySelectorAll(".banner-slider").forEach(e=>{if("1"===e.dataset.initialized)return;e.dataset.initialized="1";let t=Array.from(e.querySelectorAll(".slider-slide")),n=Array.from(e.querySelectorAll(".slider-dot"));const i=e.querySelector(".slider-dots"),a=e.querySelector(".slider-prev"),s=e.querySelector(".slider-next"),o=e.querySelector(".slider-counter"),r=e.querySelector(".slider-expand");if(!t||0===t.length)return;let c=0,l=t.length;const d=()=>Array.from(e.querySelectorAll(".slider-slide")).map(e=>{const t=e.querySelector("img");return t?t.src:""});let g=d();const h=()=>{const e=t.findIndex(e=>e.classList.contains("active"));return e>=0?e:0};function p(e){t.forEach(e=>e.classList.remove("active")),n.forEach(e=>e.classList.remove("active")),t[e]?.classList.add("active"),n[e]&&n[e].classList.add("active"),o&&(o.textContent=`${e+1}/${l}`),c=e}function u(){const e=l>1;a&&(a.style.display=e?"":"none"),s&&(s.style.display=e?"":"none"),i&&(i.style.display=e?"":"none")}function f(i){const a=t[i],s=n[i];a&&a.remove(),s&&s.remove(),t=Array.from(e.querySelectorAll(".slider-slide")),n=Array.from(e.querySelectorAll(".slider-dot")),t.forEach((e,t)=>e.setAttribute("data-index",String(t))),n.forEach((e,t)=>e.setAttribute("data-index",String(t))),l=t.length,g=d(),u(),0!==l&&(c>=l&&(c=l-1),p(c))}c=h(),t.forEach(e=>{const t=e.querySelector("img"),n=()=>m(g,h());t?(t.style.cursor="zoom-in",t.addEventListener("click",n)):e.addEventListener("click",n)}),t.forEach(e=>{const n=e.querySelector("img");n&&n.addEventListener("error",()=>{const n=e.getAttribute("data-index"),i=n?parseInt(n,10):t.indexOf(e);i>=0&&f(i)},{once:!0})}),a&&a.addEventListener("click",()=>{p(0===c?l-1:c-1)}),s&&s.addEventListener("click",()=>{p(c===l-1?0:c+1)}),n.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-index"),i=t?parseInt(t,10):n.indexOf(e);p(Math.max(0,i))})}),r&&r.addEventListener("click",()=>{m(g,h())}),p(h()),u()})}function m(e,t){const n=document.querySelector(".banner-modal");n&&n.remove();const i=`\n        <div class="banner-modal active">\n            <button class="banner-modal-close">&times;</button>\n            <button class="banner-modal-nav banner-modal-prev">‹</button>\n            <div class="banner-modal-content">\n                <img class="banner-modal-image" src="${e[t]}" alt="拡大画像">\n                <div class="banner-modal-counter">${t+1}/${e.length}</div>\n            </div>\n            <button class="banner-modal-nav banner-modal-next">›</button>\n            <div class="banner-modal-dots">\n                ${e.map((e,n)=>`\n                    <button class="banner-modal-dot ${n===t?"active":""}" data-index="${n}" aria-label="${n+1}"></button>\n                `).join("")}\n            </div>\n        </div>`;document.body.insertAdjacentHTML("beforeend",i);const a=document.querySelector(".banner-modal"),s=a.querySelector(".banner-modal-image"),o=a.querySelector(".banner-modal-counter"),r=a.querySelector(".banner-modal-close"),c=a.querySelector(".banner-modal-prev"),l=a.querySelector(".banner-modal-next"),d=a.querySelectorAll(".banner-modal-dot"),g=a.querySelector(".banner-modal-dots");let m=t;function h(t){s.src=e[t],o.textContent=`${t+1}/${e.length}`,m=t,d&&d.length&&d.forEach((e,n)=>{n===t?e.classList.add("active"):e.classList.remove("active")})}r.addEventListener("click",()=>{a.remove()}),a.addEventListener("click",e=>{e.target===a&&a.remove()}),c.addEventListener("click",()=>{h(0===m?e.length-1:m-1)}),l.addEventListener("click",()=>{h(m===e.length-1?0:m+1)}),d&&d.length&&d.forEach(e=>{e.addEventListener("click",()=>{h(parseInt(e.getAttribute("data-index"),10)||0)})}),e.length<=1&&(c&&(c.style.display="none"),l&&(l.style.display="none"),g&&(g.style.display="none"));const p=t=>{if("Escape"===t.key)return a.remove(),void document.removeEventListener("keydown",p);if("ArrowLeft"===t.key){return void h(0===m?e.length-1:m-1)}if("ArrowRight"===t.key){return void h(m===e.length-1?0:m+1)}};document.addEventListener("keydown",p)}function h(e){p();const t=document.getElementById(`clinic${e}`);if(!t)return;const n=(t.querySelector(".ranking_box_in")||t).outerHTML;let i="クリニック";try{const e=t.getAttribute("data-clinic-id");if(e&&window.dataManager&&Array.isArray(window.dataManager.clinics)){const t=window.dataManager.clinics.find(t=>String(t.id)===String(e));t&&t.name&&(i=t.name)}if("クリニック"===i){const e=t.querySelector(".ranking__name a")?.textContent?.replace(/\s*＞\s*$/,"")?.trim();e&&(i=e)}}catch(e){}const a=`\n        <div class="clinic-detail-modal" role="dialog" aria-modal="true" aria-label="${i}の詳細">\n            <button class="clinic-detail-close" aria-label="閉じる">&times;</button>\n            <header>\n                <div style="font-size:17px;color:#333;">${i}の詳細</div>\n            </header>\n            <div class="clinic-detail-body">\n                ${n}\n            </div>\n        </div>`;document.body.insertAdjacentHTML("beforeend",'<div class="clinic-detail-overlay"></div>'+a);const s=document.querySelector(".clinic-detail-overlay"),o=document.querySelector(".clinic-detail-modal");if(o){o.querySelectorAll(".banner-slider").forEach(e=>{e.removeAttribute("data-initialized")})}requestAnimationFrame(()=>{s?.classList.add("active"),o?.classList.add("active"),document.body.classList.add("no-scroll");try{g()}catch(e){}try{!function(e){if(!e)return;const t=e.querySelector(".case-slider");if(!t)return;const n=t.querySelector(".case-track");if(!n)return;let i=Array.from(t.querySelectorAll(".case-slide"));const a=e.querySelector(".case-dots");let s=Array.from(e.querySelectorAll(".case-dot"));const o=t.querySelector(".case-nav-prev"),r=t.querySelector(".case-nav-next");if(!i.length)return;let c=0;const l=()=>{i=Array.from(t.querySelectorAll(".case-slide")),s=Array.from(e.querySelectorAll(".case-dot")),s.forEach((e,t)=>e.setAttribute("data-index",String(t)))},d=()=>{const e=i.length>1;o&&(o.style.display=e?"":"none"),r&&(r.style.display=e?"":"none"),a&&(a.style.display=e?"block":"none")},g=e=>{i.length&&n&&(e<0&&(e=i.length-1),e>=i.length&&(e=0),c=e,n.style.display="flex",n.style.transform=`translateX(-${100*c}%)`,n.style.transition="transform .3s ease",i.forEach(e=>{e.style.minWidth="100%",e.style.boxSizing="border-box"}),s.forEach((e,t)=>{e.classList.toggle("active",t===c),e.style.background=t===c?"#2CC7C5":"#ccc"}))};Array.from(t.querySelectorAll("img")).forEach(e=>{e.addEventListener("error",()=>{const t=e.closest(".case-slide");if(!t)return;const n=i.indexOf(t);if(n>=0){const e=s[n];if(e&&e.parentNode&&e.parentNode.removeChild(e),t&&t.parentNode&&t.parentNode.removeChild(t),l(),!i.length)return;c>=i.length&&(c=i.length-1),d(),g(c)}},{once:!0})}),o&&o.addEventListener("click",()=>g(c-1)),r&&r.addEventListener("click",()=>g(c+1)),s.forEach((e,t)=>e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),g(t)})),a&&a.addEventListener("click",e=>{const t=e.target&&1===e.target.nodeType?e.target:e.target&&e.target.parentElement;if(!t)return;const n=t.closest&&t.closest(".case-dot");if(!n)return;e.preventDefault(),e.stopPropagation();const i=n.getAttribute("data-index"),s=i?parseInt(i,10):Array.from(a.querySelectorAll(".case-dot")).indexOf(n);s>=0&&g(s)},{capture:!0});d(),g(0)}(o)}catch(e){}});const r=()=>{p()};s?.addEventListener("click",r),o?.querySelector(".clinic-detail-close")?.addEventListener("click",r);document.addEventListener("keydown",e=>{"Escape"===e.key&&r()},{once:!0})}function p(){const e=document.querySelector(".clinic-detail-overlay"),t=document.querySelector(".clinic-detail-modal");e&&e.parentNode.removeChild(e),t&&t.parentNode.removeChild(t),document.body.classList.remove("no-scroll")}function u(){const e=document.querySelector(".scroll-bottom-modal");e&&e.remove();let t="",n="#ranking";const i=document.querySelector('#clinic1, .ranking_box[data-rank="1"], .ranking-item.rank-1, #ranking-list .ranking-item');let a="";if(i){const e=i.querySelector(".ranking__name a, .clinic-name, .clinic-logo-section h3");e&&(a=e.textContent.replace(/\s*＞\s*$/,"").trim());const t=i.getAttribute("data-clinic-id")||i.id?.replace("clinic","");if(t){n=(new s).getClinicUrlWithRegionId(t,1)}}if(a){const e={"TCB東京中央美容外科":"tcb/tcb-logo.webp","リゼクリニック":"rize/rize-logo.webp","湘南美容クリニック":"sbc/sbc-logo.webp","レジーナクリニック":"regina/regina-logo.webp","品川美容外科":"shinagawa/shinagawa-logo.webp"}[a];e&&(t=`/common_data/images/clinics/${e}`)}if(!t&&i){const e=i.querySelector(".ranking__logo img, .clinic-logo, .clinic-banner img");e&&e.src&&(t=e.src)}if(!t&&window.dataManager){const e=document.querySelector('[data-rank="1"], .ranking-item.rank-1');if(e){const n=e.getAttribute("data-clinic-id"),i=window.dataManager.getClinicCodeById(n);i&&(t=window.dataManager.getClinicText(i,"ロゴ",""))}}t||(t="./images/logo-placeholder.png");let o="今なら特別キャンペーン実施中！";try{const e=document.querySelector('[data-rank="1"], .ranking-item.rank-1, #clinic1, .ranking_box[data-rank="1"]');let t=null;if(e&&(t=e.getAttribute("data-clinic-id")||e.id?.replace("clinic","")),t&&window.dataManager){const e=window.dataManager.getClinicCodeById(t);if(e){const t=window.dataManager.getClinicText(e,"footer-modal1",o);t&&(o=t)}}}catch(e){console.warn("footer-modal1 テキスト取得に失敗:",e)}const r=`\n        <div class="scroll-bottom-modal">\n            <div class="scroll-modal-bubble">\n                <span>${o}</span>\n            </div>\n            \n            <div class="scroll-modal-content">\n                <div class="scroll-modal-left">\n                    <button class="scroll-modal-close" aria-label="閉じる">&times;</button>\n                    <img src="${t}" alt="1位クリニック" class="scroll-modal-logo">\n                </div>\n                <a href="${n}" class="scroll-modal-btn" onclick="if(window.handleClinicClick) handleClinicClick(event, this);">\n                    <span class="scroll-modal-btn-free">無料</span>\n                    <span class="scroll-modal-btn-text">\n                        <span>カウンセリングを</span>\n                        <span>予約する</span>\n                    </span>\n                    <span class="scroll-modal-btn-arrow" aria-hidden="true">▶</span>\n                </a>\n            </div>\n        </div>`;document.body.insertAdjacentHTML("beforeend",r);const c=document.querySelector(".scroll-bottom-modal"),l=c.querySelector(".scroll-modal-close");if(!c||!l)return void console.error("Modal elements not found");let d=!1,g=!1;function m(){if(g)return;const e=window.pageYOffset||document.documentElement.scrollTop,t=window.innerHeight;e/(document.documentElement.scrollHeight-t)*100>=6.5&&(d||g||(c.classList.add("show"),d=!0))}l.addEventListener("click",function(){c.classList.remove("show"),g=!0}),window.addEventListener("scroll",m),setTimeout(()=>{m()},100)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>d("domcontentloaded")):d("document-already-ready"),document.addEventListener("click",function(e){try{const t=e.target&&e.target.closest&&e.target.closest(".case-slide"),n=e.target&&e.target.closest&&e.target.closest(".case-slide img")||t&&t.querySelector&&t.querySelector("img");if(!t&&!n)return;const i=(t||n).closest(".case-slider, .case-carousel-container");if(!i)return;const a=Array.from(i.querySelectorAll(".case-slide img"));if(!a.length)return;const s=a.map(e=>e&&e.src).filter(Boolean);if(!s.length)return;let o=0;if(n)o=Math.max(0,a.indexOf(n));else if(t){const e=Array.from(i.querySelectorAll(".case-slide")).indexOf(t);o=Math.max(0,e)}e.preventDefault(),e.stopPropagation(),m(s,o)}catch(e){}},!0),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){setTimeout(()=>{u()},2e3)}):setTimeout(()=>{u()},2e3);