const __BASE_PATH_RAW=window.__BASE_PATH__??window.SITE_CONFIG?.basePath??"/";const __BASE_PATH_PREFIX=__BASE_PATH_RAW==="/"||__BASE_PATH_RAW===""?"":__BASE_PATH_RAW.replace(/\/+$/,"");function resolveAssetPath(resource){if(typeof resource!=="string"||resource.length===0){return resource}if(/^(?:[a-z][a-z0-9+.-]*:|\/\/|data:|mailto:|tel:)/i.test(resource)){return resource}if(!__BASE_PATH_PREFIX){return resource.startsWith("./")?resource.slice(2):resource}let normalized=resource.startsWith("./")?resource.slice(2):resource;if(!normalized.startsWith("/")){normalized=`/${normalized}`}return`${__BASE_PATH_PREFIX}${normalized}`}function getClinicUrlFromConfig(clinicId,rank=1){if(window.dataManager){const clinicCode=window.dataManager.getClinicCodeById(clinicId);if(clinicCode){const urlKey=`遷移先URL（${rank}位）`;const url=window.dataManager.getClinicText(clinicCode,urlKey,"");if(url){return url}}}return"https://sss.ac01.l-ad.net/cl/p1a64143O61e70f7/?bid=a6640dkh37648h88&param2=[ADID_PLACEHOLDER]&param3=[GCLID_PLACEHOLDER]"}class UrlParamHandler{getParam(name){const urlParams=new URLSearchParams(window.location.search);return urlParams.get(name)}setParam(name,value){const urlParams=new URLSearchParams(window.location.search);urlParams.set(name,value);window.history.replaceState({},"",`${window.location.pathname}?${urlParams}`)}getAllParams(){const urlParams=new URLSearchParams(window.location.search);const params={};for(const[key,value]of urlParams){params[key]=value}return params}getRegionId(){return this.getParam("region_id")||"013"}updateRegionId(regionId){this.setParam("region_id",regionId)}getClinicUrlWithRegionId(clinicId,rank=1){if(!window.dataManager){return"#"}const regionId=this.getRegionId();const redirectParams={clinic_id:clinicId,rank:rank,region_id:regionId||"013"};const redirectUrl=new URL("./redirect.html",window.location.origin+window.location.pathname);redirectUrl.searchParams.set("clinic_id",clinicId);redirectUrl.searchParams.set("rank",rank);if(regionId){redirectUrl.searchParams.set("region_id",regionId)}const dataJson=JSON.stringify(redirectParams);redirectUrl.hash=`params=${encodeURIComponent(dataJson)}`;return redirectUrl.toString()}getClinicUrlByNameWithRegionId(clinicName){let clinicCode=clinicName;const dataManager=window.dataManager;if(dataManager){const clinics=dataManager.clinics||[];const clinic=clinics.find(c=>c.name===clinicName||c.code===clinicName);if(clinic){clinicCode=clinic.code}}if(!clinicCode)return"#";let clinicId=null;let rank=1;if(dataManager){const clinics=dataManager.clinics||[];const clinic=clinics.find(c=>c.code===clinicCode);if(clinic){clinicId=clinic.id;try{if(dataManager.getRankingsByRegion&&typeof dataManager.getRankingsByRegion==="function"){const rankings=dataManager.getRankingsByRegion(this.getRegionId());const rankInfo=rankings.find(r=>r.clinicId==clinicId);if(rankInfo){rank=rankInfo.rank}}else{const regionId=this.getRegionId();if(dataManager.rankings&&dataManager.rankings[regionId]){const regionRankings=dataManager.rankings[regionId];const rankingEntries=Object.entries(regionRankings.ranks||{});for(const[position,cId]of rankingEntries){if(cId==clinicId){rank=parseInt(position.replace("no",""))||1;break}}}}}catch(e){rank=1}}}if(!clinicId)return"#";const regionId=this.getRegionId();let redirectUrl=`./redirect.html?clinic_id=${clinicId}&rank=${rank}`;if(regionId){redirectUrl+=`&region_id=${regionId}`}const urlParams=new URLSearchParams(window.location.search);const utmCreative=urlParams.get("utm_creative");const gclid=urlParams.get("gclid");if(utmCreative){redirectUrl+=`&utm_creative=${encodeURIComponent(utmCreative)}`}if(gclid){redirectUrl+=`&gclid=${encodeURIComponent(gclid)}`}return redirectUrl}getDirectFormUrl(clinicId,rank=1){try{const dm=window.dataManager;if(!dm)return this.getClinicUrlWithRegionId(clinicId,rank);const clinicCode=dm.getClinicCodeById(clinicId);if(!clinicCode)return this.getClinicUrlWithRegionId(clinicId,rank);const rankKeys=[`直フォームの遷移先URL（${rank}位）`,`直フォーム遷移先URL（${rank}位）`,`直フォームURL（${rank}位）`];for(let i=0;i<rankKeys.length;i++){const v=dm.getClinicText(clinicCode,rankKeys[i],"").trim();if(v)return v}const candidates=["直フォームURL","直フォーム遷移先URL","無料相談フォームURL","予約フォームURL","フォームURL","問い合わせフォームURL","CTA直リンクURL"];for(let i=0;i<candidates.length;i++){const val=dm.getClinicText(clinicCode,candidates[i],"").trim();if(val)return val}return this.getClinicUrlWithRegionId(clinicId,rank)}catch(_){return this.getClinicUrlWithRegionId(clinicId,rank)}}}class DisplayManager{constructor(urlHandler){this.urlHandler=urlHandler;this.regionSelect=document.getElementById("sidebar-region-select");this.searchInput=document.getElementById("sidebar-clinic-search");this.selectedRegionName=document.getElementById("selected-region-name");this.rankingList=document.getElementById("ranking-list");this.storesList=document.getElementById("stores-list");this.errorMessage=document.getElementById("error-message");this.errorText=document.getElementById("error-text");this.heroRegionBadge=document.getElementById("hero-region-badge");this.hamburgerMenu=document.getElementById("hamburger-menu");this.sidebarMenu=document.getElementById("sidebar-menu");this.sidebarOverlay=document.getElementById("sidebar-overlay");this.closeSidebar=document.getElementById("close-sidebar")}updateRegionSelector(regions,selectedRegionId){if(!this.regionSelect){console.warn("Region selector not found");return}this.regionSelect.innerHTML="";const allOption=document.createElement("option");allOption.value="";allOption.textContent="全地域";allOption.selected=true;this.regionSelect.appendChild(allOption);regions.forEach(region=>{const option=document.createElement("option");option.value=region.id;option.textContent=region.name;this.regionSelect.appendChild(option)})}updateSelectedRegionName(regionName){if(this.selectedRegionName){this.selectedRegionName.textContent=regionName||"該当店舗なし"}if(this.heroRegionBadge){this.heroRegionBadge.textContent=regionName?`${regionName}版`:"東京版"}}updateRankingDisplay(clinics,ranking){this.rankingList.innerHTML="";if(!ranking||Object.keys(ranking.ranks).length===0){this.rankingList.innerHTML='<div class="empty-state"><p>この地域のランキングデータはありません</p></div>';return}const sortedRanks=Object.entries(ranking.ranks).sort((a,b)=>{const numA=parseInt(a[0].replace("no",""));const numB=parseInt(b[0].replace("no",""));return numA-numB});sortedRanks.forEach(([position,clinicId])=>{const clinic=clinics.find(c=>c.id===clinicId);if(!clinic)return;const rankNum=parseInt(position.replace("no",""));if(rankNum>5)return;const rankingItem=document.createElement("div");rankingItem.className=`ranking-item rank-${rankNum}`;rankingItem.setAttribute("data-rank",String(rankNum));rankingItem.setAttribute("data-clinic-id",String(clinic.id));let medalClass="";let medalText=`No.${rankNum}`;if(rankNum===1)medalClass="gold-medal";else if(rankNum===2)medalClass="silver-medal";else if(rankNum===3)medalClass="bronze-medal";const clinicCodeForRating=window.dataManager.getClinicCodeById(clinic.id);const ratingScore=clinicCodeForRating?parseFloat(window.dataManager.getClinicText(clinicCodeForRating,"総合評価","4.5")):4.5;const rating={score:ratingScore,stars:ratingScore};let starsHtml="";const fullStars=Math.floor(rating.stars);const decimalPart=rating.stars%1;for(let i=0;i<fullStars;i++){starsHtml+='<i class="fas fa-star"></i>'}if(decimalPart>0){const percentage=Math.round(decimalPart*100);starsHtml+=`<i class="fas fa-star" style="background: linear-gradient(90deg, #6bd1d0 ${percentage}%, transparent ${percentage}%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>`}for(let i=Math.ceil(rating.stars);i<5;i++){starsHtml+='<i class="far fa-star"></i>'}const imagesPath=window.SITE_CONFIG?window.SITE_CONFIG.imagesPath+"/images":"/images";const clinicCodeForImage=window.dataManager.getClinicCodeById(clinic.id);let bannerImage=`/common_data/images/clinics/tcb/tcb-logo.webp`;if(clinicCodeForImage){const imagePath=window.dataManager.getClinicText(clinicCodeForImage,"クリニックロゴ画像パス","");if(imagePath){bannerImage=imagePath}else{bannerImage=`/common_data/images/clinics/${clinicCodeForImage}/${clinicCodeForImage}-logo.webp`}}const clinicCode=window.dataManager.getClinicCodeById(clinic.id);const pushMessage=clinicCode?window.dataManager.getClinicText(clinicCode,"ランキングプッシュメッセージ","人気のクリニック"):"人気のクリニック";if(rankNum===1&&!window.__topRankEventPushed){window.__topRankEventPushed=true;window.dataLayer=window.dataLayer||[];window.dataLayer.push({event:"ranking_ready",topClinicName:clinic.name,topClinicCode:clinicCode||""});if((clinicCode||"").toLowerCase()==="dio"){window.dataLayer.push({event:"ranking_ready_dio"})}}let clinicLogoPath="";if(clinicCode){const logoPathFromJson=window.dataManager.getClinicText(clinicCode,"ロゴ画像パス","");if(logoPathFromJson){clinicLogoPath=logoPathFromJson}else{const logoFolder=clinicCode;clinicLogoPath=`/common_data/images/clinics/${logoFolder}/${logoFolder}-logo.webp`}}rankingItem.innerHTML=`\n                <div class="rank-medal ${medalClass}">\n                    <img src="/common_data/images/badges/rank-${rankNum}.svg" alt="${medalText}" class="medal-image">\n                </div>\n                <div class="clinic-card">\n                    <div class="satisfaction-badge">\n                        <span class="satisfaction-label">満足度</span>\n                    </div>\n                    <div class="rating-section">\n                        <div class="stars">\n                            ${starsHtml}\n                        </div>\n                        <div class="rating-score">${rating.score}<span class="score-max">/5.0</span></div>\n                    </div>\n                    <div class="clinic-logo-section">\n                        <h3>${clinic.name}</h3>\n                    </div>\n                    <div class="clinic-banner">\n                        <img src="${clinicLogoPath}" alt="${clinic.name}バナー" onerror="this.style.display='none'">\n                    </div>\n                    <div class="push-message" style="padding: 0px; text-align: center; font-size: clamp(10px, 2.3vw, 15px); line-height: 1.4; color: #333; font-weight: bold; margin: 4px 0; height: 15%;">\n                        ${window.dataManager?.processDecoTags?window.dataManager.processDecoTags(pushMessage):pushMessage}\n                    </div>\n                    <p class="btn btn_second_primary">\n                        <a href="${this.urlHandler.getClinicUrlWithRegionId(clinic.id,rankNum)}" target="_blank" rel="noopener">\n                            <span class="bt_s">公式サイト</span>\n                            <span class="btn-arrow">▶</span>\n                        </a>\n                    </p>\n                </div>\n            `;this.rankingList.appendChild(rankingItem)})}updateStoresDisplay(stores,clinicsWithStores){let brandSectionWrapper=document.querySelector(".brand-section-wrapper");if(!brandSectionWrapper){brandSectionWrapper=document.createElement("section");brandSectionWrapper.className="brand-section-wrapper";const rankingSection=document.querySelector(".ranking-section");if(rankingSection&&rankingSection.parentNode){rankingSection.parentNode.insertBefore(brandSectionWrapper,rankingSection.nextSibling)}else{document.body.appendChild(brandSectionWrapper)}}if(!stores||stores.length===0){brandSectionWrapper.innerHTML='<div style="text-align:center; padding:20px;">この地域には店舗がありません</div>';return}if(!clinicsWithStores||clinicsWithStores.size===0){brandSectionWrapper.innerHTML='<div style="text-align:center; padding:20px;">この地域には店舗がありません</div>';return}let html='<div class="brand-section" style="max-width: 1200px; margin: 0 auto;">';html+='<h3 style="text-align:center; margin-bottom: 30px; font-size: 24px; color: #333;">東京の店舗一覧</h3>';let hasAnyStores=false;clinicsWithStores.forEach((clinicStores,clinic)=>{if(clinicStores&&clinicStores.length>0){hasAnyStores=true;html+=`\n                    <div class="clinic-stores-section" style="margin-bottom: 30px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">\n                        <h4 style="color: #2CC7C5; margin-bottom: 15px; font-size: 20px;">${clinic.name}の【東京】の店舗</h4>\n                        <div class="stores-list" style="display: grid; gap: 15px;">\n                `;clinicStores.forEach(store=>{html+=`\n                        <div class="store-item" style="padding: 15px; background: #f8f9fa; border-left: 3px solid #2CC7C5;">\n                            <div class="store-name" style="font-weight: bold; margin-bottom: 5px;">${store.storeName||store.name||"店舗名不明"}</div>\n                            <div class="store-address" style="color: #666; margin-bottom: 5px;">${store.address||"住所不明"}</div>\n                            <div class="store-access" style="color: #888; font-size: 14px;">${store.access||""}</div>\n                        </div>\n                    `});html+=`\n                        </div>\n                    </div>\n                `}});if(!hasAnyStores){html+='<div style="text-align:center; padding:20px;">この地域には店舗がありません</div>'}html+="</div>";brandSectionWrapper.innerHTML=html}showError(message){this.errorText.textContent=message;this.errorMessage.style.display="block";if(this.errorTimeout){clearTimeout(this.errorTimeout)}this.errorTimeout=setTimeout(()=>{this.errorMessage.style.display="none"},5e3)}hideError(){this.errorMessage.style.display="none"}updateFooterClinics(clinics,ranking){const footerUls=document.querySelectorAll("#footer ul");let footerClinicsContainer=null;for(const ul of footerUls){const h5=ul.querySelector("h5");if(h5&&h5.textContent==="人気クリニック"){footerClinicsContainer=ul;break}}if(!footerClinicsContainer)return;const clinicLinks=footerClinicsContainer.querySelectorAll("li");clinicLinks.forEach(link=>link.remove());if(!ranking||Object.keys(ranking.ranks).length===0){return}const sortedRanks=Object.entries(ranking.ranks).sort((a,b)=>{const numA=parseInt(a[0].replace("no",""));const numB=parseInt(b[0].replace("no",""));return numA-numB}).slice(0,5);sortedRanks.forEach(([position,clinicId])=>{const clinic=clinics.find(c=>c.id===clinicId);if(!clinic)return;const rankNum=parseInt(position.replace("no",""));const li=document.createElement("li");const link=document.createElement("a");link.href=this.urlHandler.getClinicUrlWithRegionId(clinic.id,rankNum);link.target="_blank";link.rel="noopener noreferrer";link.textContent=clinic.name;li.appendChild(link);footerClinicsContainer.appendChild(li)})}}class DataManager{constructor(){this.regions=[];this.clinics=[];this.stores=[];this.rankings=[];this.storeViews=[];this.campaigns=[];this.siteTexts={};this.clinicTexts={};const ensureTrailingSlash=value=>value.endsWith("/")?value:`${value}/`;this.dataPath=ensureTrailingSlash(resolveAssetPath("/data/"));this.regionDataPath=ensureTrailingSlash(resolveAssetPath("/data/ranking/"));this.commonDataPath=ensureTrailingSlash(resolveAssetPath("/common_data/data/"))}logClinicTextsLoaded(sourceLabel){if(typeof console==="undefined"||typeof console.info!=="function"){return}const total=this.clinicTexts&&typeof this.clinicTexts==="object"?Object.keys(this.clinicTexts).length:0;console.info(`[DataManager] clinicTexts loaded via ${sourceLabel}: ${total} entries`)}async init(){try{const loadedFromBundle=await this.loadFromBundle();if(!loadedFromBundle){await Promise.all([this.loadRegions(),this.loadClinics(),this.loadRankings(),this.loadStoreViews(),this.loadStores(),this.loadCampaigns().catch(()=>null)])}if(!this.commonTexts||Object.keys(this.commonTexts).length===0){this.commonTexts={};await this.loadCommonTexts()}this.applyCommonTextAssets();if(!this.clinicTexts||Object.keys(this.clinicTexts).length===0){await this.loadClinicTexts()}if(!this.campaigns||this.campaigns.length===0){try{await this.loadCampaigns()}catch(_){}}if(!this.stores||this.stores.length===0){try{this.stores=[];this.clinics.forEach(clinic=>{if(!clinic.stores)return;clinic.stores.forEach(store=>{this.stores.push({id:store.id,clinicName:clinic.name,storeName:store.name,name:store.name,address:store.address,zipcode:store.zipcode,access:store.access,regionId:this.getRegionIdFromAddress(store.address)})})})}catch(_){}}}catch(error){throw error}}async loadFromBundle(){try{const bundle=await this.fetchJsonWithFallback([this.dataPath+"compiled-data.json",this.dataPath+"data-bundle.json"]);if(!bundle||Array.isArray(bundle)){return false}const{regions:regions=[],clinics:clinics=[],rankings:rankings=[],storeViews:storeViews=[],stores:stores=[],campaigns:campaigns=[],commonTexts:commonTexts={},clinicTexts:clinicTexts={}}=bundle;this.regions=this.normalizeRegions(regions);this.clinics=this.normalizeClinics(clinics);this.rankings=this.normalizeRankings(rankings);this.storeViews=this.normalizeStoreViews(storeViews);this.stores=this.normalizeStores(stores);this.campaigns=this.normalizeCampaigns(campaigns);this.commonTexts=commonTexts;this.clinicTexts=clinicTexts;this.logClinicTextsLoaded("bundle");return true}catch(error){console.warn("⚠️ compiled-data.json 読込エラー:",error);return false}}applyCommonTextAssets(){if(!this.commonTexts||Object.keys(this.commonTexts).length===0){return}setTimeout(()=>{if(!this.commonTexts)return;if(this.commonTexts["MV画像パス"]){const heroImage=document.querySelector(".hero-image");const heroSource=document.querySelector(".hero-image-wrapper source");if(heroImage){heroImage.src=this.commonTexts["MV画像パス"]}if(heroSource){heroSource.srcset=this.commonTexts["MV画像パス"]}}if(this.commonTexts["ランキングバナー画像パス"]){const rankingBanners=document.querySelectorAll(".ranking-banner-image");rankingBanners.forEach(img=>{img.src=this.commonTexts["ランキングバナー画像パス"]})}if(this.commonTexts["Tips1画像パス"]){const tips1Img=document.querySelector('.tab-content[data-tab="0"] img');if(tips1Img){tips1Img.src=this.commonTexts["Tips1画像パス"]}}if(this.commonTexts["Tips2画像パス"]){const tips2Img=document.querySelector('.tab-content[data-tab="1"] img');if(tips2Img){tips2Img.src=this.commonTexts["Tips2画像パス"]}}if(this.commonTexts["Tips3画像パス"]){const tips3Img=document.querySelector('.tab-content[data-tab="2"] img');if(tips3Img){tips3Img.src=this.commonTexts["Tips3画像パス"]}}if(this.commonTexts["詳細バナー画像パス"]){const detailsBanner=document.querySelector(".details-banner-image");if(detailsBanner){detailsBanner.src=this.commonTexts["詳細バナー画像パス"]}}},100)}normalizeRegions(data=[]){return(Array.isArray(data)?data:[]).map(row=>{if(!row)return null;const rawId=row.id??row.regionId??row.parameter_no??row.parameterNo??"";const name=row.name??row.region??"";const id=String(rawId||"").padStart(3,"0");if(!id||!name)return null;return{id:id,name:name}}).filter(Boolean)}normalizeClinics(data=[]){return(Array.isArray(data)?data:[]).map(row=>{if(!row)return null;const rawId=row.id??row.clinic_id??row.clinicId??"";const name=row.name??row.clinic_name??row.clinicName??"";const code=row.code??row.clinic_code??row.clinicCode??"";if(!rawId||!name)return null;return{id:String(rawId),name:name,code:code||""}}).filter(Boolean)}normalizeStores(data=[]){return(Array.isArray(data)?data:[]).map(row=>{if(!row)return null;const rawId=row.id??row.store_id??row.storeId??"";const clinicName=row.clinicName??row.clinic_name??"";const storeName=row.storeName??row.store_name??row.name??"";const address=row.address??row.adress??"";const zipcode=row.zipcode??row.Zipcode??"";const access=row.access??"";const regionRaw=row.regionId??row.region_id??null;const regionId=regionRaw!=null&&regionRaw!==""?String(regionRaw).padStart(3,"0"):null;if(!rawId||!clinicName)return null;return{id:String(rawId),clinicName:clinicName,storeName:storeName,name:storeName,zipcode:zipcode,address:address,access:access,regionId:regionId}}).filter(Boolean)}normalizeRankings(data=[]){if(!Array.isArray(data))return[];if(data.every(row=>row&&row.ranks)){return data.map(row=>({regionId:String(row.regionId??"").padStart(3,"0"),ranks:row.ranks||{}})).filter(entry=>entry.regionId)}const rankingMap={};data.forEach(row=>{if(!row)return;const regionId=String(row.parameter_no||row.region_id||row.parameterNo||"").padStart(3,"0");if(!regionId||regionId==="NaN")return;if(!rankingMap[regionId]){rankingMap[regionId]={regionId:regionId,ranks:{}}}Object.keys(row).forEach(key=>{if(!key||!key.startsWith("no"))return;const value=row[key];if(!value||value==="-")return;rankingMap[regionId].ranks[key]=value})});return Object.values(rankingMap)}normalizeStoreViews(data=[]){return(Array.isArray(data)?data:[]).map(row=>{if(!row)return null;const regionId=String(row.regionId??row.region_id??row.parameter_no??row.parameterNo??"").padStart(3,"0");const clinicStores={};if(row.clinicStores&&typeof row.clinicStores==="object"){Object.keys(row.clinicStores).forEach(key=>{const val=row.clinicStores[key];if(!val)return;clinicStores[key]=Array.isArray(val)?val:String(val).split(/[\\/|]/).map(v=>v.trim()).filter(Boolean)})}else{Object.keys(row).forEach(key=>{if(!key||key==="parameter_no"||key==="parameterNo"||key==="regionId"||key==="region_id")return;if(!/_stores$/.test(key))return;const val=row[key];if(!val||val==="-")return;clinicStores[key]=String(val).split(/[\\/|]/).map(v=>v.trim()).filter(Boolean)})}return{regionId:regionId,clinicStores:clinicStores}}).filter(entry=>entry&&entry.regionId)}normalizeCampaigns(data=[]){return(Array.isArray(data)?data:[]).map(row=>{if(!row)return null;const id=row.id??row.campaign_id??"";const regionId=row.regionId??row.region_id??"";const clinicId=row.clinicId??row.clinic_id??"";const title=row.title??"";const headerText=row.headerText??row.header_text??"";const logoSrc=row.logoSrc??row.logo_src??"";const logoAlt=row.logoAlt??row.logo_alt??"";const description=row.description??"";const ctaText=row.ctaText??row.cta_text??"";const ctaUrl=row.ctaUrl??row.cta_url??"";const footerText=row.footerText??row.footer_text??"";if(!id&&!clinicId&&!title){return null}return{id:id,regionId:regionId,clinicId:clinicId,title:title,headerText:headerText,logoSrc:logoSrc,logoAlt:logoAlt,description:description,ctaText:ctaText,ctaUrl:ctaUrl,footerText:footerText}}).filter(Boolean)}async loadCommonTexts(){this.commonTexts={};let hasJson=false;try{const jsonData=await this.fetchJsonWithFallback([this.dataPath+"site-common-texts.json",this.dataPath+"appeal_text/site-common-texts.json"]);if(jsonData&&!Array.isArray(jsonData)){this.commonTexts={...this.commonTexts,...jsonData};hasJson=true}}catch(e){console.warn("⚠️ site-common-texts.json 読込エラー:",e)}if(!hasJson){await this.loadCommonTextsFromCsvLegacy()}try{const override=await this.fetchJsonWithFallback([this.commonDataPath+"site-common-texts.json",resolveAssetPath("/common_data/data/site-common-texts.json")]);if(override&&!Array.isArray(override)){this.commonTexts={...this.commonTexts,...override}}}catch(err){console.warn("⚠️ common_dataのsite-common-texts.json読み込みエラー:",err)}if(this.commonTexts["ファビコン画像パス"]){const faviconElement=document.getElementById("favicon");if(faviconElement){faviconElement.href=this.commonTexts["ファビコン画像パス"]}const headerLogoIcon=document.getElementById("header-logo-icon");if(headerLogoIcon){headerLogoIcon.src=this.commonTexts["ファビコン画像パス"]}}}async loadCommonTextsFromCsvLegacy(){try{const primary=this.dataPath+"site-common-texts.csv";const legacy=this.dataPath+"appeal_text/site-common-texts.csv";let respLocal=await fetch(primary);if(!respLocal.ok){respLocal=await fetch(legacy)}if(respLocal.ok){const obj=await this.readSiteCommonCsvFromResponse(respLocal);this.commonTexts={...this.commonTexts,...obj}}}catch(e){console.warn("⚠️ ローカル site-common-texts.csv 読込エラー:",e)}}async fetchJsonWithFallback(candidates=[]){for(const url of candidates){if(!url)continue;try{const res=await fetch(url);if(!res||!res.ok)continue;const raw=await res.text();if(!raw)continue;const text=raw.replace(/^\uFEFF/,"").trim();if(!text)continue;return JSON.parse(text)}catch(_){}}return null}async readSiteCommonCsvFromResponse(response){const buffer=await response.arrayBuffer();let text="";try{text=new TextDecoder("utf-8").decode(buffer)}catch(_){}const replacementCount=(text.match(/\uFFFD|�/g)||[]).length;if(!text||replacementCount>5){try{text=new TextDecoder("shift_jis").decode(buffer)}catch(_){}}if(text.charCodeAt(0)===65279)text=text.slice(1);const lines=text.split(/\r?\n/).filter(l=>l.trim());if(lines.length<=1)return{};const result={};for(let i=1;i<lines.length;i++){const cols=this.parseCsvLineWithQuotes(lines[i]);if(cols.length>=3){const key=(cols[0]||"").trim();let value=(cols[2]||"").trim();if(!key)continue;if(value.startsWith('"')&&value.endsWith('"')){value=value.slice(1,-1).replace(/""/g,'"')}result[key]=value}}return result}parseCsvLineWithQuotes(line){const row=[];let cur="";let inQuotes=false;for(let i=0;i<line.length;i++){const ch=line[i];const next=line[i+1];if(ch==='"'){if(inQuotes&&next==='"'){cur+='"';i++}else{inQuotes=!inQuotes}}else if(ch===","&&!inQuotes){row.push(cur);cur=""}else{cur+=ch}}row.push(cur);return row}async loadClinicTexts(){try{const jsonData=await this.fetchJsonWithFallback([this.dataPath+"clinic-texts.json",this.dataPath+"clinic_text/clinic-texts.json"]);if(jsonData&&typeof jsonData==="object"&&!Array.isArray(jsonData)){this.clinicTexts=jsonData;this.logClinicTextsLoaded("clinic-texts.json");return}}catch(err){console.warn("⚠️ clinic-texts.json の読み込みに失敗しました:",err)}await this.loadClinicTextsFromCsvLegacy()}async loadClinicTextsFromCsvLegacy(){try{const primary=this.dataPath+"clinic-texts.csv";const legacy=this.dataPath+"clinic_text/clinic-texts.csv";let resp=await fetch(primary);if(!resp.ok){resp=await fetch(legacy)}if(!resp.ok)throw new Error(`Failed to load clinic-texts.csv: ${resp.status}`);const buffer=await resp.arrayBuffer();let text="";try{text=new TextDecoder("utf-8").decode(buffer)}catch(_){}const replacementCount=(text.match(/\uFFFD|�/g)||[]).length;if(!text||replacementCount>10){try{text=new TextDecoder("shift_jis").decode(buffer)}catch(_){}}const records=this.parseCsvWithQuotes(text);if(!records||records.length===0){console.warn("⚠️ clinic-texts.csv にレコードがありません");this.clinicTexts={};return}const headers=records[0];const clinicNames=headers.slice(3).map(h=>(h||"").trim()).filter(Boolean);const clinicsData={};const comparisonHeaders={};const detailFields={};clinicNames.forEach(name=>{clinicsData[name]={}});for(let i=1;i<records.length;i++){const row=records[i];if(!row||row.length===0)continue;const listName=(row[0]||"").trim();const fieldName=(row[1]||"").trim();if(!listName||!fieldName)continue;if(listName.startsWith("comparison")){const num=listName.replace("comparison","");comparisonHeaders[`比較表ヘッダー${num}`]=fieldName;for(let j=0;j<clinicNames.length;j++){const clinicName=clinicNames[j];const value=row[j+3]||"";clinicsData[clinicName][fieldName]=value}}else if(listName.startsWith("detail")){let mappingKey="";switch(fieldName){case"費用":mappingKey="priceDetail";break;case"目安期間":mappingKey="periods";break;case"矯正範囲":mappingKey="ranges";break;case"営業時間":mappingKey="hours";break;case"店舗":mappingKey="stores";break;case"特徴タグ":mappingKey="featureTags";break;default:mappingKey=fieldName;break}if(mappingKey&&mappingKey!=="特徴タグ"){detailFields[mappingKey]=fieldName}for(let j=0;j<clinicNames.length;j++){const clinicName=clinicNames[j];const value=row[j+3]||"";clinicsData[clinicName][`詳細_${fieldName}`]=value}}else if(listName.startsWith("tags")){for(let j=0;j<clinicNames.length;j++){const clinicName=clinicNames[j];const value=row[j+3]||"";clinicsData[clinicName][`詳細_${fieldName}`]=value}}else if(listName.startsWith("meta")){for(let j=0;j<clinicNames.length;j++){const clinicName=clinicNames[j];const value=row[j+3]||"";clinicsData[clinicName][fieldName]=value}}else{const clinicCodeToName={ohmyteeth:"Oh my teeth",invisalign:"インビザライン",kireilign:"キレイライン矯正",zenyum:"ゼニュム",wesmile:"ウィスマイル"};if(clinicCodeToName[listName]){const target=clinicCodeToName[listName];if(clinicsData[target]){clinicsData[target][fieldName]=row[3]||""}}else{for(let j=0;j<clinicNames.length;j++){const clinicName=clinicNames[j];const value=row[j+3]||"";clinicsData[clinicName][fieldName]=value}}}}const result={};result["比較表ヘッダー設定"]=comparisonHeaders;result["詳細フィールドマッピング"]=detailFields;result["詳細フィールドマッピング"]["officialSite"]="公式サイトURL";Object.keys(clinicsData).forEach(name=>{result[name]=clinicsData[name]});this.clinicTexts=result;this.logClinicTextsLoaded("clinic-texts.csv")}catch(e){console.warn("⚠️ clinic-texts.csv の読み込み/変換に失敗しました:",e);this.clinicTexts={}}}getReviewTabLabels(clinicCode){try{const codeToNameMap={tcb:"TCB",TCB:"TCB",luna:"LUNAビューティークリニック","LUNAビューティークリニック":"LUNAビューティークリニック",rize:"リゼクリニック","リゼクリニック":"リゼクリニック",shinagawa:"品川美容外科","品川美容外科":"品川美容外科",seishin:"聖心美容クリニック","聖心美容クリニック":"聖心美容クリニック"};let clinicName=codeToNameMap[clinicCode];if(!clinicName){const clinic=this.clinics.find(c=>c.code===clinicCode);clinicName=clinic?clinic.name:null}const specialKeys=new Set(["比較表ヘッダー設定","詳細フィールドマッピング"]);if(!clinicName){const clinicKeys=Object.keys(this.clinicTexts||{}).filter(k=>!specialKeys.has(k));clinicName=clinicKeys[0]}const clinicData=this.clinicTexts&&clinicName?this.clinicTexts[clinicName]||{}:{};const keys=Object.keys(clinicData);const meta=new Map;for(let idx=0;idx<keys.length;idx++){const k=keys[idx];let m=k.match(/^口コミ([1-3])タイトル（(.+?)）$/);if(!m)m=k.match(/^口コミ([1-3])タイトル\((.+?)\)$/);if(!m)continue;const n=parseInt(m[1],10);const label=m[2];if(!meta.has(label)){meta.set(label,{firstIndex:idx,minN:n})}else{const obj=meta.get(label);if(n<obj.minN)obj.minN=n}}let labels=Array.from(meta.entries()).sort((a,b)=>a[1].minN-b[1].minN||a[1].firstIndex-b[1].firstIndex).map(([label])=>label);if(labels.length===0)labels=["コスパ","スタッフ","サービス"];return labels.slice(0,3)}catch(_){return["コスパ","スタッフ","サービス"]}}getClinicReviewsByLabel(clinicCode,label){const reviews=[];for(let i=1;i<=3;i++){let title=this.getClinicText(clinicCode,`口コミ${i}タイトル（${label}）`,"");if(!title)title=this.getClinicText(clinicCode,`口コミ${i}タイトル(${label})`,"");let content=this.getClinicText(clinicCode,`口コミ${i}内容（${label}）`,"");if(!content)content=this.getClinicText(clinicCode,`口コミ${i}内容(${label})`,"");if(title||content)reviews.push({title:title,content:content})}return reviews}parseCsvWithQuotes(csvText){const lines=csvText.split(/\r?\n/);const records=[];for(let li=0;li<lines.length;li++){const raw=lines[li];if(raw==null)continue;const line=String(raw);if(!line.trim())continue;const row=[];let cur="";let inQuotes=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){if(inQuotes&&line[i+1]==='"'){cur+='"';i++}else{inQuotes=!inQuotes}}else if(ch===","&&!inQuotes){row.push(cur);cur=""}else{cur+=ch}}row.push(cur);records.push(row)}return records}getRegionIdFromAddress(address){if(!address)return null;for(const region of this.regions){if(address.includes(region.name)){return region.id}}return null}async loadCsvFile(filename){try{const candidates=[];if(filename.includes("ranking.csv")){candidates.push(this.dataPath+filename);candidates.push(this.regionDataPath+filename)}else if(filename.includes("items.csv")||filename.includes("region.csv")||filename.includes("store_view.csv")||filename.includes("stores.csv")){candidates.push(this.commonDataPath+filename)}else{candidates.push(this.dataPath+filename)}let response=null;for(const url of candidates){try{const res=await fetch(url);if(res.ok){response=res;break}}catch(_){}}if(!response){throw new Error(`Failed to load ${filename}`)}const buffer=await response.arrayBuffer();let text="";try{text=new TextDecoder("utf-8").decode(buffer)}catch(_){}const replacementCount=(text.match(/\uFFFD|�/g)||[]).length;if(!text||replacementCount>10){try{text=new TextDecoder("shift_jis").decode(buffer)}catch(_){}}const records=this.parseCsvWithQuotes(text);if(!records||records.length===0)return[];const headers=records[0].map(h=>(h||"").trim());const rows=[];for(let i=1;i<records.length;i++){const rec=records[i];if(!rec||rec.length===0||rec.every(v=>(v||"").trim()===""))continue;const obj={};headers.forEach((h,idx)=>{obj[h]=(rec[idx]||"").trim()});rows.push(obj)}return rows}catch(error){throw error}}async loadRegions(){let data=[];try{const json=await this.fetchJsonWithFallback([this.commonDataPath+"出しわけSS - region.json",this.dataPath+"出しわけSS - region.json"]);if(Array.isArray(json)&&json.length>0){data=json}}catch(err){console.warn("⚠️ 出しわけSS - region.json 読込エラー:",err)}if(!data.length){data=await this.loadCsvFile("出しわけSS - region.csv")}this.regions=this.normalizeRegions(data)}async loadClinics(){let data=[];try{const json=await this.fetchJsonWithFallback([this.commonDataPath+"出しわけSS - items.json",this.dataPath+"出しわけSS - items.json"]);if(Array.isArray(json)&&json.length>0){data=json}}catch(err){console.warn("⚠️ 出しわけSS - items.json 読込エラー:",err)}if(!data.length){data=await this.loadCsvFile("出しわけSS - items.csv")}this.clinics=this.normalizeClinics(data)}async loadStores(){let data=[];try{const json=await this.fetchJsonWithFallback([this.commonDataPath+"出しわけSS - stores.json",this.dataPath+"出しわけSS - stores.json"]);if(Array.isArray(json)&&json.length>0){data=json}}catch(err){console.warn("⚠️ 出しわけSS - stores.json 読込エラー:",err)}if(!data.length){data=await this.loadCsvFile("出しわけSS - stores.csv")}this.stores=this.normalizeStores(data)}async loadRankings(){let data=[];try{const json=await this.fetchJsonWithFallback([this.dataPath+"出しわけSS - ranking.json",this.regionDataPath+"出しわけSS - ranking.json"]);if(Array.isArray(json)&&json.length>0){data=json}}catch(err){console.warn("⚠️ 出しわけSS - ranking.json 読込エラー:",err)}if(!data.length){data=await this.loadCsvFile("出しわけSS - ranking.csv")}this.rankings=this.normalizeRankings(data)}async loadStoreViews(){let data=[];try{const json=await this.fetchJsonWithFallback([this.commonDataPath+"出しわけSS - store_view.json",this.dataPath+"出しわけSS - store_view.json"]);if(Array.isArray(json)&&json.length>0){data=json}}catch(err){console.warn("⚠️ 出しわけSS - store_view.json 読込エラー:",err)}if(!data.length){data=await this.loadCsvFile("出しわけSS - store_view.csv")}this.storeViews=this.normalizeStoreViews(data)}async loadCampaigns(){let data=[];try{const json=await this.fetchJsonWithFallback([this.dataPath+"出しわけSS - campaigns.json",this.commonDataPath+"出しわけSS - campaigns.json"]);if(Array.isArray(json)&&json.length>0){data=json}}catch(err){console.warn("⚠️ 出しわけSS - campaigns.json 読込エラー:",err)}if(!data.length){data=await this.loadCsvFile("出しわけSS - campaigns.csv")}this.campaigns=this.normalizeCampaigns(data)}associateStoresWithRegions(){this.stores.forEach(store=>{for(const region of this.regions){if(store.address.includes(region.name)){store.regionId=region.id;break}}})}getAllRegions(){return this.regions}getAllClinics(){return this.clinics}getClinicById(clinicId){return this.clinics.find(c=>c.id==clinicId)}getRegionById(regionId){if(regionId==="000"||regionId==="0"){const zenkoku=this.regions.find(r=>r.id==="0"||r.id==="000");if(zenkoku)return zenkoku;return{id:"000",name:"全国",parentId:null}}const paddedId=String(regionId).padStart(3,"0");const unpaddedId=String(parseInt(regionId,10));return this.regions.find(r=>r.id===unpaddedId||r.id===paddedId||r.id===String(regionId))}getClinicCodeById(clinicId){const clinic=this.clinics.find(c=>c.id===String(clinicId));return clinic?clinic.code:null}getSiteText(regionId,elementId,defaultText=""){if(this.siteTexts&&this.siteTexts[regionId]&&this.siteTexts[regionId][elementId]){return this.siteTexts[regionId][elementId]}return defaultText}getCommonText(itemKey,defaultText="",placeholders={}){let text=defaultText;if(this.commonTexts&&this.commonTexts[itemKey]){text=this.commonTexts[itemKey]}else{}Object.keys(placeholders).forEach(key=>{const regex=new RegExp(`{{${key}}}`,"g");text=text.replace(regex,placeholders[key])});return text}getClinicHeaderConfig(){if(this.clinicTexts&&this.clinicTexts["比較表ヘッダー設定"]){return this.clinicTexts["比較表ヘッダー設定"]}return{}}getClinicText(clinicCode,itemKey,defaultText=""){let actualItemKey=itemKey;if(itemKey.startsWith("comparison")){const headerConfig=this.clinicTexts&&this.clinicTexts["比較表ヘッダー設定"];if(headerConfig){const comparisonNum=itemKey.replace("comparison","");const headerKey=`比較表ヘッダー${comparisonNum}`;if(headerConfig[headerKey]){actualItemKey=headerConfig[headerKey]}}}const codeToNameMap={tcb:"TCB",TCB:"TCB",luna:"LUNAビューティークリニック","LUNAビューティークリニック":"LUNAビューティークリニック",rize:"リゼクリニック","リゼクリニック":"リゼクリニック",shinagawa:"品川美容外科","品川美容外科":"品川美容外科",seishin:"聖心美容クリニック","聖心美容クリニック":"聖心美容クリニック"};let clinicName=codeToNameMap[clinicCode];if(!clinicName){const clinic=this.clinics.find(c=>c.code===clinicCode);clinicName=clinic?clinic.name:null}if(actualItemKey==="比較表の注意事項"){if(clinicName&&this.clinicTexts&&this.clinicTexts[clinicName]){if(this.clinicTexts[clinicName][actualItemKey]){}}}if(clinicName&&this.clinicTexts&&this.clinicTexts[clinicName]&&this.clinicTexts[clinicName][actualItemKey]){const value=this.clinicTexts[clinicName][actualItemKey];return value}return defaultText}getClinicRating(clinicCode,defaultRating=4.5){const rating=this.getClinicText(clinicCode,"総合評価",defaultRating.toString());return parseFloat(rating)||defaultRating}getClinicName(clinicCode,defaultName="クリニック"){return this.getClinicText(clinicCode,"クリニック名",defaultName)}processDecoTags(text){if(!text||typeof text!=="string")return text;return text.replace(/<deco>(.*?)<\/deco>/g,'<span class="deco-text">$1</span>')}getClinicReviews(clinicCode){const reviews={cost:[],access:[],staff:[]};for(let i=1;i<=3;i++){const title=this.getClinicText(clinicCode,`口コミ${i}タイトル（コスパ）`,"");const content=this.getClinicText(clinicCode,`口コミ${i}内容（コスパ）`,"");if(title&&content){reviews.cost.push({title:title,content:content})}}for(let i=1;i<=3;i++){const title=this.getClinicText(clinicCode,`口コミ${i}タイトル（スタッフ）`,"");const content=this.getClinicText(clinicCode,`口コミ${i}内容（スタッフ）`,"");if(title&&content){reviews.access.push({title:title,content:content})}}for(let i=1;i<=3;i++){const title=this.getClinicText(clinicCode,`口コミ${i}タイトル（サービス）`,"");const content=this.getClinicText(clinicCode,`口コミ${i}内容（サービス）`,"");if(title&&content){reviews.staff.push({title:title,content:content})}}return reviews}getRegionName(regionId){const region=this.getRegionById(regionId);return region?region.name:""}getStoreImage(clinicCode,storeNumber){const clinic=this.clinics?.find(c=>c.code===clinicCode);if(clinic){const customImagePath=this.getClinicText(clinicCode,"店舗画像パス","");if(customImagePath){return customImagePath}}const paddedNumber=String(storeNumber).padStart(3,"0");return`/images/clinics/${clinicCode}/${clinicCode}_clinic/clinic_image_${paddedNumber}.webp`}generateMapIframe(address){if(!address){return"<p>住所情報がありません</p>"}const encodedAddress=encodeURIComponent(address);const mapUrl=`https://maps.google.com/maps?q=${encodedAddress}&output=embed&z=16`;return`\n            <iframe src="${mapUrl}" width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Google Maps">\n            </iframe>\n        `}generateStoresDisplay(clinicId,regionId,providedStores=null){const clinicCode=this.getClinicCodeById(clinicId);if(!clinicCode){return'<div class="shops"><p class="no-stores">店舗情報がありません</p></div>'}const ranking=this.getRankingByRegionId(regionId);let rank=1;if(ranking&&ranking.ranks){for(const[position,id]of Object.entries(ranking.ranks)){if(id===clinicId){rank=parseInt(position);break}}}const urlFieldName=`遷移先URL（${rank}位）`;let targetUrl=this.getClinicText(clinicCode,urlFieldName,"");if(!targetUrl){targetUrl=this.getClinicText(clinicCode,"遷移先URL（1位）","")}const storeData=providedStores||this.getStoreDataForClinic(clinicCode,regionId);if(!storeData||storeData.length===0){return'<div class="shops"><p class="no-stores">この地域には店舗がありません</p></div>'}const visibleStores=storeData.slice(0,3);const hiddenStores=storeData.slice(3);const storeId=`shops-${Date.now()}`;let html=`<div class="shops" id="${storeId}">`;visibleStores.forEach((store,index)=>{const storeName=store.name||store.storeName||"店舗名不明";const storeAddress=store.address||"住所情報なし";const redirectUrl=`./redirect.html#clinic_id=${clinicId}&rank=${rank}&region_id=${regionId}`;const onclickHandler=targetUrl?`onclick="localStorage.setItem('redirectParams', JSON.stringify({clinic_id: '${clinicId}', rank: '${rank}', region_id: '${regionId}'})); setTimeout(() => { window.open('${redirectUrl}', '_blank'); }, 10); return false;"`:"";html+=`\n                <div class='shop'>\n                    <div class='shop-image'>\n                        <img src="${this.getStoreImage(clinicCode,index+1)}" alt="${storeName}" onerror="this.src='${this.getClinicLogoPath(clinicCode)}'" />\n                    </div>\n                    <div class='shop-info'>\n                        <div class='shop-name'>\n                            <a href="#" ${onclickHandler} style="cursor: pointer;">${storeName}</a>\n                        </div>\n                        <div class='shop-address line-clamp'>\n                            ${storeAddress}\n                        </div>\n                    </div>\n                    <a class="shop-btn map-toggle-btn" href="javascript:void(0);" data-store-id="${storeId}-${index}">\n                        <i class='fas fa-map-marker-alt btn-icon'></i>\n                        地図\n                    </a>\n                </div>\n            `});hiddenStores.forEach((store,index)=>{const storeName=store.name||store.storeName||"店舗名不明";const storeAddress=store.address||"住所情報なし";const redirectUrl=`./redirect.html#clinic_id=${clinicId}&rank=${rank}&region_id=${regionId}`;const onclickHandler=targetUrl?`onclick="localStorage.setItem('redirectParams', JSON.stringify({clinic_id: '${clinicId}', rank: '${rank}', region_id: '${regionId}'})); setTimeout(() => { window.open('${redirectUrl}', '_blank'); }, 10); return false;"`:"";html+=`\n                <div class='shop hidden-content hidden'>\n                    <div class='shop-image'>\n                        <img src="${this.getStoreImage(clinicCode,index+4)}" alt="${storeName}" onerror="this.src='${this.getClinicLogoPath(clinicCode)}'" />\n                    </div>\n                    <div class='shop-info'>\n                        <div class='shop-name'>\n                            <a href="#" ${onclickHandler} style="cursor: pointer;">${storeName}</a>\n                        </div>\n                        <div class='shop-address line-clamp'>\n                            ${storeAddress}\n                        </div>\n                    </div>\n                    <a class="shop-btn map-toggle-btn" href="javascript:void(0);" data-store-id="${storeId}-${index+3}">\n                        <i class='fas fa-map-marker-alt btn-icon'></i>\n                        地図\n                    </a>\n                </div>\n            `});if(hiddenStores.length>0){html+=`\n                <button class="more-button" data-target="#${storeId}" onclick="toggleStores(this)"><span class="button-text">他${hiddenStores.length}件のクリニックを見る</span></button>\n            `}html+="</div>";return html}getStoreDataForClinic(clinicCode,regionId){const mappedRegionId=this.mapRegionId(regionId);let storeView=this.storeViews.find(sv=>sv.regionId===mappedRegionId);if(!storeView){const normalizedRegionId=String(parseInt(mappedRegionId,10));storeView=this.storeViews.find(sv=>sv.regionId===normalizedRegionId)}if(!storeView)return[];const ranking=this.getRankingByRegionId(regionId);if(!ranking)return[];const clinic=this.clinics.find(c=>c.code===clinicCode);if(!clinic)return[];const clinicId=clinic.id;if(!clinicId)return[];const clinicKey=`${clinicCode}_stores`;const storeIdsToShow=storeView.clinicStores[clinicKey]||[];if(storeIdsToShow.length===0)return[];const allStoreIds=[];storeIdsToShow.forEach(storeId=>{if(storeId.includes("/")){const ids=storeId.split("/");allStoreIds.push(...ids)}else{allStoreIds.push(storeId)}});const result=this.stores.filter(store=>allStoreIds.includes(store.id));return result.map(store=>({name:store.storeName||store.name,address:store.address,access:store.access||"主要駅より徒歩圏内",hours:this.getClinicText(clinicCode,"営業時間","10:00〜19:00")}))}generateAddressForRegion(regionId,defaultAddress=""){const region=this.getRegionById(regionId);if(!region){return defaultAddress||"住所情報準備中"}return addressPatterns[regionId]||`${region.name}の主要エリア内`}getClinicLogoPath(clinicCode){const logoFolder=clinicCode==="kireiline"?"kireiline":clinicCode;return this.getClinicText(clinicCode,"クリニックロゴ画像パス",`/common_data/images/clinics/${logoFolder}/${logoFolder}-logo.webp`)}getClinicDetailData(clinicId){const clinic=this.getClinicById(clinicId);if(!clinic)return null;const clinicCode=clinic.code;const clinicName=clinic.name;const fieldMapping=this.clinicTexts["詳細フィールドマッピング"]||{};const priceDetail={};const displayNameMap={priceDetail:"費用",periods:"目安期間",ranges:"矯正範囲",hours:"営業時間",stores:"店舗",officialSite:"公式サイト"};Object.entries(fieldMapping).forEach(([displayKey,csvKey])=>{const japaneseKey=displayNameMap[displayKey]||displayKey;let detailValue;if(csvKey==="公式サイトURL"){detailValue=this.getClinicText(clinicCode,csvKey,"")}else{detailValue=this.getClinicText(clinicCode,`詳細_${csvKey}`,"")}priceDetail[japaneseKey]=detailValue});const detailData={title:this.getClinicText(clinicCode,"詳細タイトル","医療痩せプログラム"),subtitle:this.getClinicText(clinicCode,"詳細サブタイトル","効果的な痩身治療"),link:`${clinicName} ＞`,banner:this.getClinicText(clinicCode,"詳細バナー画像パス",(()=>{const bannerFolder=clinicCode==="kireiline"?"kireiline":clinicCode;return`/common_data/images/clinics/${bannerFolder}/${bannerFolder}_detail_bnr.webp`})()),features:(()=>{const tagsText=this.getClinicText(clinicCode,"詳細_特徴タグ","# 医療ダイエット<br># 医療痩身<br># リバウンド防止");return tagsText.split("<br>").map(tag=>tag.replace(/^#\s*/,"").trim()).filter(tag=>tag)})(),priceMain:this.getClinicText(clinicCode,"人気プラン","医療痩身コース"),priceValue:(()=>{const ryokin=this.getClinicText(clinicCode,"料金","月々4,900円");const match=ryokin.match(/月々[\d,]+円/);return match?match[0]:"月々4,900円"})(),priceDetail:priceDetail,points:[{icon:"lightbulb",title:this.getClinicText(clinicCode,"POINT1タイトル","ポイント1"),description:this.getClinicText(clinicCode,"POINT1内容","詳細説明1")},{icon:"phone",title:this.getClinicText(clinicCode,"POINT2タイトル","ポイント2"),description:this.getClinicText(clinicCode,"POINT2内容","詳細説明2")},{icon:"coin",title:this.getClinicText(clinicCode,"POINT3タイトル","ポイント3"),description:this.getClinicText(clinicCode,"POINT3内容","詳細説明3")}]};return detailData}getCurrentClinic(){const urlParams=new URLSearchParams(window.location.search);const clinicParam=urlParams.get("clinic");if(clinicParam){return clinicParam}const currentRegionId=this.getCurrentRegionId();const ranking=this.getRankingByRegionId(currentRegionId);if(ranking&&ranking.ranks&&ranking.ranks.no1){const topClinicId=ranking.ranks.no1;const clinicCode=this.getClinicCodeById(topClinicId);if(clinicCode)return clinicCode}const firstClinic=this.clinics&&this.clinics[0];return firstClinic?firstClinic.code:""}getCurrentRegionId(){const urlParams=new URLSearchParams(window.location.search);return urlParams.get("region_id")||"000"}mapRegionId(regionId){const paddedRegionId=String(regionId).padStart(3,"0");const unpaddedRegionId=String(parseInt(regionId,10));const existsInRegions=this.regions.find(r=>r.id===paddedRegionId||r.id===unpaddedRegionId||r.id===String(regionId));if(existsInRegions){const hasRanking=this.rankings.find(r=>r.regionId===paddedRegionId||r.regionId===unpaddedRegionId||r.regionId===String(regionId));if(hasRanking){return hasRanking.regionId}console.log(`Region ${regionId} exists but has no ranking data, will map to another region`)}if(regionId==="000"||regionId==="0"||String(regionId)==="0"){return"000"}const defaultRegionMapping={"001":"013"};const mapping=typeof window!=="undefined"&&window.regionMapping&&typeof window.regionMapping==="object"?window.regionMapping:defaultRegionMapping;if(mapping&&mapping[paddedRegionId]){console.log(`Region ${regionId} mapped to ${mapping[paddedRegionId]}`);return mapping[paddedRegionId]}console.warn(`Unknown region ID: ${regionId}, falling back to Tokyo (013)`);return"013"}getRankingByRegionId(regionId){const mappedRegionId=this.mapRegionId(regionId);let targetRegionId=mappedRegionId;const paddedRegionId=String(targetRegionId).padStart(3,"0");let ranking=this.rankings.find(r=>r.regionId===paddedRegionId);if(!ranking){ranking=this.rankings.find(r=>r.regionId===String(targetRegionId))}if(!ranking){console.warn(`⚠️ region_id ${regionId} (mapped to ${targetRegionId}) のランキングが見つかりません。東京（013）にフォールバックします。`);ranking=this.rankings.find(r=>r.regionId==="013")}return ranking}getStoresByRegionId(regionId){const mappedRegionId=this.mapRegionId(regionId);let storeView=this.storeViews.find(sv=>sv.regionId===mappedRegionId);if(!storeView){const normalizedRegionId=String(parseInt(mappedRegionId,10));storeView=this.storeViews.find(sv=>sv.regionId===normalizedRegionId)}if(!storeView){console.warn(`⚠️ region_id ${regionId} (mapped to ${mappedRegionId}) の店舗ビューが見つかりません。`);return[]}const ranking=this.getRankingByRegionId(regionId);if(!ranking){console.warn(`⚠️ region_id ${regionId} のランキングが見つかりません。`);return[]}const storeIdsToShow=[];Object.entries(ranking.ranks).forEach(([position,clinicId])=>{const clinic=this.clinics.find(c=>c.id===clinicId);if(!clinic){console.warn(`  ⚠️ Clinic not found for ID: ${clinicId}`);return}const clinicKey=`${clinic.code}_stores`;if(storeView.clinicStores[clinicKey]){storeIdsToShow.push(...storeView.clinicStores[clinicKey])}else{}});const allStoreIds=[];storeIdsToShow.forEach(storeId=>{if(storeId.includes("/")){const ids=storeId.split("/");allStoreIds.push(...ids)}else{allStoreIds.push(storeId)}});const result=this.stores.filter(store=>allStoreIds.includes(store.id));return result}getStoresByClinicName(clinicName){return this.stores.filter(s=>s.clinicName===clinicName)}getStoresByRegionAndClinic(regionId,clinicName){return this.stores.filter(s=>s.regionId===regionId&&s.clinicName===clinicName)}getCampaignsByRegionId(regionId){return this.campaigns.filter(c=>c.regionId===regionId)}getCampaignByRegionAndClinic(regionId,clinicId){return this.campaigns.find(c=>c.regionId===regionId&&c.clinicId===clinicId)}}class RankingApp{constructor(){this.urlHandler=new UrlParamHandler;this.displayManager=new DisplayManager(this.urlHandler);this.dataManager=null;this.currentRegionId=null;this.textsInitialized=false}normalizeRegionId(regionId){if(regionId===undefined||regionId===null)return"";const raw=String(regionId).trim();if(!raw)return"";if(/^\d+$/.test(raw)){const num=parseInt(raw,10);if(Number.isNaN(num))return"";return num.toString().padStart(3,"0")}return raw}isNationalRegion(regionId,region=null){const normalized=this.normalizeRegionId(regionId??region?.id);if(normalized==="000")return true;const regionName=region&&region.name?String(region.name).trim():"";return regionName==="全国"}applyRegionLabels(region,options={}){if(!region&&options.regionId===undefined&&this.currentRegionId===null){return}const regionIdRaw=options.regionId!==undefined?options.regionId:region?.id??this.currentRegionId;const normalizedId=this.normalizeRegionId(regionIdRaw);const regionName=region&&region.name?region.name:"";const isNational=this.isNationalRegion(normalizedId,region);const mvRegionElement=document.getElementById("mv-region-name");if(mvRegionElement){mvRegionElement.textContent=isNational?"最新":regionName}const detailRegionElement=document.getElementById("detail-region-name");if(detailRegionElement){if(isNational){detailRegionElement.textContent="[最新版] 人気のクリニック";detailRegionElement.style.left="3%"}else{detailRegionElement.textContent=`${regionName}で人気のクリニック`;const nameLength=regionName.length;let leftPosition="3%";if(nameLength===2){leftPosition="4%"}else if(nameLength===3){leftPosition="1%"}detailRegionElement.style.left=leftPosition}}const comparisonRegionElement=document.getElementById("comparison-region-name");if(comparisonRegionElement){if(isNational){comparisonRegionElement.textContent="";comparisonRegionElement.style.display="none"}else{comparisonRegionElement.textContent=regionName;comparisonRegionElement.style.removeProperty("display")}}const rankRegionElement=document.getElementById("rank-region-name");if(rankRegionElement){const baseText=this.dataManager&&typeof this.dataManager.getCommonText==="function"?this.dataManager.getCommonText("ランキング地域名テキスト","で人気の脂肪溶解注射はココ！"):"で人気の脂肪溶解注射はココ！";if(isNational){const suffix=baseText.replace(/^で/,"");rankRegionElement.textContent=`いま${suffix}`;rankRegionElement.style.left="52%"}else{rankRegionElement.textContent=`${regionName}${baseText}`;const nameLength=regionName.length;let leftPosition="52%";if(nameLength===3){leftPosition="51%"}else if(nameLength>=4){leftPosition="50%"}rankRegionElement.style.left=leftPosition}}}async init(){try{this.dataManager=new DataManager;await this.dataManager.init();window.dataManager=this.dataManager;window.urlHandler=this.urlHandler;this.currentRegionId=this.urlHandler.getRegionId();const regions=this.dataManager.getAllRegions();this.displayManager.updateRegionSelector(regions,this.currentRegionId);this.setupEventListeners();this.updatePageContent(this.currentRegionId);try{if(typeof window.__renderPrLine==="function")window.__renderPrLine()}catch(_){}setTimeout(()=>{this.setupMapAccordions()},100)}catch(error){this.displayManager.showError("データの読み込みに失敗しました。ページを再読み込みしてください。")}}setupEventListeners(){if(this.displayManager.regionSelect){this.displayManager.regionSelect.addEventListener("change",()=>{this.handleClinicSearch(this.displayManager.searchInput?.value||"")})}if(this.displayManager.searchInput){this.displayManager.searchInput.addEventListener("input",e=>{this.handleClinicSearch(e.target.value)})}const specialtyFilter=document.getElementById("sidebar-specialty-filter");if(specialtyFilter){specialtyFilter.addEventListener("change",()=>{this.handleClinicSearch(this.displayManager.searchInput?.value||"")})}const hoursFilter=document.getElementById("sidebar-hours-filter");if(hoursFilter){hoursFilter.addEventListener("change",()=>{this.handleClinicSearch(this.displayManager.searchInput?.value||"")})}const sidebarSearchButton=document.querySelector(".sidebar-search-link");if(sidebarSearchButton){sidebarSearchButton.addEventListener("click",e=>{e.preventDefault();const params=new URLSearchParams;const regionFilter=document.getElementById("sidebar-region-select");if(regionFilter&&regionFilter.value){params.append("search-region",regionFilter.value)}const clinicSearch=document.getElementById("sidebar-clinic-search");if(clinicSearch&&clinicSearch.value){params.append("clinic",clinicSearch.value)}const specialtyFilter=document.getElementById("sidebar-specialty-filter");if(specialtyFilter&&specialtyFilter.value){params.append("bodyPart",specialtyFilter.value)}const hoursFilter=document.getElementById("sidebar-hours-filter");if(hoursFilter&&hoursFilter.value){params.append("storeCount",hoursFilter.value)}params.append("region_id",this.currentRegionId);const basePath=window.SITE_CONFIG?window.SITE_CONFIG.basePath:"";const prefix=basePath||".";const searchUrl=`${prefix}/search-results.html?${params.toString()}`;window.location.href=searchUrl})}if(this.displayManager.hamburgerMenu){this.displayManager.hamburgerMenu.addEventListener("click",e=>{e.stopPropagation();this.displayManager.hamburgerMenu.classList.toggle("active");this.displayManager.sidebarMenu.classList.toggle("active");this.displayManager.sidebarOverlay.classList.toggle("active")})}else{}if(this.displayManager.closeSidebar){this.displayManager.closeSidebar.addEventListener("click",()=>{this.displayManager.hamburgerMenu.classList.remove("active");this.displayManager.sidebarMenu.classList.remove("active");this.displayManager.sidebarOverlay.classList.remove("active")})}if(this.displayManager.sidebarOverlay){this.displayManager.sidebarOverlay.addEventListener("click",()=>{this.displayManager.hamburgerMenu.classList.remove("active");this.displayManager.sidebarMenu.classList.remove("active");this.displayManager.sidebarOverlay.classList.remove("active")})}}changeRegion(regionId){this.currentRegionId=regionId;this.updatePageContent(regionId)}getClinicStoresByRegion(clinicName,regionId){const normalizedClinicName=clinicName.replace(/の\d+$/,"").trim();const regionStores=this.dataManager.getStoresByRegionId(regionId);const storeClinicName=normalizedClinicName;return regionStores.filter(store=>store.clinicName===storeClinicName)}handleClinicSearch(searchTerm){const searchTermLower=searchTerm.toLowerCase().trim();const regionFilter=document.getElementById("sidebar-region-select")?.value||"";const specialtyFilter=document.getElementById("sidebar-specialty-filter")?.value||"";const hoursFilter=document.getElementById("sidebar-hours-filter")?.value||"";const rankingItems=document.querySelectorAll(".ranking-item");let visibleRankingCount=0;rankingItems.forEach(item=>{const clinicNameElement=item.querySelector(".clinic-logo-section");const clinicName=clinicNameElement?clinicNameElement.textContent.trim():"";const nameMatch=searchTermLower===""||clinicName.toLowerCase().includes(searchTermLower);let regionMatch=true;if(regionFilter){const clinicStores=this.getClinicStoresByRegion(clinicName,regionFilter);regionMatch=clinicStores.length>0}const specialtyMatch=specialtyFilter==="";const hoursMatch=hoursFilter==="";if(nameMatch&&regionMatch&&specialtyMatch&&hoursMatch){item.style.display="";visibleRankingCount++}else{item.style.display="none"}});const allTableRows=document.querySelectorAll("#ranking-tbody tr, #treatment-tbody tr, #service-tbody tr");let visibleRowCount=0;allTableRows.forEach(row=>{const clinicName=row.querySelector(".clinic-main-name")?.textContent||"";const nameMatch=searchTermLower===""||clinicName.toLowerCase().includes(searchTermLower);let regionMatch=true;if(regionFilter){const clinicStores=this.getClinicStoresByRegion(clinicName,regionFilter);regionMatch=clinicStores.length>0}if(nameMatch&&regionMatch){row.style.display="";visibleRowCount++}else{row.style.display="none"}});const detailItems=document.querySelectorAll(".detail-item");detailItems.forEach(item=>{const clinicName=item.querySelector(".clinic-name")?.textContent||"";const nameMatch=searchTermLower===""||clinicName.toLowerCase().includes(searchTermLower);let regionMatch=true;if(regionFilter){const clinicStores=this.getClinicStoresByRegion(clinicName,regionFilter);regionMatch=clinicStores.length>0}if(nameMatch&&regionMatch){item.style.display=""}else{item.style.display="none"}});const rankingList=document.getElementById("ranking-list");const existingMsg=document.getElementById("no-search-results");if(visibleRankingCount===0&&searchTermLower!==""){if(!existingMsg){const noResultsMsg=document.createElement("div");noResultsMsg.id="no-search-results";noResultsMsg.className="empty-state";noResultsMsg.innerHTML="<p>「"+searchTerm+"」に一致するクリニックが見つかりませんでした</p>";rankingList.appendChild(noResultsMsg)}}else if(existingMsg){existingMsg.remove()}const activeTabContent=document.querySelector(".tab-content.active tbody");const existingTableMsg=document.getElementById("no-search-results-row");if(visibleRowCount===0&&searchTermLower!==""&&activeTabContent){if(!existingTableMsg){const noResultsRow=document.createElement("tr");noResultsRow.id="no-search-results-row";noResultsRow.innerHTML='<td colspan="5" class="empty-state"><p>検索結果が見つかりませんでした</p></td>';activeTabContent.appendChild(noResultsRow)}}else if(existingTableMsg){existingTableMsg.remove()}}updatePageContent(regionId){try{const normalizedRegionId=String(parseInt(regionId,10));const mappedRegionId=this.dataManager.mapRegionId(regionId);let region;if(regionId==="000"||regionId==="0"||String(regionId)==="0"){region={id:"000",name:"全国",parentId:null};console.log("Created 全国 region object:",region)}else{region=this.dataManager.getRegionById(String(parseInt(mappedRegionId,10)));if(!region){console.warn(`Region not found for mapped ID: ${mappedRegionId}, falling back to Tokyo`);region=this.dataManager.getRegionById("13")}}this.displayManager.updateSelectedRegionName(region.name);const mvRegionTextElement=document.getElementById("mv-region-text");if(mvRegionTextElement){mvRegionTextElement.textContent=region.name}this.applyRegionLabels(region,{regionId:regionId});if(!this.textsInitialized){setTimeout(()=>{this.updateAllTexts(regionId);this.textsInitialized=true;setTimeout(()=>{this.forceUpdateRegionNames(region)},50)},100)}else{this.updateAllTexts(regionId);setTimeout(()=>{this.forceUpdateRegionNames(region)},50)}this.applyRegionLabels(region,{regionId:regionId});const rankingBannerImages=document.querySelectorAll(".ranking-banner-image");if(rankingBannerImages.length>0){const altText=this.dataManager.getCommonText("ランキングバナーAltテキスト","で人気の脂肪溶解注射はココ！");rankingBannerImages.forEach(img=>{img.alt=region.name+altText})}const ranking=this.dataManager.getRankingByRegionId(regionId);const allClinics=this.dataManager.getAllClinics();this.displayManager.updateRankingDisplay(allClinics,ranking);this.displayManager.updateFooterClinics(allClinics,ranking);this.updateComparisonHeaders();this.updateComparisonTable(allClinics,ranking);this.setupComparisonTabs();this.updateClinicDetails(allClinics,ranking,normalizedRegionId);setTimeout(()=>{try{initializeBannerSliders()}catch(_){}},0);setTimeout(()=>{initializeDisclaimers()},100);setTimeout(()=>{this.setupMapAccordions()},100);this.displayManager.hideError()}catch(error){console.error("Error in updatePageContent:",error);this.displayManager.showError("データの表示に問題が発生しました。");if(regionId!=="000"){this.changeRegion("000")}}}restoreRegionNames(region){this.applyRegionLabels(region,{regionId:region?.id??this.currentRegionId})}forceUpdateRegionNames(region){this.applyRegionLabels(region,{regionId:region?.id??this.currentRegionId})}updateAllTexts(regionId){try{const currentClinic=this.dataManager.getCurrentClinic();const mappedRegionIdRaw=this.dataManager.mapRegionId(regionId);const normalizedMappedRegionId=this.normalizeRegionId(mappedRegionIdRaw??regionId);let regionForDisplay=null;if(normalizedMappedRegionId==="000"){regionForDisplay={id:"000",name:"全国"}}else{const regionCandidate=this.dataManager.getRegionById(String(parseInt(normalizedMappedRegionId||"0",10)));if(regionCandidate){regionForDisplay={id:this.normalizeRegionId(regionCandidate.id),name:regionCandidate.name}}}if(!regionForDisplay){regionForDisplay={id:normalizedMappedRegionId||"",name:""}}const isNational=this.isNationalRegion(regionId,regionForDisplay);const metaDesc=document.querySelector('meta[name="description"]');if(metaDesc){const metaDescText=this.dataManager.getClinicText(currentClinic,"メタディスクリプション","あなたの地域の優良クリニックを探そう。");metaDesc.setAttribute("content",metaDescText)}const siteLogo=document.querySelector(".site-logo");if(siteLogo){const logoText=this.dataManager.getCommonText("サイト名","医療ダイエット比較.com");siteLogo.textContent=logoText}else{console.warn("⚠️ サイトロゴ要素が見つかりません")}const appealText1Element=document.getElementById("mv-left-appeal-text");if(appealText1Element){const text1=this.dataManager.getCommonText("MVアピールテキスト1","コスパ");appealText1Element.textContent=text1}const svgText1Element=document.querySelector("#mv-main-svg-text text");if(svgText1Element){const svgText1=this.dataManager.getCommonText("MVSVGテキスト1","脂肪溶解注射");svgText1Element.textContent=svgText1}const svgText2Element=document.querySelector("#mv-appeal1-text text");if(svgText2Element){const normalizedRegionId=String(parseInt(regionId,10));const ranking=this.dataManager.getRankingByRegionId(normalizedRegionId);let rankCount=5;if(ranking&&ranking.ranks){const validRanks=Object.entries(ranking.ranks).filter(([key,value])=>value!=="-"&&value!==null&&value!==undefined).length;if(validRanks>0){rankCount=Math.min(validRanks,5)}}const svgText2=this.dataManager.getCommonText("MVSVGテキスト2","ランキング",{RANK_COUNT:rankCount});svgText2Element.textContent=svgText2;const detailRankBestElement=document.getElementById("detail-rank-best");if(detailRankBestElement){detailRankBestElement.innerHTML=`${rankCount}<span style="font-size: 0.6em;"> 選！</span>`}}const rankingBanner=document.querySelector(".ranking-banner-image");if(rankingBanner){const rankingAlt=this.dataManager.getCommonText("ランキングバナーalt","で人気の脂肪溶解注射はここ！");rankingBanner.setAttribute("alt",rankingAlt)}const comparisonTitle=document.querySelector(".comparison-title");if(comparisonTitle){const baseTitleText=this.dataManager.getCommonText("比較表タイトル","で人気の脂肪溶解注射");const adjustedTitleText=isNational?baseTitleText.replace(/^で/,""):baseTitleText;const spanStyle=isNational?' style="display:none;"':"";const spanText=isNational?"":regionForDisplay?.name||"";comparisonTitle.innerHTML=`<span id="comparison-region-name"${spanStyle}>${spanText}</span>${adjustedTitleText}`}const comparisonSubtitle=document.querySelector(".comparison-subtitle");if(comparisonSubtitle){const subtitleHtml=this.dataManager.getCommonText("比較表サブタイトル",'クリニックを<span class="pink-text">徹底比較</span>');comparisonSubtitle.innerHTML=this.dataManager.processDecoTags(subtitleHtml)}this.applyRegionLabels(regionForDisplay,{regionId:regionId});const detailsBannerImg=document.querySelector(".details-banner-image");if(detailsBannerImg){const detailsBannerAlt=this.dataManager.getCommonText("案件詳細バナーalt","コスパ×効果×通いやすさで選ぶ脂肪冷却BEST3");detailsBannerImg.setAttribute("alt",detailsBannerAlt)}const footerSiteName=document.querySelector(".footer_contents h4 a");if(footerSiteName){const footerText=this.dataManager.getCommonText("サイト名","医療ダイエット比較.com");footerSiteName.textContent=footerText}const footerCopyright=document.querySelector(".copyright");if(footerCopyright){const siteName=this.dataManager.getCommonText("サイト名","医療ダイエット比較.com");const copyrightText="© 2025 "+siteName;footerCopyright.textContent=copyrightText}const tabTexts=document.querySelectorAll(".tips-container .tab-text");if(tabTexts.length>=3){tabTexts[0].textContent=this.dataManager.getCommonText("Tipsタブ1タイトル","効果");tabTexts[1].textContent=this.dataManager.getCommonText("Tipsタブ2タイトル","選び方");tabTexts[2].textContent=this.dataManager.getCommonText("Tipsタブ3タイトル","おすすめ")}const tabContents=document.querySelectorAll(".tips-container .tab-content");if(tabContents.length>=3){const tips1P=tabContents[0].querySelector("p");if(tips1P){const tips1Content=this.dataManager.getCommonText("Tips1内容","");tips1P.innerHTML=this.dataManager.processDecoTags(tips1Content)}const tips2P=tabContents[1].querySelector("p");if(tips2P){const tips2Content=this.dataManager.getCommonText("Tips2内容","");tips2P.innerHTML=this.dataManager.processDecoTags(tips2Content)}const tips3P=tabContents[2].querySelector("p");if(tips3P){const tips3Content=this.dataManager.getCommonText("Tips3内容","");tips3P.innerHTML=this.dataManager.processDecoTags(tips3Content)}}const disclaimerHTML=this.dataManager.getCommonText("注意事項HTML","");if(disclaimerHTML){const disclaimerAccordion=document.querySelector(".disclaimer-accordion");if(disclaimerAccordion){const existingMainDisclaimer=disclaimerAccordion.querySelector(".main-disclaimer");if(existingMainDisclaimer){}}}}catch(error){console.error("❌ updateAllTextsでエラーが発生:",error)}}groupStoresByClinics(stores,ranking,allClinics){const clinicsWithStores=new Map;if(!ranking||!stores||stores.length===0){return clinicsWithStores}const sortedRanks=Object.entries(ranking.ranks).sort((a,b)=>{const numA=parseInt(a[0].replace("no",""));const numB=parseInt(b[0].replace("no",""));return numA-numB});sortedRanks.forEach(([position,clinicId])=>{const clinic=allClinics.find(c=>c.id===clinicId);if(clinic){const storeClinicName=clinic.name;const clinicStores=stores.filter(store=>store.clinicName===storeClinicName);clinicsWithStores.set(clinic,clinicStores)}});return clinicsWithStores}updateComparisonHeaders(){const headerRow=document.getElementById("comparison-header-row");if(!headerRow)return;headerRow.innerHTML="";const headerConfig=this.dataManager.clinicTexts["比較表ヘッダー設定"]||{};const headers=[{key:null,default:"",class:"",fixed:true},{key:"比較表ヘッダー1",default:"",class:""},{key:"比較表ヘッダー2",default:"",class:""},{key:"比較表ヘッダー3",default:"",class:""},{key:"比較表ヘッダー10",default:"",class:""},{key:"比較表ヘッダー4",default:"",class:"th-none",style:"display: none;"},{key:"比較表ヘッダー5",default:"",class:"th-none",style:"display: none;"},{key:"比較表ヘッダー6",default:"",class:"th-none",style:"display: none;"},{key:"比較表ヘッダー7",default:"",class:"th-none",style:"display: none;"},{key:"比較表ヘッダー8",default:"",class:"th-none",style:"display: none;"},{key:"比較表ヘッダー9",default:"",class:"th-none",style:"display: none;"},{key:null,default:"",class:"th-none",style:"display: none;",fixed:true}];headers.forEach(header=>{const th=document.createElement("th");if(header.fixed){th.textContent=header.default}else{th.textContent=headerConfig[header.key]||header.default}if(header.class)th.className=header.class;if(header.style)th.setAttribute("style",header.style);headerRow.appendChild(th)})}createTabButtons(){return}setupComparisonTabs(){const tabItems=document.querySelectorAll(".comparison-tab-menu-item");if(!tabItems||tabItems.length===0){return}const tabFieldMappings={tab1:["クリニック名","comparison1","comparison2","comparison3","公式サイト"],tab2:["クリニック名","comparison4","comparison5","comparison6","公式サイト"],tab3:["クリニック名","comparison7","comparison8","comparison9","公式サイト"]};tabItems.forEach(tabItem=>{const newTabItem=tabItem.cloneNode(true);tabItem.parentNode.replaceChild(newTabItem,tabItem);newTabItem.addEventListener("click",e=>{e.preventDefault();document.querySelectorAll(".comparison-tab-menu-item").forEach(item=>{item.classList.remove("tab-active")});newTabItem.classList.add("tab-active");const targetTab=newTabItem.getAttribute("data-tab");this.regenerateTableForTab(targetTab,tabFieldMappings[targetTab]||tabFieldMappings["tab1"])})});this.regenerateTableForTab("tab1",tabFieldMappings["tab1"])}regenerateTableForTab(tabId,fieldNames){const tbody=document.getElementById("comparison-tbody");const headerRow=document.getElementById("comparison-header-row");if(!tbody||!fieldNames)return;const fieldToHeaderMapping={comparison1:"比較表ヘッダー1",comparison2:"比較表ヘッダー2",comparison3:"比較表ヘッダー3",comparison4:"比較表ヘッダー4",comparison5:"比較表ヘッダー5",comparison6:"比較表ヘッダー6",comparison7:"比較表ヘッダー7",comparison8:"比較表ヘッダー8",comparison9:"比較表ヘッダー9"};if(headerRow){headerRow.innerHTML="";const headerConfig=this.dataManager.clinicTexts["比較表ヘッダー設定"]||{};fieldNames.forEach(fieldName=>{const th=document.createElement("th");if(fieldName==="クリニック名"){th.textContent="クリニック"}else if(fieldName==="公式サイト"){th.textContent="公式サイト"}else if(fieldToHeaderMapping[fieldName]){const headerKey=fieldToHeaderMapping[fieldName];th.textContent=headerConfig[headerKey]||fieldName}else{th.textContent=fieldName}headerRow.appendChild(th)})}tbody.innerHTML="";const currentClinics=this.getCurrentDisplayedClinics();currentClinics.forEach((clinic,index)=>{const tr=document.createElement("tr");if(index===0){tr.style.backgroundColor="#fffbdc"}else if(index===2||index===4){tr.style.backgroundColor="rgb(249 249 249)"}const rankNum=clinic.rank||index+1;const clinicId=clinic.id;const regionId=this.currentRegionId||"000";const clinicCode=clinic.code;fieldNames.forEach(fieldName=>{const td=document.createElement("td");if(fieldName==="クリニック名"){const imagesPath=window.SITE_CONFIG?window.SITE_CONFIG.imagesPath+"/images":"/images";let logoPath=this.dataManager.getClinicText(clinicCode,"クリニックロゴ画像パス","");if(!logoPath){const logoFolder=clinicCode;logoPath=`/common_data/images/clinics/${logoFolder}/${logoFolder}-logo.webp`;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"){}}const redirectUrl=`./redirect.html#clinic_id=${clinicId}&rank=${rankNum}&region_id=${regionId}`;const clinicNameOnclick=`onclick="localStorage.setItem('redirectParams', JSON.stringify({clinic_id: '${clinicId}', rank: '${rankNum}', region_id: '${regionId}'})); setTimeout(() => { window.open('${redirectUrl}', '_blank'); }, 10); return false;"`;td.className="ranking-table_td1";td.innerHTML=`\n                        <img src="${logoPath}" alt="${clinic.name}" width="80" data-rank="${rankNum}" class="comparison-logo">\n                        <a href="#" ${clinicNameOnclick} class="clinic-link" style="cursor: pointer;">${clinic.name}</a>\n                    `}else if(fieldName==="comparison1"){const rating=this.dataManager.getClinicText(clinicCode,"comparison1","4.5");td.innerHTML=`\n                        <span class="ranking_evaluation">${rating}</span><br>\n                        <span class="star5_rating" data-rate="${rating}"></span>\n                    `}else if(fieldName==="公式サイト"){td.innerHTML=`\n                        <a class="link_btn" href="${this.urlHandler.getClinicUrlWithRegionId(clinic.id,clinic.rank||rankNum)}" target="_blank">公式サイト &gt;</a><br>\n                        <a class="detail_btn" href="#clinic${rankNum}">詳細をみる</a>\n                    `}else if(fieldName.startsWith("comparison")){const cellData=this.dataManager.getClinicText(clinicCode,fieldName,"");if(cellData){td.innerHTML=this.dataManager.processDecoTags(cellData)}else{td.innerHTML="";console.log(`警告: ${clinicCode}の${fieldName}フィールドが空です`)}}else{const cellData=this.dataManager.getClinicText(clinicCode,fieldName,"");td.innerHTML=this.dataManager.processDecoTags(cellData||"")}tr.appendChild(td)});tbody.appendChild(tr)});this.initializeStarRatings();this.setupDetailScrollLinks()}getCurrentDisplayedClinics(){if(this.dataManager&&this.currentRegionId!==undefined){const ranking=this.dataManager.getRankingByRegionId(this.currentRegionId);const clinics=this.dataManager.clinics||[];if(ranking&&ranking.ranks){const rankedClinics=[];["no1","no2","no3","no4","no5"].forEach((position,index)=>{const clinicId=ranking.ranks[position];if(clinicId&&clinicId!=="-"){const numericClinicId=parseInt(clinicId);const clinic=clinics.find(c=>c.id==clinicId||c.id===numericClinicId);if(clinic){rankedClinics.push({...clinic,rank:index+1})}}});if(rankedClinics.length>0){return rankedClinics}}}return this.getLatestRankingData()}getLatestRankingData(){console.warn("フォールバックデータが使用されています。実際のランキングデータが取得できませんでした。");if(window.dataManager&&window.dataManager.clinics){const validClinics=window.dataManager.clinics.filter(clinic=>{const validIds=["1","2","3","4","5"];return validIds.includes(clinic.id)});return validClinics.slice(0,5).map((clinic,index)=>({...clinic,rank:index+1}))}}initializeStarRatings(){const starElements=document.querySelectorAll(".star5_rating[data-rate]");starElements.forEach(element=>{const rate=parseFloat(element.getAttribute("data-rate"))})}updateTableColumns(table,visibleColumns){if(!table)return;const headerRow=table.querySelector("thead tr");if(headerRow){const headerCells=headerRow.querySelectorAll("th");headerCells.forEach((cell,index)=>{if(visibleColumns.includes(index)){cell.style.display="";cell.classList.remove("th-none")}else{cell.style.display="none";cell.classList.add("th-none")}})}const bodyRows=table.querySelectorAll("tbody tr");bodyRows.forEach(row=>{const cells=row.querySelectorAll("td");cells.forEach((cell,index)=>{if(visibleColumns.includes(index)){cell.style.display="";cell.classList.remove("th-none")}else{cell.style.display="none";cell.classList.add("th-none")}})})}updateComparisonTable(clinics,ranking){if(!ranking||Object.keys(ranking.ranks).length===0){return}const rankedClinics=[];["no1","no2","no3","no4","no5"].forEach((position,index)=>{const clinicId=ranking.ranks[position];if(clinicId&&clinicId!=="-"){const numericClinicId=parseInt(clinicId);const clinic=clinics.find(c=>c.id==clinicId||c.id===numericClinicId);if(clinic){rankedClinics.push({...clinic,rank:index+1})}}});this.setupComparisonTabs();const displayedClinics=this.getCurrentDisplayedClinics();if(displayedClinics&&displayedClinics.length>0){this.updateFirstChoiceRecommendation(displayedClinics[0])}this.setupReviewTabs();this.setupDetailScrollLinks()}generateComparisonTable(clinics){const tbody=document.getElementById("comparison-tbody");if(!tbody)return;tbody.innerHTML="";const headerConfig=this.dataManager.clinicTexts["比較表ヘッダー設定"]||{};const field2=headerConfig["比較表ヘッダー2"]||"コスト";const field3=headerConfig["比較表ヘッダー3"]||"人気";clinics.forEach((clinic,index)=>{const tr=document.createElement("tr");if(index===0){tr.style.backgroundColor="#fffbdc"}else if(index===2||index===4){tr.style.backgroundColor="rgb(249 249 249)"}const rankNum=clinic.rank||index+1;const clinicId=clinic.id;const regionId=this.currentRegionId||"000";const clinicCode=clinic.code;const getClinicData=(fieldName,defaultValue="")=>this.dataManager.getClinicText(clinicCode,fieldName,defaultValue);const imagesPath=window.SITE_CONFIG?window.SITE_CONFIG.imagesPath+"/images":"/images";let logoPath=getClinicData("meta13","")||getClinicData("クリニックロゴ画像パス","");if(!logoPath){const logoFolder=clinicCode;logoPath=`/common_data/images/clinics/${logoFolder}/${logoFolder}-logo.webp`}const redirectUrl=`./redirect.html#clinic_id=${clinicId}&rank=${rankNum}&region_id=${regionId}`;const clinicNameOnclick=`onclick="localStorage.setItem('redirectParams', JSON.stringify({clinic_id: '${clinicId}', rank: '${rankNum}', region_id: '${regionId}'})); setTimeout(() => { window.open('${redirectUrl}', '_blank'); }, 10); return false;"`;tr.innerHTML=`\n                <td class="ranking-table_td1">\n                    <img src="${logoPath}" alt="${clinic.name}" width="80">\n                    <a href="#" ${clinicNameOnclick} class="clinic-link" style="cursor: pointer;">${clinic.name}</a>\n                </td>\n                <td class="" style="">\n                    <span class="ranking_evaluation">${getClinicData("総合評価","4.5")}</span><br>\n                    <span class="star5_rating" data-rate="${getClinicData("総合評価","4.5")}"></span>\n                </td>\n                <td class="" style="">${this.dataManager.processDecoTags(getClinicData(field2,""))}</td>\n                <td class="" style="">${this.dataManager.processDecoTags(getClinicData(field3,""))}</td>\n                <td>\n                    <a class="link_btn" href="${this.urlHandler.getClinicUrlWithRegionId(clinic.id,clinic.rank||rankNum)}" target="_blank">公式サイト &gt;</a><br>\n                    <a class="detail_btn" href="#clinic${rankNum}">詳細をみる</a>\n                </td>\n                <td class="th-none" style="display: none;">${this.dataManager.processDecoTags(getClinicData("",""))}</td>\n                <td class="th-none" style="display: none;">${this.dataManager.processDecoTags(getClinicData("",""))}</td>\n                <td class="th-none" style="display: none;">${this.dataManager.processDecoTags(getClinicData("",""))}</td>\n                <td class="th-none" style="display: none;">${this.dataManager.processDecoTags(getClinicData("",""))}</td>\n                <td class="th-none" style="display: none;">${this.dataManager.processDecoTags(getClinicData("",""))}</td>\n                <td class="th-none" style="display: none;">${this.dataManager.processDecoTags(getClinicData("",""))}</td>\n            `;tbody.appendChild(tr)})}updateComparisonDisclaimers(disclaimers){const disclaimerContent=document.getElementById("main-content");if(!disclaimerContent){console.error("main-content element not found");return}console.log("updateComparisonDisclaimers called with:",disclaimers);disclaimerContent.innerHTML="";if(!disclaimers||disclaimers.length===0){disclaimerContent.innerHTML='<p style="font-size: 11px; color: #666; padding: 10px;">注意事項はありません。</p>';return}disclaimers.forEach((item,index)=>{const disclaimerDiv=document.createElement("div");disclaimerDiv.style.cssText="margin-bottom: 15px; padding: 10px; border-left: 3px solid #6bd1d0;";const titleDiv=document.createElement("div");titleDiv.style.cssText="font-weight: 600; color: #333; margin-bottom: 5px; font-size: 12px;";titleDiv.textContent=`【${item.clinicName}】`;const textDiv=document.createElement("div");textDiv.style.cssText="font-size: 10px; line-height: 1.6; color: #666;";textDiv.innerHTML=item.text;disclaimerDiv.appendChild(titleDiv);disclaimerDiv.appendChild(textDiv);disclaimerContent.appendChild(disclaimerDiv)});console.log("Disclaimers added to DOM, child count:",disclaimerContent.children.length)}updateFirstChoiceRecommendation(topClinic){if(!topClinic)return;const clinicCode=window.dataManager.getClinicCodeById(topClinic.id);if(!clinicCode)return;const imagesPath=window.SITE_CONFIG?window.SITE_CONFIG.imagesPath+"/images":"/images";const clinicNameElements=["first-choice-clinic-name","first-choice-title-clinic-name"];clinicNameElements.forEach(id=>{const element=document.getElementById(id);if(element)element.textContent=topClinic.name});const bannerImage=document.getElementById("first-choice-banner-image");if(bannerImage){const csvBannerPath=window.dataManager.getClinicText(clinicCode,"詳細バナー画像パス","");const bannerPath=csvBannerPath||`/common_data/images/clinics/${clinicCode}/${clinicCode}_detail_bnr.webp`;const allBannerImages=document.querySelectorAll('img[src*="_detail_bnr"]');allBannerImages.forEach((img,index)=>{});bannerImage.src=bannerPath;bannerImage.alt=topClinic.name}const point1Title=document.getElementById("point1-title");const point1Desc=document.getElementById("point1-description");const point2Title=document.getElementById("point2-title");const point2Desc=document.getElementById("point2-description");const point3Title=document.getElementById("point3-title");const point3Desc=document.getElementById("point3-description");if(point1Title)point1Title.textContent=window.dataManager.getClinicText(clinicCode,"POINT1タイトル","");if(point1Desc)point1Desc.innerHTML=window.dataManager.getClinicText(clinicCode,"POINT1内容","");if(point2Title)point2Title.textContent=window.dataManager.getClinicText(clinicCode,"POINT2タイトル","");if(point2Desc)point2Desc.innerHTML=window.dataManager.getClinicText(clinicCode,"POINT2内容","");if(point3Title)point3Title.textContent=window.dataManager.getClinicText(clinicCode,"POINT3タイトル","");if(point3Desc)point3Desc.innerHTML=window.dataManager.getClinicText(clinicCode,"POINT3内容","");try{const iconElems=document.querySelectorAll("#first-choice-points .ribbon_point_title2_s i.point-icon-inline");const iconClasses=["fa-lightbulb","fa-mobile-alt","fa-yen-sign"];iconElems.forEach((el,idx)=>{el.classList.remove("fa-clock","fa-lightbulb","fa-mobile-alt","fa-yen-sign","fa-user-md","fa-coins");el.classList.add(iconClasses[idx]||"fa-clock")})}catch(_){}const infoLogo=document.getElementById("first-choice-info-logo");if(infoLogo){const logoFolder=clinicCode;const logoPath=window.dataManager.getClinicText(clinicCode,"meta13","")||window.dataManager.getClinicText(clinicCode,"クリニックロゴ画像パス","")||`/common_data/images/clinics/${logoFolder}/${logoFolder}-logo.webp`;infoLogo.src=logoPath;infoLogo.alt=topClinic.name}const campaignText=document.getElementById("first-choice-campaign-text");if(campaignText){const campaign=window.dataManager.getClinicText(clinicCode,"INFORMATIONキャンペーンテキスト","");campaignText.innerHTML=campaign}const achievementText=document.getElementById("first-choice-achievement-text");if(achievementText){const achievement=window.dataManager.getClinicText(clinicCode,"INFORMATIONサブテキスト","");achievementText.textContent=achievement}const ctaText=document.getElementById("first-choice-cta-text");if(ctaText){ctaText.textContent=`${topClinic.name}の公式サイト`}const ctaLink=document.getElementById("first-choice-cta-link");if(ctaLink){ctaLink.href=this.urlHandler.getClinicUrlWithRegionId(topClinic.id,topClinic.rank||1)}const officialLink=document.querySelector("#first-choice-official-link a");if(officialLink){officialLink.href=this.urlHandler.getClinicUrlWithRegionId(topClinic.id,topClinic.rank||1);const strongElement=officialLink.querySelector("strong");const officialUrl=window.dataManager.getClinicText(clinicCode,"公式サイトURL","#");if(strongElement){strongElement.textContent=officialUrl}else{officialLink.textContent=officialUrl}}const disclaimerTitle=document.getElementById("first-choice-disclaimer-title");if(disclaimerTitle){disclaimerTitle.textContent=`${topClinic.name}の確認事項`}const disclaimerContent=document.getElementById("dio-campaign-first-choice-content");if(disclaimerContent){const disclaimerText=window.dataManager.getClinicText(clinicCode,"INFORMATION確認事項","");if(disclaimerText){disclaimerContent.innerHTML=`<div style="font-size: 9px; color: #777; line-height: 1.4;">${disclaimerText}</div>`}}}getClinicDisplayName(clinic){return clinic.name}generateGeneralTab(clinics){const tbody=document.getElementById("general-tbody");tbody.innerHTML="";clinics.forEach((clinic,index)=>{const row=document.createElement("tr");const rankClass=clinic.rank===1?"":clinic.rank===2?"silver":"bronze";const ratings={1:4.9,2:4.5,3:4.3,4:4.1,5:3.8};row.innerHTML=`\n                <td>\n                    <div class="clinic-name-cell">\n                        <div class="rank-badge ${rankClass}">${clinic.rank}位</div>\n                        <div class="clinic-info">\n                            <div class="clinic-main-name">${this.getClinicDisplayName(clinic)}</div>\n                        </div>\n                    </div>\n                </td>\n                <td>\n                    <div class="rating-cell">${getRatingFromJson(clinic.rank)}</div>\n                    <div class="rating-stars">\n                        ${'<i class="fas fa-star"></i>'.repeat(Math.floor(getRatingFromJson(clinic.rank)))}\n                        ${getRatingFromJson(clinic.rank)%1?'<i class="fas fa-star-half-alt"></i>':""}\n                    </div>\n                </td>\n                <td class="achievement-text">${getAchievementFromJson(clinic.rank)}</td>\n                <td class="benefit-text">${getBenefitFromJson(clinic.rank)}</td>\n                <td>\n                    <div class="cta-cell">\n                        <a href="${this.urlHandler.getClinicUrlWithRegionId(clinic.id,clinic.rank)}" class="cta-button" target="_blank" rel="noopener">公式サイト</a>\n                        <a href="#clinic${clinic.rank}" class="cta-link detail-scroll-link" data-rank="${clinic.rank}">詳細を見る</a>\n                    </div>\n                </td>\n            `;tbody.appendChild(row)})}generateTreatmentTab(clinics){const tbody=document.getElementById("treatment-tbody");tbody.innerHTML="";clinics.forEach((clinic,index)=>{const row=document.createElement("tr");const rankClass=clinic.rank===1?"":clinic.rank===2?"silver":"bronze";row.innerHTML=`\n                <td>\n                    <div class="clinic-name-cell">\n                        <div class="rank-badge ${rankClass}">${clinic.rank}位</div>\n                        <div class="clinic-info">\n                            <div class="clinic-main-name">${this.getClinicDisplayName(clinic)}</div>\n                        </div>\n                    </div>\n                </td>\n                <td></td>\n                <td></td>\n                <td><i class="fas fa-circle feature-icon"></i></td>\n                <td>\n                    <div class="cta-cell">\n                        <a href="${this.urlHandler.getClinicUrlWithRegionId(clinic.id,clinic.rank)}" class="cta-button" target="_blank" rel="noopener">公式サイト</a>\n                        <a href="#clinic${clinic.rank}" class="cta-link detail-scroll-link" data-rank="${clinic.rank}">詳細を見る</a>\n                    </div>\n                </td>\n            `;tbody.appendChild(row)})}generateServiceTab(clinics){const tbody=document.getElementById("service-tbody");tbody.innerHTML="";clinics.forEach((clinic,index)=>{const row=document.createElement("tr");const rankClass=clinic.rank===1?"":clinic.rank===2?"silver":"bronze";row.innerHTML=`\n                <td>\n                    <div class="clinic-name-cell">\n                        <div class="rank-badge ${rankClass}">${clinic.rank}位</div>\n                        <div class="clinic-info">\n                            <div class="clinic-main-name">${this.getClinicDisplayName(clinic)}</div>\n                        </div>\n                    </div>\n                </td>\n                <td><i class="fas fa-circle feature-icon"></i></td>\n                <td>${clinic.rank<=3?'<i class="fas fa-circle feature-icon"></i>':'<i class="fas fa-triangle feature-icon triangle"></i>'}</td>\n                <td>${clinic.rank<=2?'<i class="fas fa-circle feature-icon"></i>':"-"}</td>\n                <td>\n                    <div class="cta-cell">\n                        <a href="${this.urlHandler.getClinicUrlWithRegionId(clinic.id,clinic.rank)}" class="cta-button" target="_blank" rel="noopener">公式サイト</a>\n                        <a href="#clinic${clinic.rank}" class="cta-link detail-scroll-link" data-rank="${clinic.rank}">詳細を見る</a>\n                    </div>\n                </td>\n            `;tbody.appendChild(row)})}setupTabSwitching(){const tabButtons=document.querySelectorAll(".tab-button");const tabContents=document.querySelectorAll(".tab-content");tabButtons.forEach(button=>{button.addEventListener("click",()=>{const targetTab=button.getAttribute("data-tab");tabButtons.forEach(btn=>btn.classList.remove("active"));tabContents.forEach(content=>content.classList.remove("active"));button.classList.add("active");document.getElementById(`${targetTab}-tab`).classList.add("active")})})}setupDetailScrollLinks(){setTimeout(()=>{const allLinks=document.querySelectorAll("a");const detailTextLinks=Array.from(allLinks).filter(link=>link.textContent.includes("詳細を見る")||link.textContent.includes("詳細をみる"));detailTextLinks.forEach((link,i)=>{});const dynamicLinks=document.querySelectorAll(".detail-scroll-link");dynamicLinks.forEach((link,index)=>{const hasExistingListener=link.hasAttribute("data-listener-attached");if(!hasExistingListener){link.setAttribute("data-listener-attached","true");link.addEventListener("click",e=>{e.preventDefault();e.stopPropagation();let rank=parseInt(link.getAttribute("data-rank"));if(!rank||Number.isNaN(rank)){const href=link.getAttribute("href")||"";const m=href.match(/#clinic(\d+)/);if(m)rank=parseInt(m[1],10)}if(rank&&!Number.isNaN(rank)){openClinicDetailModal(rank)}})}});const logoImgs=document.querySelectorAll("#comparison-table td.ranking-table_td1 img.comparison-logo");logoImgs.forEach(img=>{if(!img.hasAttribute("data-listener-attached")){img.setAttribute("data-listener-attached","true");img.style.cursor="pointer";img.addEventListener("click",e=>{e.preventDefault();e.stopPropagation();const rankAttr=img.getAttribute("data-rank");const rank=parseInt(rankAttr,10);if(rank&&!Number.isNaN(rank)){openClinicDetailModal(rank)}})}});const staticLinks=document.querySelectorAll(".detail-static-link");staticLinks.forEach((link,index)=>{link.addEventListener("click",e=>{e.preventDefault();let rank=parseInt(link.getAttribute("data-rank"));if(!rank||Number.isNaN(rank)){const href=link.getAttribute("href")||"";const m=href.match(/#clinic(\d+)/);if(m)rank=parseInt(m[1],10)}if(rank&&!Number.isNaN(rank)){openClinicDetailModal(rank)}})});const comparisonTable=document.getElementById("comparison-table");if(comparisonTable){const allTableLinks=comparisonTable.querySelectorAll("a");allTableLinks.forEach((link,i)=>{if(link.textContent.includes("詳細")){}})}},500)}scrollToClinicDetail(rank){if(rank&&!Number.isNaN(rank))openClinicDetailModal(rank)}setupReviewTabs(){document.addEventListener("click",e=>{const tabLi=e.target.closest(".review_tab2 li");if(tabLi){const reviewSection=tabLi.closest("#review_tab_box");if(reviewSection){const tabIndex=Array.from(tabLi.parentElement.children).indexOf(tabLi);reviewSection.querySelectorAll(".review_tab2 li").forEach((li,index)=>{li.classList.remove("select2");if(index===tabIndex){li.classList.add("select2")}});reviewSection.querySelectorAll(".wrap_long2").forEach((content,index)=>{content.classList.remove("active");content.classList.add("disnon2");if(index===tabIndex){content.classList.add("active");content.classList.remove("disnon2")}})}}})}updateClinicDetails(clinics,ranking,regionId){const detailsList=document.getElementById("clinic-details-list");if(!detailsList){return}detailsList.innerHTML="";this.updateComparisonTable(clinics,ranking);if(!ranking){return}if(!ranking.ranks){return}if(Object.keys(ranking.ranks).length===0){return}const sortedRanks=Object.entries(ranking.ranks).sort((a,b)=>{const numA=parseInt(a[0].replace("no",""));const numB=parseInt(b[0].replace("no",""));return numA-numB}).slice(0,5);sortedRanks.forEach(([position,clinicId])=>{const numericClinicId=parseInt(clinicId);const clinic=clinics.find(c=>c.id==clinicId||c.id===numericClinicId);if(!clinic){return}const rank=parseInt(position.replace("no",""));const clinicRank=Number(clinic.rank)||rank;const officialSiteUrl=this.urlHandler.getClinicUrlWithRegionId(clinic.id,clinicRank);const directFormUrl=this.urlHandler.getDirectFormUrl(clinic.id,clinicRank);const detailItem=document.createElement("div");detailItem.className=`detail-item ranking_box_inner ranking_box_${rank}`;detailItem.setAttribute("data-rank",rank);detailItem.setAttribute("data-clinic-id",clinicId);detailItem.id=`clinic${rank}`;let badgeClass="";if(rank===2)badgeClass="silver";else if(rank===3)badgeClass="bronze";else if(rank===4)badgeClass="ranking4";else if(rank===5)badgeClass="ranking5";const clinicCode=this.dataManager.getClinicCodeById(clinicId);const data=this.dataManager.getClinicDetailData(clinicId);if(!data){return}data.regionId=regionId;if(!data.banner){const clinicCode=this.dataManager.getClinicCodeById(clinicId);const bannerFolder=clinicCode==="kireiline"?"kireiline":clinicCode;data.banner=`/common_data/images/clinics/${bannerFolder}/${bannerFolder}_detail_bnr.webp`}const allStores=this.dataManager.getStoresByRegionId(regionId);const storeClinicName=clinic.name;data.stores=allStores.filter(store=>store.clinicName===storeClinicName);const rankIconPath=`/common_data/images/rank_icon/rank${rank}.webp`;const regionNameForStores=this.dataManager.getRegionName(regionId)||"";const isNationalForStores=this.isNationalRegion(regionId,{id:regionId,name:regionNameForStores});const storeSectionHeading=isNationalForStores||!regionNameForStores?`${clinic.name}の店舗`:`${clinic.name}の【${regionNameForStores}】の店舗`;const informationSubTextRaw=clinicCode?this.dataManager.getClinicText(clinicCode,"INFORMATIONサブテキスト",""):"";const informationSubTextProcessed=informationSubTextRaw?this.dataManager.processDecoTags(informationSubTextRaw):"";const ctaHeaderHtml=informationSubTextProcessed?`<div style="font-size: 12px;">${informationSubTextProcessed}</div>`:"";const ctaMicrocopyHtml='<span class="cta-subtext" style="display:block;font-size: 11px;color: #ff95ad;font-weight: 400;"><span>いつでも変更/キャンセルは可能です</span></span>';const directCtaHtml=`<p class="btn btn_outline_pink">\n                        <a class="ctaBtn-direct" href="${directFormUrl}" target="_blank" rel="noopener noreferrer">\n                            <span class="bt_s">無料相談の空き状況をチェック</span>${ctaMicrocopyHtml}\n                        </a>\n                    </p>`;detailItem.innerHTML=`\n                <div class="ranking_box_in">\n                    <div class="detail-rank">\n                        <div class="detail-rank-header">\n                            <div class="detail-rank-badge has-icon ${badgeClass}"><img class="rank-badge-icon" src="${rankIconPath}" alt="${rank}位"></div>\n                            <div class="detail-title">\n                                <h3>${this.dataManager.processDecoTags(data.title)}</h3>\n                                <p>${this.dataManager.processDecoTags(data.subtitle)}</p>\n                            </div>\n                        </div>\n                        <div class="ranking__name">\n                            <a href="${officialSiteUrl}" target="_blank" rel="noopener nofollow">${clinic.name==="Oh my teeth"?"Oh my teeth（オーマイティース）":clinic.name} ＞</a>\n                        </div>\n                    </div>\n                ${(()=>{const bannerFolder=clinicCode==="kireiline"?"kireiline":clinicCode;const candidates=[];const csvBannerRaw=this.dataManager.getClinicText(clinicCode,"詳細バナー画像パス","");if(csvBannerRaw){candidates.push(csvBannerRaw)}for(let i=2;i<=10;i++){candidates.push(`/common_data/images/clinics/${bannerFolder}/${bannerFolder}_detail_bnr${i}.webp`)}const bannerImages=Array.from(new Set(candidates));if(!bannerImages.length)return"";return`\n                    <div class="detail-banner banner-slider" data-clinic-id="${clinicId}">\n                        <div class="slider-container">\n                            <div class="slider-counter">1/${bannerImages.length}</div>\n                            <button class="slider-nav slider-prev" data-clinic-id="${clinicId}">\n                                <span>‹</span>\n                            </button>\n                            <div class="slider-wrapper">\n                                <div class="slider-track" data-clinic-id="${clinicId}">\n                                    ${bannerImages.map((img,index)=>`\n                                        <div class="slider-slide ${index===0?"active":""}" data-index="${index}">\n                                            <img src="${img}" alt="${clinic.name}キャンペーン${index+1}">\n                                        </div>\n                                    `).join("")}\n                                </div>\n                            </div>\n                            <button class="slider-nav slider-next" data-clinic-id="${clinicId}">\n                                <span>›</span>\n                            </button>\n                            <button class="slider-expand" data-clinic-id="${clinicId}">\n                                <i class="fas fa-magnifying-glass" aria-hidden="true"></i>\n                                <span>画像を拡大</span>\n                            </button>\n                        </div>\n                        <div class="slider-dots">\n                            ${bannerImages.map((_,index)=>`\n                                <button class="slider-dot ${index===0?"active":""}" data-index="${index}" data-clinic-id="${clinicId}"></button>\n                            `).join("")}\n                        </div>\n                    </div>\n                    `})()}\n                <div class="detail-features">\n                    ${data.features.map(feature=>`<span class="feature-tag">${this.dataManager.processDecoTags(feature.startsWith("#")?feature:"# "+feature)}</span>`).join("")}\n                </div>\n                \n                \x3c!-- 拡張版価格表 --\x3e\n                <table class="info-table">\n                    ${Object.entries(data.priceDetail).map(([key,value])=>`\n                        <tr>\n                            <td>${key}</td>\n                            <td>${this.dataManager.processDecoTags(value)}</td>\n                        </tr>\n                    `).join("")}\n                </table>\n                \n                \x3c!-- CTAボタン --\x3e\n                <div class="clinic-cta-button-wrapper">\n                    ${ctaHeaderHtml}\n                    <p class="btn btn_second_primary">\n                        <a href="${officialSiteUrl}" target="_blank" rel="noopener noreferrer">\n                            <span class="bt_s">公式サイトで詳細を見る</span>\n                            <span class="btn-arrow">▶</span>\n                        </a>\n                    </p>\n                    ${directCtaHtml}\n                </div>\n\n                ${(()=>{const clinicCodeRaw=this.dataManager.getClinicCodeById(clinicId);const sanitizedClinicCode=clinicCodeRaw?clinicCodeRaw.toString().trim().toLowerCase().replace(/[^a-z0-9_-]/g,""):"";if(!sanitizedClinicCode){return""}const baseVideoPath=window.SITE_CONFIG&&window.SITE_CONFIG.imagesPath?window.SITE_CONFIG.imagesPath:"./images";const videoSrc=`${baseVideoPath}/${sanitizedClinicCode}_treatment.mp4`;const videoHtml=`<div class="procedure-video-embed" data-clinic-code="${sanitizedClinicCode}" data-video-src="${videoSrc}">\n                            <video class="procedure-video" controls playsinline preload="auto" tabindex="0" aria-label="${clinic.name}の施術風景">\n                                <source src="${videoSrc}" type="video/mp4">\n                                お使いのブラウザでは動画を再生できません。\n                            </video>\n                            <button type="button" class="procedure-video-toggle" aria-label="再生">\n                                <span class="procedure-video-toggle-icon"></span>\n                            </button>\n                        </div>`;return`\n                <div class="clinic-procedure-section" data-procedure-section style="display:none;">\n                    <h4 class="section-title">施術風景</h4>\n                    <div class="procedure-video-wrapper">\n                        ${videoHtml}\n                    </div>\n                </div>\n                    `})()}\n\n                \x3c!-- クリニックのポイント --\x3e\n                <div class="clinic-points-section">\n                    <h4 class="section-title">POINT</h4>\n                    <div class="ribbon_point_box_no">\n                        ${data.points.map((point,index)=>{let iconClass="fa-clock";if(point.icon==="lightbulb")iconClass="fa-lightbulb";else if(point.icon==="phone")iconClass="fa-mobile-alt";else if(point.icon==="coins")iconClass="fa-yen-sign";return`\n                            <div class="ribbon_point_title2_s">\n                                <i class="fas ${iconClass} point-icon-inline"></i>\n                                <strong>${this.dataManager.processDecoTags(point.title)}</strong>\n                            </div>\n                            <div class="ribbon_point_txt">\n                                <p style="font-size:14px;">${this.dataManager.processDecoTags(point.description)}</p>\n                            </div>\n                            `}).join("")}\n                        <div class="ribbon_point_link">\n                            【公式】<a href="${officialSiteUrl}" target="_blank" rel="noopener"><strong>${data.priceDetail["公式サイト"]||"#"}</strong></a>\n                        </div>\n                    </div>\n                </div>\n                \n                ${(()=>{if(rank!==1)return"";const clinicCode=this.dataManager.getClinicCodeById(clinicId)||"";if(!clinicCode)return"";const dm=this.dataManager;const imagesForClinic=[{fallbacks:[`images/${clinicCode}_case01.jpg`],alt:"CASE 01"},{fallbacks:[`images/${clinicCode}_case02.jpg`],alt:"CASE 02"},{fallbacks:[`images/${clinicCode}_case03.jpg`],alt:"CASE 03"}];if(!imagesForClinic.length)return"";const buildRow=(label,val)=>`<tr><td style="padding: 0 8px !important; background-color: #f8f8f8 !important; font-weight: bold !important; width: 30% !important;">${label}</td><td style="padding: 0 8px !important;">${val}</td></tr>`;const slidesHtml=imagesForClinic.map((img,idx)=>{const keyBase=`case${idx+1}`;const nameVal=dm.getClinicText(clinicCode,`${keyBase}コース名`,"")||"—";const descVal=dm.getClinicText(clinicCode,`${keyBase}施術の説明`,"")||"—";const riskVal=dm.getClinicText(clinicCode,`${keyBase}副作用（リスク）`,"")||"—";return`\n                            <div class="case-slide" style="min-width:100%;box-sizing:border-box;">\n                                <img src="${img.fallbacks[0]}" alt="${img.alt}" loading="lazy" style="width:100%;height:auto;object-fit:contain;">\n                                <div class="case-info" style="margin-top: 5px; padding: 0 5%; text-align: left; font-size: 12px; line-height: 1.6; width: 100%;">\n                                    <table class="case-table" style="width: 100% !important; border-collapse: collapse !important; font-size: 8px !important; line-height: 1.6 !important; display: table !important; table-layout: fixed !important;">\n                                        <tbody>\n                                            ${buildRow("コース名",dm.processDecoTags(nameVal))}\n                                            ${buildRow("施術の説明",dm.processDecoTags(descVal))}\n                                            ${buildRow("副作用<br>（リスク）",dm.processDecoTags(riskVal))}\n                                            ${buildRow("","3ヶ月医療痩身ボディメイクを契約された<br>モニター対象の会員の代表的な事例を提示しています。効果には個人差があります。")}\n                                        </tbody>\n                                    </table>\n                                </div>\n                            </div>\n                        `}).join("");const dotsHtml=imagesForClinic.map((_,i)=>`<button type="button" class="case-dot ${i===0?"active":""}" data-index="${i}" style="width:8px;height:8px;border-radius:50%;border:none;background:${i===0?"#2CC7C5":"#ccc"};margin:0 4px;cursor:pointer;"></button>`).join("");return`\n                    <div class="clinic-points-section">\n                        <h4 class="section-title">症例写真</h4>\n                        <div class="case-slider" style="position: relative; overflow: hidden;">\n                            <div class="case-track" style="display:flex;">\n                                ${slidesHtml}\n                            </div>\n                            <button class="case-nav case-nav-prev" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.8);border:none;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;z-index:10;">‹</button>\n                            <button class="case-nav case-nav-next" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.8);border:none;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;z-index:10;">›</button>\n                        </div>\n                        <div class="case-dots" style="text-align:center;margin-top:10px;">\n                            ${dotsHtml}\n                        </div>\n                    </div>\n                    `})()}\n                \n                \n                \x3c!-- 口コミ --\x3e\n                <div class="reviews-section">\n                    <h4 class="section-title-review">REVIEW</h4>\n                    \n                    <section id="review_tab_box">\n                        <nav role="navigation" class="review_tab2">\n                            <ul>\n                                ${(()=>{const clinicCodeForLabels=this.dataManager.getClinicCodeById(clinicId);const labels=this.dataManager.getReviewTabLabels(clinicCodeForLabels)||[];const icons=["fa-yen-sign","fa-user-md","fa-heart"];if(labels.length===0)return"";return labels.map((label,idx)=>{const icon=icons[idx]||"fa-comment-dots";const active=idx===0?"select2":"";return`<li class="${active}" data-tab="tab-${idx}"><i class="fas ${icon}"></i> ${label}</li>`}).join("")})()}\n                            </ul>\n                        </nav>\n                        ${(()=>{const clinicCode=this.dataManager.getClinicCodeById(clinicId);const labelList=this.dataManager.getReviewTabLabels(clinicCode)||[];const reviewIcons=["/common_data/images/review_icon/review_icon1.webp","/common_data/images/review_icon/review_icon2.webp","/common_data/images/review_icon/review_icon3.webp","/common_data/images/review_icon/review_icon4.webp","/common_data/images/review_icon/review_icon5.webp","/common_data/images/review_icon/review_icon6.webp","/common_data/images/review_icon/review_icon7.webp","/common_data/images/review_icon/review_icon8.webp","/common_data/images/review_icon/review_icon9.webp"];const iconOrdersByRank={1:[0,1,2,3,4,5,6,7,8],2:[2,7,0,5,6,1,8,3,4],3:[0,5,8,1,2,3,4,7,6],4:[6,3,4,7,8,1,0,5,2],5:[4,1,6,5,0,3,2,7,8]};const defaultOrder=Array.from({length:reviewIcons.length},(_,i)=>(i+((rank||1)-1))%reviewIcons.length);const iconOrder=iconOrdersByRank[rank]||defaultOrder;let html="";const dm=this.dataManager;labelList.forEach((label,catIdx)=>{const activeClass=catIdx===0?"active":"disnon2";html+=`<div class="wrap_long2 ${activeClass}">`;const reviews=dm.getClinicReviewsByLabel(clinicCode,label);reviews.forEach((review,index)=>{const globalIndex=catIdx*3+index;const orderIndex=globalIndex%iconOrder.length;const iconIndex=iconOrder[orderIndex];html+=`\n                                        <div class="review_tab_box_in">\n                                            <div class="review_tab_box_img">\n                                                <img src="${reviewIcons[iconIndex]}" alt="レビューアイコン">\n                                                <span>★★★★★</span>\n                                            </div>\n                                            <div class="review_tab_box_r">\n                                                <div class="review_tab_box_title"><strong>${review.title}</strong></div>\n                                                <div class="review_tab_box_txt">\n                                                    ${review.content}\n                                                </div>\n                                            </div>\n                                        </div>\n                                    `});if(reviews.length===0){html+='<div class="review_tab_box_in"><div class="review_tab_box_r"><div class="review_tab_box_txt">準備中</div></div></div>'}html+='<p style="font-size:8px;text-align:right">※効果には個人差があります<br>※個人の感想です</p>';html+="</div>"});return html})()}\n                    </section>\n                </div>\n                \n                \x3c!-- 店舗情報 --\x3e\n                <div class="brand-section">\n                    <h4 class="section-heading">\n                        ${storeSectionHeading}\n                    </h4>\n                    ${this.dataManager.generateStoresDisplay(clinicId,regionId)}\n                </div>\n                \n                \x3c!-- キャンペーンセクション --\x3e\n                <div class="campaign-section">\n                    <div class="campaign-container">\n                        ${(()=>{const clinicCode=this.dataManager.getClinicCodeById(clinicId);const campaignHeader=this.dataManager.getClinicText(clinicCode,"キャンペーンヘッダー","INFORMATION!");const campaignDescription=this.dataManager.getClinicText(clinicCode,"INFORMATIONキャンペーンテキスト","");const campaignMicrocopy=this.dataManager.getClinicText(clinicCode,"INFORMATIONサブテキスト","");const ctaText=this.dataManager.getClinicText(clinicCode,"CTAボタンテキスト",`キャンペーンの詳細を見る`);const logoFolder=clinicCode==="kireiline"?"kireiline":clinicCode;const logoSrc=`/common_data/images/clinics/${logoFolder}/${logoFolder}-logo.webp`;const logoAlt=clinic.name;return`\n                            <div class="campaign-header">${campaignHeader}</div>\n                            <div class="campaign-content">\n                                <div class="camp_header3">\n                                    <div class="info_logo">\n                                        <img src="${logoSrc}" alt="${logoAlt}" onerror="this.onerror=null; this.src='/common_data/images/clinics/${logoFolder}/${logoFolder}-logo.jpg';">\n                                    </div>\n                                    <div class="camp_txt">\n                                        ${campaignDescription}\n                                    </div>\n                                </div>\n                                \n                                <div class="cv_box_img">\n                                    ${campaignMicrocopy}\n                                    <p class="btn btn_second_primary" style="margin-top: 10px;">\n                                        <a href="${officialSiteUrl}" target="_blank" rel="noopener">\n                                            <span class="bt_s">${ctaText}</span>\n                                            <span class="btn-arrow">▶</span>\n                                        </a>\n                                    </p>\n                                    <p class="btn btn_outline_pink">\n                                        <a class="ctaBtn-direct" href="${directFormUrl}" target="_blank" rel="noopener noreferrer">\n                                            <span class="bt_s">無料相談の空き状況をチェック</span>${ctaMicrocopyHtml}\n                                        </a>\n                                    </p>\n                                </div>\n                            </div>\n                            `})()}\n                    </div>\n            ${(()=>{const clinicCode=this.dataManager.getClinicCodeById(clinic.id);const disclaimerText=clinicCode?this.dataManager.getClinicText(clinicCode,"INFORMATION確認事項",""):"";if(disclaimerText&&disclaimerText.trim()!==""){return`\n                    \x3c!-- ${clinic.name}の確認事項アコーディオン --\x3e\n                    <div class="disclaimer-accordion" style="margin-top: 15px;">\n                        <button class="disclaimer-header" onclick="toggleDisclaimer('${clinic.code}-campaign')" style="width: 100%; text-align: left; padding: 8px 12px; background-color: #fafafa; border: 1px solid #f0f0f0; border-radius: 3px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">\n                            <span style="font-size: 10px; font-weight: 500; color: #666;">${clinic.name}の確認事項</span>\n                            <span id="${clinic.code}-campaign-arrow" style="font-size: 8px; color: #999; transition: transform 0.2s;">▼</span>\n                        </button>\n                        <div id="${clinic.code}-campaign-content" class="disclaimer-content" style="display: none; padding: 8px 12px; background-color: #fcfcfc; border: 1px solid #f0f0f0; border-top: none; border-radius: 0 0 3px 3px; margin-top: -1px;">\n                            <div style="font-size: 9px; color: #777; line-height: 1.4;">\n                                ${disclaimerText.split("<br>").map(text=>text.trim()).filter(text=>text).map(text=>`<p>${text}</p>`).join("\n                                ")}\n                            </div>\n                        </div>\n                    </div>\n                    `}return""})()}\n                </div>\n            </div>\n            `;detailsList.appendChild(detailItem);this.initializeProcedureVideos(detailItem);if(rank===1){try{const root=detailItem;const track=root.querySelector(".case-track");let slides=Array.from(root.querySelectorAll(".case-slide"));const dotsWrap=root.querySelector(".case-dots");let dots=Array.from(root.querySelectorAll(".case-dot"));const prevBtn=root.querySelector(".case-nav-prev");const nextBtn=root.querySelector(".case-nav-next");const caseSection=root.querySelector(".case-slider")?.closest(".clinic-points-section");const imgs=Array.from(root.querySelectorAll(".case-slider img"));if(!imgs||imgs.length===0){if(caseSection)caseSection.style.display="none";return}let current=0;const reindex=()=>{slides=Array.from(root.querySelectorAll(".case-slide"));dots=Array.from(root.querySelectorAll(".case-dot"));dots.forEach((d,i)=>d.setAttribute("data-index",String(i)))};const updateNavVisibility=()=>{const show=slides.length>1;if(prevBtn)prevBtn.style.display=show?"":"none";if(nextBtn)nextBtn.style.display=show?"":"none";if(dotsWrap)dotsWrap.style.display=show?"block":"none"};const show=i=>{if(!slides.length||!track)return;if(i<0)i=slides.length-1;if(i>=slides.length)i=0;current=i;track.style.display="flex";track.style.transform=`translateX(-${current*100}%)`;track.style.transition="transform .3s ease";slides.forEach(s=>{s.style.minWidth="100%";s.style.boxSizing="border-box"});dots.forEach((d,idx)=>{d.classList.toggle("active",idx===current);d.style.background=idx===current?"#2CC7C5":"#ccc"})};imgs.forEach(img=>{img.addEventListener("error",()=>{const slide=img.closest(".case-slide");if(!slide)return;const idx=slides.indexOf(slide);if(idx>=0){const dot=dots[idx];if(dot&&dot.parentNode)dot.parentNode.removeChild(dot);if(slide&&slide.parentNode)slide.parentNode.removeChild(slide);reindex();if(slides.length===0){if(caseSection)caseSection.style.display="none";return}if(current>=slides.length)current=slides.length-1;updateNavVisibility();show(current)}},{once:true})});if(track&&slides.length){prevBtn&&prevBtn.addEventListener("click",()=>show(current-1));nextBtn&&nextBtn.addEventListener("click",()=>show(current+1));dots.forEach((d,idx)=>d.addEventListener("click",ev=>{ev.preventDefault();ev.stopPropagation();show(idx)}));if(dotsWrap){dotsWrap.addEventListener("click",e=>{const el=e.target&&e.target.nodeType===1?e.target:e.target&&e.target.parentElement;if(!el)return;const dot=el.closest&&el.closest(".case-dot");if(!dot)return;e.preventDefault();e.stopPropagation();const idxAttr=dot.getAttribute("data-index");const idx=idxAttr?parseInt(idxAttr,10):Array.from(dotsWrap.querySelectorAll(".case-dot")).indexOf(dot);if(idx>=0)show(idx)},{capture:true})}updateNavVisibility();show(0)}}catch(e){}}})}initializeProcedureVideos(rootElement=document){const scope=rootElement instanceof HTMLElement?rootElement:document;const embeds=scope.querySelectorAll(".procedure-video-embed");embeds.forEach(embed=>{if(!embed||embed.dataset.videoInitialized==="1"){return}const video=embed.querySelector(".procedure-video");const toggle=embed.querySelector(".procedure-video-toggle");if(!video||!toggle){return}embed.dataset.videoInitialized="1";const section=embed.closest("[data-procedure-section]")||embed.closest(".clinic-procedure-section");const sourceEl=video.querySelector("source");const videoSrc=embed.dataset.videoSrc||(sourceEl?sourceEl.getAttribute("src"):video.currentSrc);const cache=window.__treatmentVideoCache=window.__treatmentVideoCache||{};const showSection=()=>{if(section&&!section.dataset.shown){section.style.removeProperty("display");delete section.dataset.procedurePending;section.dataset.shown="1"}};const removeSection=()=>{if(section&&!section.dataset.removed){section.dataset.removed="1";section.remove()}};if(!videoSrc){removeSection();return}if(cache[videoSrc]===false){removeSection();return}if(cache[videoSrc]===true){showSection()}const updateState=()=>{const playing=!video.paused&&!video.ended;embed.classList.toggle("is-playing",playing);toggle.setAttribute("aria-label",playing?"一時停止":"再生")};const playSafely=()=>{const playPromise=video.play();if(playPromise&&typeof playPromise.then==="function"){playPromise.catch(()=>{})}};const togglePlayback=()=>{if(video.paused||video.ended){playSafely()}else{video.pause()}};const handleToggle=event=>{event.preventDefault();event.stopPropagation();togglePlayback()};const markAvailable=()=>{cache[videoSrc]=true;showSection()};const markMissing=()=>{cache[videoSrc]=false;removeSection()};toggle.addEventListener("click",handleToggle);video.addEventListener("click",handleToggle);video.addEventListener("play",()=>{showSection();updateState()});video.addEventListener("pause",updateState);video.addEventListener("ended",updateState);video.addEventListener("error",markMissing,{once:true});const handleLoaded=()=>{markAvailable();updateState()};video.addEventListener("loadeddata",handleLoaded,{once:true});video.addEventListener("loadedmetadata",handleLoaded,{once:true});video.addEventListener("keydown",event=>{if(event.key===" "||event.key==="Enter"){event.preventDefault();togglePlayback()}});if(video.error){markMissing();return}if(video.readyState>=HTMLMediaElement.HAVE_METADATA){markAvailable()}else{try{video.load()}catch(_){}}updateState()})}getStoreImage(clinicName,storeNumber){const paddedNumber=String(storeNumber).padStart(3,"0");const imagesPath=window.SITE_CONFIG?window.SITE_CONFIG.imagesPath+"/images":"/images";const storeImagePath=`${imagesPath}/clinics/${clinicName}/${clinicName}_clinic/clinic_image_${paddedNumber}.webp`;return storeImagePath}handleImageError(imgElement,clinicName,storeNumber){const paddedNumber=String(storeNumber).padStart(3,"0");const imagesPath=window.SITE_CONFIG?window.SITE_CONFIG.imagesPath+"/images":"/images";const extensions=["jpg","png"];const currentSrc=imgElement.src;let currentExtIndex=-1;if(currentSrc.includes(".webp"))currentExtIndex=-1;else if(currentSrc.includes(".jpg"))currentExtIndex=0;else if(currentSrc.includes(".png"))currentExtIndex=1;const nextExtIndex=currentExtIndex+1;if(nextExtIndex<extensions.length){imgElement.src=`${imagesPath}/clinics/${clinicName}/${clinicName}_clinic/clinic_image_${paddedNumber}.${extensions[nextExtIndex]}`}else{imgElement.src=`/common_data/images/clinics/${clinicName}/${clinicName}-logo.webp`;imgElement.onerror=()=>{imgElement.src=`/common_data/images/clinics/${clinicName}/${clinicName}-logo.jpg`}}}getRegionName(regionId){if(!window.dataManager){return""}const region=window.dataManager.getRegionById(regionId);return region?region.name:""}generateMapIframe(address){if(!address){return"<p>住所情報がありません</p>"}const encodedAddress=encodeURIComponent(address);const mapUrl=`https://maps.google.com/maps?q=${encodedAddress}&output=embed&z=16`;return`\n            <iframe \n                src="${mapUrl}"\n                width="100%" \n                height="300" \n                style="border:0;" \n                allowfullscreen="" \n                loading="lazy" \n                referrerpolicy="no-referrer-when-downgrade"\n                title="Google Maps">\n            </iframe>\n        `}setupMapAccordions(){const mapModal=document.getElementById("map-modal");const mapModalClose=document.getElementById("map-modal-close");const mapModalOverlay=document.querySelector(".map-modal-overlay");const self=this;if(this.mapButtonClickHandler){document.removeEventListener("click",this.mapButtonClickHandler,true)}this.mapButtonClickHandler=e=>{if(e.target.closest(".map-toggle-btn")){e.preventDefault();const button=e.target.closest(".map-toggle-btn");const shopContainer=button.closest(".shop");let clinicName="クリニック";try{const shopsContainer=shopContainer?.closest(".shops");const clinicDetailElement=shopsContainer?.closest(".detail-item");const contextualClinicId=clinicDetailElement?.getAttribute("data-clinic-id");if(contextualClinicId&&self.dataManager){const contextualClinic=self.dataManager.clinics?.find(c=>c.id==contextualClinicId);if(contextualClinic){clinicName=contextualClinic.name}}}catch(ctxErr){console.warn("Failed to resolve context clinic:",ctxErr)}if(shopContainer){const storeNameElement=shopContainer.querySelector(".shop-name a");const storeName=storeNameElement?.textContent?.trim()||"店舗";const addressElement=shopContainer.querySelector(".shop-address");const address=addressElement?.textContent?.trim()||"住所情報なし";let access="駅から徒歩圏内";if(self.dataManager){const stores=self.dataManager.stores;const matchingStore=stores.find(store=>store.storeName===storeName&&store.address===address);if(matchingStore){if(matchingStore.access){access=matchingStore.access}if(clinicName==="クリニック"&&matchingStore.clinicName){clinicName=matchingStore.clinicName}}else{const shopInfoElement=shopContainer.querySelector(".shop-info");if(shopInfoElement){const infoText=shopInfoElement.textContent;const lines=infoText.split("\n").map(line=>line.trim()).filter(line=>line);const accessLine=lines.find(line=>line.includes("駅")&&(line.includes("徒歩")||line.includes("分")));if(accessLine){access=accessLine}}}}if(clinicName==="クリニック"){const shopsContainer2=shopContainer.closest(".shops");const clinicDetailElement2=shopsContainer2?.closest(".detail-item");if(clinicName==="クリニック"){const h3Element=clinicDetailElement?.querySelector("h3");if(h3Element){const h3Text=h3Element.childNodes[0]?.textContent?.trim()||h3Element.textContent?.trim();if(h3Text&&h3Text!==""){if(self.dataManager&&self.dataManager.clinics){const matchedClinic=self.dataManager.clinics.find(c=>h3Text.includes(c.name)||c.name.includes(h3Text));if(matchedClinic){clinicName=matchedClinic.name}}}if(clinicName==="クリニック"){const detailButtons=clinicDetailElement2?.querySelectorAll(".detail_btn_2, .link_btn");if(detailButtons.length>0){const href=detailButtons[0].getAttribute("href");const clinicIdMatch=href?.match(/clinic_id=(\d+)/);if(clinicIdMatch){const extractedClinicId=clinicIdMatch[1];const clinic=self.dataManager?.clinics?.find(c=>c.id==extractedClinicId);if(clinic){clinicName=clinic.name}}}}}}}try{let fullStoreName=storeName;if(storeName.startsWith("クリニック")){fullStoreName=clinicName+storeName.replace("クリニック","").trim()}else if(!storeName.includes(clinicName)){fullStoreName=clinicName+storeName}self.showMapModal(fullStoreName,address,access,clinicName)}catch(error){}}else{try{self.showMapModal("テストクリニック","テスト住所","テストアクセス","test")}catch(error){}}}};document.addEventListener("click",this.mapButtonClickHandler,true);if(mapModalClose){mapModalClose.addEventListener("click",()=>{self.hideMapModal()})}if(mapModalOverlay){mapModalOverlay.addEventListener("click",()=>{self.hideMapModal()})}document.addEventListener("keydown",e=>{if(e.key==="Escape"&&mapModal?.style.display!=="none"){self.hideMapModal()}})}showMapModal(clinicName,address,access,clinicCode){const modal=document.getElementById("map-modal");const modalClinicName=document.getElementById("map-modal-clinic-name");const modalAddress=document.getElementById("map-modal-address");const modalAccess=document.getElementById("map-modal-access");const modalHours=document.getElementById("map-modal-hours");const modalMapContainer=document.getElementById("map-modal-map-container");const modalButton=document.getElementById("map-modal-button");if(modal&&modalClinicName&&modalAddress&&modalAccess&&modalMapContainer){try{if(modal.parentNode!==document.body){document.body.appendChild(modal)}}catch(_){}modal.style.display="flex";document.body.style.overflow="hidden";modalClinicName.textContent=clinicName;modalAddress.textContent=address;modalAccess.textContent=access;modalMapContainer.innerHTML=this.generateMapIframe(address);if(modalButton){try{let clinicKey="";const clinics=this.dataManager.clinics||[];const clinic=clinics.find(c=>c.name===clinicCode||clinicName.includes(c.name)||c.name===clinicName);if(clinic){clinicKey=clinic.code}let generatedUrl="#";try{if(window.urlHandler){generatedUrl=window.urlHandler.getClinicUrlByNameWithRegionId(clinicKey)}}catch(e){}if(!generatedUrl||generatedUrl==="#"){const regionId=new URLSearchParams(window.location.search).get("region_id")||"000";if(clinic){generatedUrl=`./redirect.html?clinic_id=${clinic.id}&rank=1&region_id=${regionId}`}}if(generatedUrl&&generatedUrl!=="#"&&generatedUrl!==""){modalButton.href=generatedUrl;modalButton.target="_blank";modalButton.rel="noopener";modalButton.onclick=null}else{modalButton.href="#";modalButton.onclick=e=>{e.preventDefault();this.hideMapModal();const clinicDetail=document.querySelector(`[data-clinic-id="${clinic?.id||"1"}"]`);if(clinicDetail){clinicDetail.scrollIntoView({behavior:"smooth",block:"center"})}}}const buttonText=document.getElementById("map-modal-button-text");if(buttonText){const ctaClinicName=clinic&&clinic.name||typeof clinicCode==="string"&&clinicCode||"クリニック";buttonText.textContent=ctaClinicName+"の公式サイト"}}catch(error){modalButton.href="#";modalButton.onclick=e=>{e.preventDefault();this.hideMapModal()}}}}else{}}hideMapModal(){const modal=document.getElementById("map-modal");if(modal){modal.style.display="none";document.body.style.overflow=""}}}function toggleStores(button){const targetId=button.getAttribute("data-target");const root=button.closest(".clinic-detail-modal")||document;const targetShops=root.querySelector(targetId)||document.querySelector(targetId);if(!targetShops)return false;const hiddenShops=targetShops.querySelectorAll(".hidden-content");hiddenShops.forEach(shop=>{shop.classList.remove("hidden")});button.style.display="none";return false}function initializeDisclaimers(){const mainContent=document.getElementById("main-content");const rankingDisclaimers=document.getElementById("ranking-disclaimers-content");if(!window.dataManager){return}if(!mainContent&&!rankingDisclaimers){return}let regionId=window.app?.currentRegionId;if(!regionId){const urlParams=new URLSearchParams(window.location.search);regionId=urlParams.get("region_id")}if(!regionId){regionId="13"}regionId=String(parseInt(regionId,10));const ranking=window.dataManager.getRankingByRegionId(regionId);if(!ranking||!ranking.ranks){mainContent.innerHTML="";return}const displayedClinics=[];const comparisonTbody=document.getElementById("comparison-tbody");if(comparisonTbody&&comparisonTbody.children.length>0){Array.from(comparisonTbody.children).forEach((row,index)=>{const cells=row.querySelectorAll("td");if(cells.length>0){const clinicNameCell=cells[0];if(clinicNameCell){const clinicName=clinicNameCell.textContent.trim();const clinicLink=clinicNameCell.querySelector("a");if(clinicName&&clinicName!==""){let clinicId=null;if(clinicLink){const onclickMatch=clinicLink.getAttribute("onclick")?.match(/clinic_id:\s*'([^']+)'/);if(onclickMatch){clinicId=onclickMatch[1]}}if(clinicId){const clinicCode=window.dataManager.getClinicCodeById(clinicId);if(clinicCode){displayedClinics.push({rank:index+1,id:clinicId,code:clinicCode,name:clinicName})}}}}}})}const topClinics=displayedClinics.length>0?displayedClinics:[];if(topClinics.length===0&&ranking&&ranking.ranks){for(let i=1;i<=5;i++){const clinicId=ranking.ranks[`no${i}`];if(clinicId&&clinicId!=="-"&&clinicId!==""){const clinic=window.dataManager.getClinicById(clinicId);if(clinic){const clinicCode=window.dataManager.getClinicCodeById(clinicId);if(clinicCode){topClinics.push({rank:i,id:clinicId,code:clinicCode,name:clinic.name})}}}}}topClinics.sort((a,b)=>a.name.localeCompare(b.name));topClinics.forEach((clinic,index)=>{});if(topClinics.length===0){if(mainContent)mainContent.innerHTML="";if(rankingDisclaimers)rankingDisclaimers.innerHTML="";return}const generateDisclaimerHtmlForSection=(clinics,prefix)=>{let disclaimerHTML="";let disclaimerCount=0;clinics.forEach(clinic=>{const disclaimerText=window.dataManager.getClinicText(clinic.code,"比較表の注意事項","");if(disclaimerText&&disclaimerText.trim()!==""){disclaimerCount++;const clinicSlug=clinic.code.toLowerCase().replace(/\s+/g,"");const uniqueSlug=`${prefix}-${clinicSlug}`;disclaimerHTML+=`\n                    <div class="disclaimer-item">\n                        <button class="disclaimer-header" onclick="return toggleClinicDisclaimer('${uniqueSlug}', event)" style="width: 100%; text-align: left; padding: 6px 10px; background-color: #f8f8f8; border: 1px solid #eeeeee; border-radius: 2px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">\n                            <span style="font-size: 9px; font-weight: 400; color: #777;">${clinic.name}</span>\n                            <span id="${uniqueSlug}-arrow" style="font-size: 7px; color: #aaa; transition: transform 0.2s;">▼</span>\n                        </button>\n                        <div id="${uniqueSlug}-content" class="disclaimer-content" style="display: none; padding: 6px 10px; background-color: #fefefe; border: 1px solid #eeeeee; border-top: none; border-radius: 0 0 2px 2px; margin-top: -2px;">\n                            <div style="font-size: 9px; color: #777; line-height: 1.4;">\n                                ${disclaimerText.split("\n").map(line=>line.trim()).filter(line=>line).map(line=>`<p>${line}</p>`).join("\n                            ")}\n                            </div>\n                        </div>\n                    </div>\n                `}});return{html:disclaimerHTML,count:disclaimerCount}};const rankingResult=generateDisclaimerHtmlForSection(topClinics,"rank");if(rankingDisclaimers){if(rankingResult.count>0){rankingDisclaimers.innerHTML=rankingResult.html}else{rankingDisclaimers.innerHTML='<p style="font-size: 11px; color: #666; padding: 10px;">注意事項はありません。</p>'}}const comparisonResult=generateDisclaimerHtmlForSection(topClinics,"comp");if(mainContent){if(comparisonResult.count>0){mainContent.innerHTML=comparisonResult.html}else{mainContent.innerHTML='<p style="font-size: 11px; color: #666; padding: 10px;">注意事項はありません。</p>'}}}document.addEventListener("DOMContentLoaded",function(){const app=new RankingApp;window.app=app;app.init();setTimeout(()=>{initializeDisclaimers()},100);setTimeout(()=>{try{initializeBannerSliders()}catch(_){}},200);window.testInitializeDisclaimers=initializeDisclaimers;window.openClinicDetailModal=openClinicDetailModal;window.closeClinicDetailModal=closeClinicDetailModal;window.toggleClinicDisclaimer=function(uniqueSlug,event){if(event){event.preventDefault?.();event.stopPropagation?.()}const modalRoot=document.querySelector(".clinic-detail-modal");const root=event&&event.target&&event.target.closest(".clinic-detail-modal")||modalRoot||document;const content=root.querySelector(`#${uniqueSlug}-content`)||document.querySelector(`#${uniqueSlug}-content`);const arrow=root.querySelector(`#${uniqueSlug}-arrow`)||document.querySelector(`#${uniqueSlug}-arrow`);if(content){const isHidden=getComputedStyle(content).display==="none"||content.style.display==="none";content.style.display=isHidden?"block":"none";if(arrow)arrow.style.transform=isHidden?"rotate(180deg)":"rotate(0deg)"}return false};window.toggleDisclaimer=function(clinicSlug){const modalRoot=document.querySelector(".clinic-detail-modal");const root=modalRoot||document;const content=root.querySelector(`#${clinicSlug}-content`)||document.querySelector(`#${clinicSlug}-content`);const arrow=root.querySelector(`#${clinicSlug}-arrow`)||document.querySelector(`#${clinicSlug}-arrow`);if(content){const isHidden=getComputedStyle(content).display==="none"||content.style.display==="none";content.style.display=isHidden?"block":"none";if(arrow)arrow.style.transform=isHidden?"rotate(180deg)":"rotate(0deg)"}return false};setTimeout(()=>{const allDetailLinks=document.querySelectorAll('a[href*="#clinic"]');allDetailLinks.forEach(link=>{link.addEventListener("click",e=>{const href=link.getAttribute("href")||"";const m=href.match(/#clinic(\d+)/);if(m){e.preventDefault();const rank=parseInt(m[1],10);if(rank&&!Number.isNaN(rank))openClinicDetailModal(rank)}})});document.addEventListener("click",e=>{const a=e.target.closest('a[href*="#clinic"]');if(!a)return;const href=a.getAttribute("href")||"";const m=href.match(/#clinic(\d+)/);if(!m)return;e.preventDefault();const rank=parseInt(m[1],10);if(rank&&!Number.isNaN(rank))openClinicDetailModal(rank)},true)},500);document.querySelectorAll(".footer-page-link").forEach(link=>{link.addEventListener("click",function(e){e.preventDefault();const currentParams=new URLSearchParams(window.location.search);if(currentParams.toString()){const url=new URL(this.href,window.location.origin);for(const[key,value]of currentParams){url.searchParams.set(key,value)}window.location.href=url.toString()}else{window.location.href=this.href}})})});function initializeBannerSliders(){const sliders=document.querySelectorAll(".banner-slider");sliders.forEach(slider=>{if(slider.dataset.initialized==="1")return;slider.dataset.initialized="1";let slidesArr=Array.from(slider.querySelectorAll(".slider-slide"));let dotsArr=Array.from(slider.querySelectorAll(".slider-dot"));const dotsContainer=slider.querySelector(".slider-dots");const prevBtn=slider.querySelector(".slider-prev");const nextBtn=slider.querySelector(".slider-next");const counter=slider.querySelector(".slider-counter");const expandBtn=slider.querySelector(".slider-expand");if(!slidesArr||slidesArr.length===0)return;let currentIndex=0;let totalSlides=slidesArr.length;const getImageUrls=()=>Array.from(slider.querySelectorAll(".slider-slide")).map(slide=>{const img=slide.querySelector("img");return img?img.src:""});let imageUrls=getImageUrls();const getActiveIndex=()=>{const idx=slidesArr.findIndex(s=>s.classList.contains("active"));return idx>=0?idx:0};currentIndex=getActiveIndex();slidesArr.forEach(slide=>{const img=slide.querySelector("img");const open=()=>createAndShowModal(imageUrls,getActiveIndex());if(img){img.style.cursor="zoom-in";img.addEventListener("click",open)}else{slide.addEventListener("click",open)}});function updateSlider(index){slidesArr.forEach(slide=>slide.classList.remove("active"));dotsArr.forEach(dot=>dot.classList.remove("active"));slidesArr[index]?.classList.add("active");if(dotsArr[index])dotsArr[index].classList.add("active");if(counter)counter.textContent=`${index+1}/${totalSlides}`;currentIndex=index}function updateNavVisibility(){const show=totalSlides>1;if(prevBtn)prevBtn.style.display=show?"":"none";if(nextBtn)nextBtn.style.display=show?"":"none";if(dotsContainer)dotsContainer.style.display=show?"":"none"}function reindex(){slidesArr=Array.from(slider.querySelectorAll(".slider-slide"));dotsArr=Array.from(slider.querySelectorAll(".slider-dot"));slidesArr.forEach((s,i)=>s.setAttribute("data-index",String(i)));dotsArr.forEach((d,i)=>d.setAttribute("data-index",String(i)));totalSlides=slidesArr.length;imageUrls=getImageUrls();updateNavVisibility()}function removeSlideAt(idx){const slide=slidesArr[idx];const dot=dotsArr[idx];if(slide)slide.remove();if(dot)dot.remove();reindex();if(totalSlides===0)return;if(currentIndex>=totalSlides)currentIndex=totalSlides-1;updateSlider(currentIndex)}slidesArr.forEach(slide=>{const img=slide.querySelector("img");if(!img)return;img.addEventListener("error",()=>{const idxAttr=slide.getAttribute("data-index");const idx=idxAttr?parseInt(idxAttr,10):slidesArr.indexOf(slide);if(idx>=0)removeSlideAt(idx)},{once:true})});if(prevBtn){prevBtn.addEventListener("click",()=>{const newIndex=currentIndex===0?totalSlides-1:currentIndex-1;updateSlider(newIndex)})}if(nextBtn){nextBtn.addEventListener("click",()=>{const newIndex=currentIndex===totalSlides-1?0:currentIndex+1;updateSlider(newIndex)})}dotsArr.forEach(dot=>{dot.addEventListener("click",()=>{const idxAttr=dot.getAttribute("data-index");const idx=idxAttr?parseInt(idxAttr,10):dotsArr.indexOf(dot);updateSlider(Math.max(0,idx))})});if(expandBtn){expandBtn.addEventListener("click",()=>{createAndShowModal(imageUrls,getActiveIndex())})}updateSlider(getActiveIndex());updateNavVisibility()})}function createAndShowModal(imageUrls,startIndex){const existingModal=document.querySelector(".banner-modal");if(existingModal)existingModal.remove();const modalHtml=`\n        <div class="banner-modal active">\n            <button class="banner-modal-close">&times;</button>\n            <button class="banner-modal-nav banner-modal-prev">‹</button>\n            <div class="banner-modal-content">\n                <img class="banner-modal-image" src="${imageUrls[startIndex]}" alt="拡大画像">\n                <div class="banner-modal-counter">${startIndex+1}/${imageUrls.length}</div>\n            </div>\n            <button class="banner-modal-nav banner-modal-next">›</button>\n            <div class="banner-modal-dots">\n                ${imageUrls.map((_,idx)=>`\n                    <button class="banner-modal-dot ${idx===startIndex?"active":""}" data-index="${idx}" aria-label="${idx+1}"></button>\n                `).join("")}\n            </div>\n        </div>`;document.body.insertAdjacentHTML("beforeend",modalHtml);const modal=document.querySelector(".banner-modal");const modalImage=modal.querySelector(".banner-modal-image");const modalCounter=modal.querySelector(".banner-modal-counter");const closeBtn=modal.querySelector(".banner-modal-close");const prevBtn=modal.querySelector(".banner-modal-prev");const nextBtn=modal.querySelector(".banner-modal-next");const modalDots=modal.querySelectorAll(".banner-modal-dot");const modalDotsWrap=modal.querySelector(".banner-modal-dots");let currentModalIndex=startIndex;function updateModalSlide(index){modalImage.src=imageUrls[index];modalCounter.textContent=`${index+1}/${imageUrls.length}`;currentModalIndex=index;if(modalDots&&modalDots.length){modalDots.forEach((d,i)=>{if(i===index)d.classList.add("active");else d.classList.remove("active")})}}closeBtn.addEventListener("click",()=>{modal.remove()});modal.addEventListener("click",e=>{if(e.target===modal)modal.remove()});prevBtn.addEventListener("click",()=>{const newIndex=currentModalIndex===0?imageUrls.length-1:currentModalIndex-1;updateModalSlide(newIndex)});nextBtn.addEventListener("click",()=>{const newIndex=currentModalIndex===imageUrls.length-1?0:currentModalIndex+1;updateModalSlide(newIndex)});if(modalDots&&modalDots.length){modalDots.forEach(dot=>{dot.addEventListener("click",()=>{const idx=parseInt(dot.getAttribute("data-index"),10)||0;updateModalSlide(idx)})})}if(imageUrls.length<=1){if(prevBtn)prevBtn.style.display="none";if(nextBtn)nextBtn.style.display="none";if(modalDotsWrap)modalDotsWrap.style.display="none"}const handleKey=e=>{if(e.key==="Escape"){modal.remove();document.removeEventListener("keydown",handleKey);return}if(e.key==="ArrowLeft"){const newIndex=currentModalIndex===0?imageUrls.length-1:currentModalIndex-1;updateModalSlide(newIndex);return}if(e.key==="ArrowRight"){const newIndex=currentModalIndex===imageUrls.length-1?0:currentModalIndex+1;updateModalSlide(newIndex);return}};document.addEventListener("keydown",handleKey)}function openClinicDetailModal(rank){closeClinicDetailModal();const target=document.getElementById(`clinic${rank}`);if(!target)return;const contentRoot=target.querySelector(".ranking_box_in")||target;const contentHtml=contentRoot.outerHTML;let clinicNameForHeader="クリニック";try{const clinicIdAttr=target.getAttribute("data-clinic-id");if(clinicIdAttr&&window.dataManager&&Array.isArray(window.dataManager.clinics)){const c=window.dataManager.clinics.find(x=>String(x.id)===String(clinicIdAttr));if(c&&c.name)clinicNameForHeader=c.name}if(clinicNameForHeader==="クリニック"){const nameFromDom=target.querySelector(".ranking__name a")?.textContent?.replace(/\s*＞\s*$/,"")?.trim();if(nameFromDom)clinicNameForHeader=nameFromDom}}catch(_){}const overlayHtml='<div class="clinic-detail-overlay"></div>';const modalHtml=`\n        <div class="clinic-detail-modal" role="dialog" aria-modal="true" aria-label="${clinicNameForHeader}の詳細">\n            <button class="clinic-detail-close" aria-label="閉じる">&times;</button>\n            <header>\n                <div style="font-size:17px;color:#333;">${clinicNameForHeader}の詳細</div>\n            </header>\n            <div class="clinic-detail-body">\n                ${contentHtml}\n            </div>\n        </div>`;document.body.insertAdjacentHTML("beforeend",overlayHtml+modalHtml);const overlay=document.querySelector(".clinic-detail-overlay");const modal=document.querySelector(".clinic-detail-modal");if(modal){const modalSliders=modal.querySelectorAll(".banner-slider");modalSliders.forEach(s=>{s.removeAttribute("data-initialized")})}requestAnimationFrame(()=>{overlay?.classList.add("active");modal?.classList.add("active");document.body.classList.add("no-scroll");try{initializeBannerSliders()}catch(_){}try{initializeCaseSliderIn(modal)}catch(_){}});const cleanup=()=>{closeClinicDetailModal()};overlay?.addEventListener("click",cleanup);modal?.querySelector(".clinic-detail-close")?.addEventListener("click",cleanup);const onKey=e=>{if(e.key==="Escape")cleanup()};document.addEventListener("keydown",onKey,{once:true})}function closeClinicDetailModal(){const overlay=document.querySelector(".clinic-detail-overlay");const modal=document.querySelector(".clinic-detail-modal");if(overlay)overlay.parentNode.removeChild(overlay);if(modal)modal.parentNode.removeChild(modal);document.body.classList.remove("no-scroll")}document.addEventListener("click",function(e){try{const clickedSlide=e.target&&e.target.closest&&e.target.closest(".case-slide");const targetImg=e.target&&e.target.closest&&e.target.closest(".case-slide img")||clickedSlide&&clickedSlide.querySelector&&clickedSlide.querySelector("img");if(!clickedSlide&&!targetImg)return;const container=(clickedSlide||targetImg).closest(".case-slider, .case-carousel-container");if(!container)return;const imgs=Array.from(container.querySelectorAll(".case-slide img"));if(!imgs.length)return;const urls=imgs.map(img=>img&&img.src).filter(Boolean);if(!urls.length)return;let startIndex=0;if(targetImg){startIndex=Math.max(0,imgs.indexOf(targetImg))}else if(clickedSlide){const idx=Array.from(container.querySelectorAll(".case-slide")).indexOf(clickedSlide);startIndex=Math.max(0,idx)}e.preventDefault();e.stopPropagation();if(typeof createAndShowModal==="function"){createAndShowModal(urls,startIndex)}}catch(_){}},true);function initializeScrollModal(){const existingModal=document.querySelector(".scroll-bottom-modal");if(existingModal)existingModal.remove();let clinicLogoUrl="";let clinicUrl="#ranking";const firstRankingItem=document.querySelector('#clinic1, .ranking_box[data-rank="1"], .ranking-item.rank-1, #ranking-list .ranking-item');console.log("First ranking item:",firstRankingItem);let clinicName="";if(firstRankingItem){const clinicNameElement=firstRankingItem.querySelector(".ranking__name a, .clinic-name, .clinic-logo-section h3");if(clinicNameElement){clinicName=clinicNameElement.textContent.replace(/\s*＞\s*$/,"").trim()}const clinicId=firstRankingItem.getAttribute("data-clinic-id")||firstRankingItem.id?.replace("clinic","");if(clinicId){const urlHandler=new UrlParamHandler;clinicUrl=urlHandler.getClinicUrlWithRegionId(clinicId,1)}}if(clinicName){const clinicMap={"TCB東京中央美容外科":"tcb/tcb-logo.webp","リゼクリニック":"rize/rize-logo.webp","湘南美容クリニック":"sbc/sbc-logo.webp","レジーナクリニック":"regina/regina-logo.webp","品川美容外科":"shinagawa/shinagawa-logo.webp"};const logoPath=clinicMap[clinicName];if(logoPath){clinicLogoUrl=`/common_data/images/clinics/${logoPath}`}}if(!clinicLogoUrl&&firstRankingItem){const logoImg=firstRankingItem.querySelector(".ranking__logo img, .clinic-logo, .clinic-banner img");if(logoImg&&logoImg.src){clinicLogoUrl=logoImg.src}}if(!clinicLogoUrl&&window.dataManager){const firstClinic=document.querySelector('[data-rank="1"], .ranking-item.rank-1');if(firstClinic){const clinicId=firstClinic.getAttribute("data-clinic-id");const clinicCode=window.dataManager.getClinicCodeById(clinicId);if(clinicCode){clinicLogoUrl=window.dataManager.getClinicText(clinicCode,"ロゴ","")}}}if(!clinicLogoUrl){clinicLogoUrl="./images/logo-placeholder.png"}let bubbleText="今なら特別キャンペーン実施中！";try{const firstClinicForText=document.querySelector('[data-rank="1"], .ranking-item.rank-1, #clinic1, .ranking_box[data-rank="1"]');let clinicIdForText=null;if(firstClinicForText){clinicIdForText=firstClinicForText.getAttribute("data-clinic-id")||firstClinicForText.id?.replace("clinic","")}if(clinicIdForText&&window.dataManager){const code=window.dataManager.getClinicCodeById(clinicIdForText);if(code){const t=window.dataManager.getClinicText(code,"footer-modal1",bubbleText);if(t)bubbleText=t}}}catch(e){console.warn("footer-modal1 テキスト取得に失敗:",e)}const modalHtml=`\n        <div class="scroll-bottom-modal">\n            <div class="scroll-modal-bubble">\n                <span>${bubbleText}</span>\n            </div>\n            \n            <div class="scroll-modal-content">\n                <div class="scroll-modal-left">\n                    <button class="scroll-modal-close" aria-label="閉じる">&times;</button>\n                    <img src="${clinicLogoUrl}" alt="1位クリニック" class="scroll-modal-logo">\n                </div>\n                <a href="${clinicUrl}" class="scroll-modal-btn" onclick="if(window.handleClinicClick) handleClinicClick(event, this);">\n                    <span class="scroll-modal-btn-free">無料</span>\n                    <span class="scroll-modal-btn-text">\n                        <span>カウンセリングを</span>\n                        <span>予約する</span>\n                    </span>\n                    <span class="scroll-modal-btn-arrow" aria-hidden="true">▶</span>\n                </a>\n            </div>\n        </div>`;document.body.insertAdjacentHTML("beforeend",modalHtml);const modal=document.querySelector(".scroll-bottom-modal");const closeBtn=modal.querySelector(".scroll-modal-close");if(!modal||!closeBtn){console.error("Modal elements not found");return}let hasShown=false;let isClosed=false;function showModal(){if(!hasShown&&!isClosed){modal.classList.add("show");hasShown=true}}function hideModal(){modal.classList.remove("show");isClosed=true}closeBtn.addEventListener("click",hideModal);function checkScroll(){if(isClosed)return;const scrollTop=window.pageYOffset||document.documentElement.scrollTop;const windowHeight=window.innerHeight;const documentHeight=document.documentElement.scrollHeight;const scrollPercentage=scrollTop/(documentHeight-windowHeight)*100;if(scrollPercentage>=6.5){showModal()}}window.addEventListener("scroll",checkScroll);setTimeout(()=>{checkScroll()},100)}function initializeCaseSliderIn(root){if(!root)return;const slider=root.querySelector(".case-slider");if(!slider)return;const track=slider.querySelector(".case-track");if(!track)return;let slides=Array.from(slider.querySelectorAll(".case-slide"));const dotsWrap=root.querySelector(".case-dots");let dots=Array.from(root.querySelectorAll(".case-dot"));const prevBtn=slider.querySelector(".case-nav-prev");const nextBtn=slider.querySelector(".case-nav-next");if(!slides.length)return;let current=0;const reindex=()=>{slides=Array.from(slider.querySelectorAll(".case-slide"));dots=Array.from(root.querySelectorAll(".case-dot"));dots.forEach((d,i)=>d.setAttribute("data-index",String(i)))};const updateNavVisibility=()=>{const show=slides.length>1;if(prevBtn)prevBtn.style.display=show?"":"none";if(nextBtn)nextBtn.style.display=show?"":"none";if(dotsWrap)dotsWrap.style.display=show?"block":"none"};const show=i=>{if(!slides.length||!track)return;if(i<0)i=slides.length-1;if(i>=slides.length)i=0;current=i;track.style.display="flex";track.style.transform=`translateX(-${current*100}%)`;track.style.transition="transform .3s ease";slides.forEach(s=>{s.style.minWidth="100%";s.style.boxSizing="border-box"});dots.forEach((d,idx)=>{d.classList.toggle("active",idx===current);d.style.background=idx===current?"#2CC7C5":"#ccc"})};const imgs=Array.from(slider.querySelectorAll("img"));imgs.forEach(img=>{img.addEventListener("error",()=>{const slide=img.closest(".case-slide");if(!slide)return;const idx=slides.indexOf(slide);if(idx>=0){const dot=dots[idx];if(dot&&dot.parentNode)dot.parentNode.removeChild(dot);if(slide&&slide.parentNode)slide.parentNode.removeChild(slide);reindex();if(!slides.length)return;if(current>=slides.length)current=slides.length-1;updateNavVisibility();show(current)}},{once:true})});prevBtn&&prevBtn.addEventListener("click",()=>show(current-1));nextBtn&&nextBtn.addEventListener("click",()=>show(current+1));dots.forEach((d,idx)=>d.addEventListener("click",ev=>{ev.preventDefault();ev.stopPropagation();show(idx)}));if(dotsWrap){dotsWrap.addEventListener("click",e=>{const el=e.target&&e.target.nodeType===1?e.target:e.target&&e.target.parentElement;if(!el)return;const dot=el.closest&&el.closest(".case-dot");if(!dot)return;e.preventDefault();e.stopPropagation();const idxAttr=dot.getAttribute("data-index");const idx=idxAttr?parseInt(idxAttr,10):Array.from(dotsWrap.querySelectorAll(".case-dot")).indexOf(dot);if(idx>=0)show(idx)},{capture:true})}updateNavVisibility();show(0)}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",function(){setTimeout(()=>{initializeScrollModal()},2e3)})}else{setTimeout(()=>{initializeScrollModal()},2e3)}