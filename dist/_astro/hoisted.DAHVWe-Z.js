function D(i){return new Promise((d,t)=>{const o=document.createElement("script");o.src=i,o.onload=d,o.onerror=t,document.head.appendChild(o)})}async function M(){try{await D("/config.js");class i{constructor(){this.clinicTexts={},this.clinics=[]}async loadClinicTexts(){try{const t=await this.fetchJsonWithFallback(["/data/clinic-texts.json","/data/clinic_text/clinic-texts.json"]);if(t&&typeof t=="object"&&!Array.isArray(t)){this.clinicTexts=t,console.log("✅ clinic-texts.json 読み込み完了");return}}catch(t){console.warn("⚠️ clinic-texts.json の読み込みに失敗しました:",t)}try{let t=await fetch("/data/clinic-texts.csv");if(t.ok||(t=await fetch("/data/clinic_text/clinic-texts.csv")),!t.ok)throw new Error(`Failed to load clinic-texts.csv: ${t.status}`);const o=await t.arrayBuffer();let a="";try{a=new TextDecoder("utf-8").decode(o)}catch{}const g=(a.match(/\uFFFD|�/g)||[]).length;if(!a||g>10)try{a=new TextDecoder("shift_jis").decode(o)}catch{}const r=this.parseCsvWithQuotes(a);if(!r||r.length===0){console.warn("⚠️ clinic-texts.csv にレコードがありません"),this.clinicTexts={};return}const m=r[0].slice(3).map(p=>(p||"").trim()).filter(Boolean),s={},h={},C={};m.forEach(p=>s[p]={});for(let p=1;p<r.length;p++){const w=r[p];if(!w||w.length===0)continue;const x=(w[0]||"").trim(),_=(w[1]||"").trim();if(!(!x||!_))if(x.startsWith("comparison")){const c=x.replace("comparison","");h[`比較表ヘッダー${c}`]=_;for(let f=0;f<m.length;f++){const P=m[f];s[P][_]=w[f+3]||""}}else if(x.startsWith("detail")){let c="";switch(_){case"費用":c="priceDetail";break;case"目安期間":c="periods";break;case"矯正範囲":c="ranges";break;case"営業時間":c="hours";break;case"店舗":c="stores";break;case"特徴タグ":c="featureTags";break;default:c=_;break}c&&c!=="特徴タグ"&&(C[c]=_);for(let f=0;f<m.length;f++){const P=m[f];s[P][`詳細_${_}`]=w[f+3]||""}}else if(x.startsWith("tags"))for(let c=0;c<m.length;c++){const f=m[c];s[f][`詳細_${_}`]=w[c+3]||""}else if(x.startsWith("meta"))for(let c=0;c<m.length;c++){const f=m[c];s[f][_]=w[c+3]||""}else for(let c=0;c<m.length;c++){const f=m[c];s[f][_]=w[c+3]||""}}const S={};S.比較表ヘッダー設定=h,S.詳細フィールドマッピング=C,S.詳細フィールドマッピング.officialSite="公式サイトURL",Object.keys(s).forEach(p=>S[p]=s[p]),this.clinicTexts=S,console.log("✅ clinic-texts.csv 読み込み完了")}catch(t){console.error("❌ clinic-texts.csv の読み込み/変換エラー:",t),this.clinicTexts={}}}parseCsvWithQuotes(t){const o=t.split(/\r?\n/),a=[];for(let g=0;g<o.length;g++){const r=o[g];if(r==null)continue;const l=String(r);if(!l.trim())continue;const m=[];let s="",h=!1;for(let C=0;C<l.length;C++){const S=l[C];S==='"'?h&&l[C+1]==='"'?(s+='"',C++):h=!h:S===","&&!h?(m.push(s),s=""):s+=S}m.push(s),a.push(m)}return a}async loadCompiledData(){console.log("📊 クリニック一覧データを読み込み中...");try{const t=await this.fetchJsonWithFallback(["/common_data/data/出しわけSS - items.json","/data/出しわけSS - items.json"]);if(Array.isArray(t)&&t.length>0){this.clinics=t.map(o=>({id:String(o.clinic_id||o.id||""),name:o.clinic_name||o.name||"",code:o.code||o.clinic_code||""})).filter(o=>o.id&&o.name),console.log("📊 クリニックJSON数:",this.clinics.length);return}}catch(t){console.warn("⚠️ クリニックJSON読み込みエラー:",t)}try{const t=await this.loadCsv("/common_data/data/出しわけSS - items.csv");this.clinics=t.map(o=>({id:o.clinic_id,name:o.clinic_name,code:o.code})),console.log("📊 クリニックCSV数:",this.clinics.length)}catch(t){console.error("❌ クリニック一覧CSV読み込みエラー:",t),this.clinics=[]}}async fetchJsonWithFallback(t=[]){for(const o of t)if(o)try{const a=await fetch(o);if(!a||!a.ok)continue;const g=await a.text();if(!g)continue;const r=g.replace(/^\uFEFF/,"").trim();if(!r)continue;return JSON.parse(r)}catch{}return null}async loadCsv(t){const a=await(await fetch(t)).arrayBuffer();let g=new TextDecoder("utf-8").decode(a);if((g.match(/\uFFFD|�/g)||[]).length>10)try{g=new TextDecoder("shift_jis").decode(a)}catch{}return this.csvToObjects(g)}csvToObjects(t){const o=this.parseCsvWithQuotes(t);if(!o.length)return[];const a=o[0].map(r=>(r||"").trim()),g=[];for(let r=1;r<o.length;r++){const l=o[r];if(!l||l.every(s=>(s||"").trim()===""))continue;const m={};a.forEach((s,h)=>m[s]=(l[h]||"").trim()),g.push(m)}return g}getClinicText(t,o,a=""){const g=this.getClinicNameByCode(t);if(!g||!this.clinicTexts[g])return console.log(`⚠️  クリニックデータが見つかりません: code=${t}, name=${g}`),a;const r=this.clinicTexts[g][o];return r||(console.log(`⚠️  フィールドが見つかりません: ${g}.${o}`),a)}getClinicNameByCode(t){const o=(this.clinics||[]).find(a=>a.code===t);return o?o.name:null}getClinicById(t){return this.clinics.find(o=>o.id==t)}getClinicCodeById(t){const o=this.getClinicById(t);return o?o.code:null}}return window.dataManager=new i,await window.dataManager.loadClinicTexts(),await window.dataManager.loadCompiledData(),!0}catch(i){return console.error("DataManager initialization failed:",i),!1}}async function O(){console.log("🚀 リダイレクト処理開始");let i=null,d=null,t=null;const o=localStorage.getItem("redirectParams");if(o)try{const e=JSON.parse(o);i=e.clinic_id,d=e.rank,t=e.region_id,console.log("方法1 localStorage（優先）:",{clinicId:i,rank:d,regionId:t}),localStorage.removeItem("redirectParams")}catch(e){console.error("localStorage解析エラー:",e)}if(!i&&window.location.hash){const e=window.location.hash.substring(1);if(e.startsWith("params="))try{const n=decodeURIComponent(e.substring(7)),u=JSON.parse(n);i=u.clinic_id,d=u.rank,t=u.region_id,console.log("方法2 ハッシュ（新形式）:",{clinicId:i,rank:d,regionId:t})}catch(n){console.error("ハッシュ解析エラー:",n)}else{const n=new URLSearchParams(e);i=n.get("clinic_id"),d=n.get("rank"),t=n.get("region_id"),console.log("方法2 ハッシュ（旧形式）:",{clinicId:i,rank:d,regionId:t})}}if(!i){const e=new URLSearchParams(window.location.search);i=e.get("clinic_id"),d=e.get("rank"),t=e.get("region_id"),console.log("方法3 URLSearchParams:",{clinicId:i,rank:d,regionId:t})}if(!i){const e=window.location.href,n=e.match(/[?&#]clinic_id=([^&#]+)/);if(n){i=n[1];const u=e.match(/[?&#]rank=([^&#]+)/),v=e.match(/[?&#]region_id=([^&#]+)/);d=u?u[1]:null,t=v?v[1]:null,console.log("方法3 正規表現:",{clinicId:i,rank:d,regionId:t})}}if(!i){const e=localStorage.getItem("redirectParams");if(e)try{const n=JSON.parse(e);i=n.clinic_id,d=n.rank,t=n.region_id,console.log("方法4 localStorage:",{clinicId:i,rank:d,regionId:t}),localStorage.removeItem("redirectParams")}catch(n){console.error("localStorage解析エラー:",n)}}if(!i){const e=sessionStorage.getItem("redirectParams");if(e)try{const n=JSON.parse(e);i=n.clinic_id,d=n.rank,t=n.region_id,console.log("方法5 sessionStorage:",{clinicId:i,rank:d,regionId:t}),sessionStorage.removeItem("redirectParams")}catch(n){console.error("sessionStorage解析エラー:",n)}}const a=new URL(window.location.href);if(console.log("📍 現在の完全URL:",a.toString()),console.log("📍 location.search:",window.location.search),console.log("📍 location.hash:",window.location.hash),d=parseInt(d)||1,console.log("📋 受け取ったパラメータ:"),console.log(`  clinic_id: ${i}`),console.log(`  rank: ${d}`),console.log(`  region_id: ${t}`),console.log(`  現在のURL: ${window.location.href}`),i||(console.error("❌ clinic_idが見つかりません"),console.error("  URL:",window.location.href),console.error("  Search:",window.location.search),i="1",d=1,console.log("⚠️ フォールバック: clinic_id=1を使用")),console.log("🔄 データマネージャー初期化中..."),!await M()){console.error("❌ データマネージャーの初期化に失敗"),window.location.href="./index.html";return}console.log("✅ データマネージャー初期化完了");const r=window.dataManager.getClinicById(i),l=window.dataManager.getClinicCodeById(i);if(console.log("🏥 クリニック情報:"),console.log(`  clinic: ${r?r.name:"not found"}`),console.log(`  clinicCode: ${l||"not found"}`),!r||!l){console.error("❌ クリニック情報が見つかりません"),window.location.href="./index.html";return}const m=`遷移先URL（${d}位）`;let s=window.dataManager.getClinicText(l,m,"");if(console.log("🔍 URL取得情報:"),console.log(`  クリニックコード: ${l}`),console.log(`  ランキング順位: ${d}`),console.log(`  URLフィールド名: ${m}`),console.log(`  取得したURL: ${s}`),s||(console.log("⚠️ フォールバック: 1位のURLを使用"),s=window.dataManager.getClinicText(l,"遷移先URL（1位）",""),console.log(`  フォールバックURL: ${s}`)),!s){console.error("❌ URLが見つかりません"),console.error("❌ 利用可能なURLフィールド:",Object.keys(window.dataManager.clinicTexts));const e={};for(let n=1;n<=5;n++){const u=`遷移先URL（${n}位）`,v=window.dataManager.getClinicText(l,u,"");v&&(e[u]=v)}console.log("❌ 利用可能なURL:",e),window.location.href="./index.html";return}const h=new URL(s),S=window.location.href.split("?")[0],p={click_section:a.searchParams.get("click_section")||"",click_clinic:a.searchParams.get("click_clinic")||l,source_page:a.searchParams.get("source_page")||"potenza",region_id:t||"013",referrer_url:S,timestamp:new Date().toISOString()};let w,x=new URLSearchParams;try{if(document.referrer&&document.referrer!==window.location.href)w=new URL(document.referrer),console.log("🔍 元ページURL (referrer):",w.toString());else throw new Error("referrer unavailable")}catch{console.log("⚠️ referrer取得失敗"),w=a}try{const e=localStorage.getItem("redirectParams");if(e){const n=JSON.parse(e);console.log("🔍 localStorage params:",n),n.original_params&&(Object.entries(n.original_params).forEach(([u,v])=>{x.set(u,v)}),console.log("✅ 元URLパラメータ復元:",x.toString()))}}catch{console.log("⚠️ localStorage パラメータ復元失敗")}function _(e){const n=x.get(e);if(n)return console.log(`🔍 ${e} (復元):`,n),n;const u=w.searchParams.get(e);return u?(console.log(`🔍 ${e} (referrer):`,u),u):(console.log(`⚠️ ${e} 取得失敗`),"")}const c=_("utm_creative");c?(h.searchParams.set("param2",c),console.log("✅ param2設定:",c)):console.log("⚠️ utm_creativeが空のためparam2は設定されません");const f=_("gclid");f?(h.searchParams.set("param3",f),h.searchParams.set("gclid",f),console.log("✅ param3設定:",f),console.log("✅ gclid設定:",f)):console.log("⚠️ gclidが空のためparam3とgclidは設定されません"),h.searchParams.set("param4",encodeURIComponent(JSON.stringify(p))),t&&h.searchParams.set("region_id",t);function P(){const e=navigator.userAgent.toLowerCase();return e.includes("mobile")||e.includes("android")||e.includes("iphone")?"m":e.includes("tablet")||e.includes("ipad")?"t":"c"}const I={utm_source:"google",utm_medium:"cpc",utm_campaign:"{campaignid}",utm_term:"{keyword}"},R=P();h.searchParams.set("device",R),console.log("📱 device設定:",R),Object.entries(I).forEach(([e,n])=>{const u=_(e),v=u||n;h.searchParams.set(e,v),console.log(`🏷️ ${e}設定:`,v,u?"(元URLパラメータ由来)":"(デフォルト)")}),c?(h.searchParams.set("utm_creative",c),console.log("🏷️ utm_creative設定:",c,"(元ページURL由来)")):(h.searchParams.set("utm_creative","{creative}"),console.log("🏷️ utm_creative設定: {creative} (デフォルト)")),["utm_content"].forEach(e=>{const n=w.searchParams.get(e);n&&(h.searchParams.set(e,n),console.log(`🏷️ ${e}設定:`,n,"(元ページURL由来)"))});const y=h.toString(),U=document.getElementById("clinic-logo"),T=document.getElementById("redirect-message"),j=document.getElementById("redirect-description"),$=document.getElementById("manual-link");T.textContent=`${r.name}公式サイトへ移動中...`,j.innerHTML=`まもなく自動的に${r.name}の公式サイトへリダイレクトします。<br>移動しない場合は下のボタンをクリックしてください。`,$.textContent=`${r.name}公式サイトへ`,$.href=y,$.style.display="inline-block";try{const e=window.dataManager&&window.dataManager.getClinicText(l,"meta13","");U.src=e||`/images/clinics/${l}/${l}-logo.webp`}catch{U.src=`/images/clinics/${l}/${l}-logo.webp`}U.alt=r.name,U.style.display="block",U.onerror=function(){const e=`/images/clinics/${l}/${l}-logo.jpg`;this.src=e,this.onerror=function(){this.style.display="none"}},document.title=`${r.name}公式サイトへ移動中...`;let k=2;const L=document.getElementById("countdown"),b=setInterval(()=>{k--,k>0?L.textContent=`${k}秒後に移動します...`:(L.textContent="移動中...",clearInterval(b),setTimeout(()=>{if(console.log("📤 リダイレクト実行準備完了"),console.log(`  遷移元: ${window.location.href}`),console.log(`  遷移先: ${y}`),console.log(`  最終URL検証: ${y.startsWith("http")}`),y.includes("param4=")){const e=y.match(/param4=([^&]*)/);if(e&&e[1])try{const n=JSON.parse(decodeURIComponent(e[1]));console.log("✅ param4設定済み:",n)}catch{console.log("✅ param4設定済み (デコード不可):",e[1])}else console.log("⚠️ param4は存在するが値が空")}else console.log("❌ param4がURLに含まれていません");if(!y||y==="#"||!y.startsWith("http")){console.error("❌ 無効なURL:",y);return}try{console.log("🚀 window.location.href実行中..."),window.location.href=y,console.log("✅ リダイレクト命令完了")}catch(e){console.error("❌ リダイレクトエラー:",e)}setTimeout(()=>{window.location.href.includes("/redirect.html")&&(console.log("⚠️ フォールバックリダイレクト実行"),window.location.replace(y))},100)},100))},100);setTimeout(()=>{window.location.href.includes("/redirect.html")&&(L.textContent="自動移動に時間がかかっています。下のボタンをクリックしてください。",L.style.color="#ff6b6b")},5e3),$.addEventListener("click",e=>{e.preventDefault(),clearInterval(b),window.location.href=y})}document.addEventListener("DOMContentLoaded",O);
