function D(i){return new Promise((d,t)=>{const o=document.createElement("script");o.src=i,o.onload=d,o.onerror=t,document.head.appendChild(o)})}async function M(){try{await D("/config.js");class i{constructor(){this.clinicTexts={},this.clinics=[]}async loadClinicTexts(){try{const t=await this.fetchJsonWithFallback(["/data/clinic-texts.json","/data/clinic_text/clinic-texts.json"]);if(t&&typeof t=="object"&&!Array.isArray(t)){this.clinicTexts=t,console.log("âœ… clinic-texts.json èª­ã¿è¾¼ã¿å®Œäº†");return}}catch(t){console.warn("âš ï¸ clinic-texts.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:",t)}try{let t=await fetch("/data/clinic-texts.csv");if(t.ok||(t=await fetch("/data/clinic_text/clinic-texts.csv")),!t.ok)throw new Error(`Failed to load clinic-texts.csv: ${t.status}`);const o=await t.arrayBuffer();let a="";try{a=new TextDecoder("utf-8").decode(o)}catch{}const g=(a.match(/\uFFFD|ï¿½/g)||[]).length;if(!a||g>10)try{a=new TextDecoder("shift_jis").decode(o)}catch{}const r=this.parseCsvWithQuotes(a);if(!r||r.length===0){console.warn("âš ï¸ clinic-texts.csv ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“"),this.clinicTexts={};return}const m=r[0].slice(3).map(p=>(p||"").trim()).filter(Boolean),s={},h={},C={};m.forEach(p=>s[p]={});for(let p=1;p<r.length;p++){const w=r[p];if(!w||w.length===0)continue;const x=(w[0]||"").trim(),_=(w[1]||"").trim();if(!(!x||!_))if(x.startsWith("comparison")){const c=x.replace("comparison","");h[`æ¯”è¼ƒè¡¨ãƒ˜ãƒƒãƒ€ãƒ¼${c}`]=_;for(let f=0;f<m.length;f++){const P=m[f];s[P][_]=w[f+3]||""}}else if(x.startsWith("detail")){let c="";switch(_){case"è²»ç”¨":c="priceDetail";break;case"ç›®å®‰æœŸé–“":c="periods";break;case"çŸ¯æ­£ç¯„å›²":c="ranges";break;case"å–¶æ¥­æ™‚é–“":c="hours";break;case"åº—èˆ—":c="stores";break;case"ç‰¹å¾´ã‚¿ã‚°":c="featureTags";break;default:c=_;break}c&&c!=="ç‰¹å¾´ã‚¿ã‚°"&&(C[c]=_);for(let f=0;f<m.length;f++){const P=m[f];s[P][`è©³ç´°_${_}`]=w[f+3]||""}}else if(x.startsWith("tags"))for(let c=0;c<m.length;c++){const f=m[c];s[f][`è©³ç´°_${_}`]=w[c+3]||""}else if(x.startsWith("meta"))for(let c=0;c<m.length;c++){const f=m[c];s[f][_]=w[c+3]||""}else for(let c=0;c<m.length;c++){const f=m[c];s[f][_]=w[c+3]||""}}const S={};S.æ¯”è¼ƒè¡¨ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š=h,S.è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°=C,S.è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°.officialSite="å…¬å¼ã‚µã‚¤ãƒˆURL",Object.keys(s).forEach(p=>S[p]=s[p]),this.clinicTexts=S,console.log("âœ… clinic-texts.csv èª­ã¿è¾¼ã¿å®Œäº†")}catch(t){console.error("âŒ clinic-texts.csv ã®èª­ã¿è¾¼ã¿/å¤‰æ›ã‚¨ãƒ©ãƒ¼:",t),this.clinicTexts={}}}parseCsvWithQuotes(t){const o=t.split(/\r?\n/),a=[];for(let g=0;g<o.length;g++){const r=o[g];if(r==null)continue;const l=String(r);if(!l.trim())continue;const m=[];let s="",h=!1;for(let C=0;C<l.length;C++){const S=l[C];S==='"'?h&&l[C+1]==='"'?(s+='"',C++):h=!h:S===","&&!h?(m.push(s),s=""):s+=S}m.push(s),a.push(m)}return a}async loadCompiledData(){console.log("ğŸ“Š ã‚¯ãƒªãƒ‹ãƒƒã‚¯ä¸€è¦§ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...");try{const t=await this.fetchJsonWithFallback(["/common_data/data/å‡ºã—ã‚ã‘SS - items.json","/data/å‡ºã—ã‚ã‘SS - items.json"]);if(Array.isArray(t)&&t.length>0){this.clinics=t.map(o=>({id:String(o.clinic_id||o.id||""),name:o.clinic_name||o.name||"",code:o.code||o.clinic_code||""})).filter(o=>o.id&&o.name),console.log("ğŸ“Š ã‚¯ãƒªãƒ‹ãƒƒã‚¯JSONæ•°:",this.clinics.length);return}}catch(t){console.warn("âš ï¸ ã‚¯ãƒªãƒ‹ãƒƒã‚¯JSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",t)}try{const t=await this.loadCsv("/common_data/data/å‡ºã—ã‚ã‘SS - items.csv");this.clinics=t.map(o=>({id:o.clinic_id,name:o.clinic_name,code:o.code})),console.log("ğŸ“Š ã‚¯ãƒªãƒ‹ãƒƒã‚¯CSVæ•°:",this.clinics.length)}catch(t){console.error("âŒ ã‚¯ãƒªãƒ‹ãƒƒã‚¯ä¸€è¦§CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",t),this.clinics=[]}}async fetchJsonWithFallback(t=[]){for(const o of t)if(o)try{const a=await fetch(o);if(!a||!a.ok)continue;const g=await a.text();if(!g)continue;const r=g.replace(/^\uFEFF/,"").trim();if(!r)continue;return JSON.parse(r)}catch{}return null}async loadCsv(t){const a=await(await fetch(t)).arrayBuffer();let g=new TextDecoder("utf-8").decode(a);if((g.match(/\uFFFD|ï¿½/g)||[]).length>10)try{g=new TextDecoder("shift_jis").decode(a)}catch{}return this.csvToObjects(g)}csvToObjects(t){const o=this.parseCsvWithQuotes(t);if(!o.length)return[];const a=o[0].map(r=>(r||"").trim()),g=[];for(let r=1;r<o.length;r++){const l=o[r];if(!l||l.every(s=>(s||"").trim()===""))continue;const m={};a.forEach((s,h)=>m[s]=(l[h]||"").trim()),g.push(m)}return g}getClinicText(t,o,a=""){const g=this.getClinicNameByCode(t);if(!g||!this.clinicTexts[g])return console.log(`âš ï¸  ã‚¯ãƒªãƒ‹ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: code=${t}, name=${g}`),a;const r=this.clinicTexts[g][o];return r||(console.log(`âš ï¸  ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${g}.${o}`),a)}getClinicNameByCode(t){const o=(this.clinics||[]).find(a=>a.code===t);return o?o.name:null}getClinicById(t){return this.clinics.find(o=>o.id==t)}getClinicCodeById(t){const o=this.getClinicById(t);return o?o.code:null}}return window.dataManager=new i,await window.dataManager.loadClinicTexts(),await window.dataManager.loadCompiledData(),!0}catch(i){return console.error("DataManager initialization failed:",i),!1}}async function O(){console.log("ğŸš€ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†é–‹å§‹");let i=null,d=null,t=null;const o=localStorage.getItem("redirectParams");if(o)try{const e=JSON.parse(o);i=e.clinic_id,d=e.rank,t=e.region_id,console.log("æ–¹æ³•1 localStorageï¼ˆå„ªå…ˆï¼‰:",{clinicId:i,rank:d,regionId:t}),localStorage.removeItem("redirectParams")}catch(e){console.error("localStorageè§£æã‚¨ãƒ©ãƒ¼:",e)}if(!i&&window.location.hash){const e=window.location.hash.substring(1);if(e.startsWith("params="))try{const n=decodeURIComponent(e.substring(7)),u=JSON.parse(n);i=u.clinic_id,d=u.rank,t=u.region_id,console.log("æ–¹æ³•2 ãƒãƒƒã‚·ãƒ¥ï¼ˆæ–°å½¢å¼ï¼‰:",{clinicId:i,rank:d,regionId:t})}catch(n){console.error("ãƒãƒƒã‚·ãƒ¥è§£æã‚¨ãƒ©ãƒ¼:",n)}else{const n=new URLSearchParams(e);i=n.get("clinic_id"),d=n.get("rank"),t=n.get("region_id"),console.log("æ–¹æ³•2 ãƒãƒƒã‚·ãƒ¥ï¼ˆæ—§å½¢å¼ï¼‰:",{clinicId:i,rank:d,regionId:t})}}if(!i){const e=new URLSearchParams(window.location.search);i=e.get("clinic_id"),d=e.get("rank"),t=e.get("region_id"),console.log("æ–¹æ³•3 URLSearchParams:",{clinicId:i,rank:d,regionId:t})}if(!i){const e=window.location.href,n=e.match(/[?&#]clinic_id=([^&#]+)/);if(n){i=n[1];const u=e.match(/[?&#]rank=([^&#]+)/),v=e.match(/[?&#]region_id=([^&#]+)/);d=u?u[1]:null,t=v?v[1]:null,console.log("æ–¹æ³•3 æ­£è¦è¡¨ç¾:",{clinicId:i,rank:d,regionId:t})}}if(!i){const e=localStorage.getItem("redirectParams");if(e)try{const n=JSON.parse(e);i=n.clinic_id,d=n.rank,t=n.region_id,console.log("æ–¹æ³•4 localStorage:",{clinicId:i,rank:d,regionId:t}),localStorage.removeItem("redirectParams")}catch(n){console.error("localStorageè§£æã‚¨ãƒ©ãƒ¼:",n)}}if(!i){const e=sessionStorage.getItem("redirectParams");if(e)try{const n=JSON.parse(e);i=n.clinic_id,d=n.rank,t=n.region_id,console.log("æ–¹æ³•5 sessionStorage:",{clinicId:i,rank:d,regionId:t}),sessionStorage.removeItem("redirectParams")}catch(n){console.error("sessionStorageè§£æã‚¨ãƒ©ãƒ¼:",n)}}const a=new URL(window.location.href);if(console.log("ğŸ“ ç¾åœ¨ã®å®Œå…¨URL:",a.toString()),console.log("ğŸ“ location.search:",window.location.search),console.log("ğŸ“ location.hash:",window.location.hash),d=parseInt(d)||1,console.log("ğŸ“‹ å—ã‘å–ã£ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:"),console.log(`  clinic_id: ${i}`),console.log(`  rank: ${d}`),console.log(`  region_id: ${t}`),console.log(`  ç¾åœ¨ã®URL: ${window.location.href}`),i||(console.error("âŒ clinic_idãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"),console.error("  URL:",window.location.href),console.error("  Search:",window.location.search),i="1",d=1,console.log("âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: clinic_id=1ã‚’ä½¿ç”¨")),console.log("ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–ä¸­..."),!await M()){console.error("âŒ ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—"),window.location.href="./index.html";return}console.log("âœ… ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–å®Œäº†");const r=window.dataManager.getClinicById(i),l=window.dataManager.getClinicCodeById(i);if(console.log("ğŸ¥ ã‚¯ãƒªãƒ‹ãƒƒã‚¯æƒ…å ±:"),console.log(`  clinic: ${r?r.name:"not found"}`),console.log(`  clinicCode: ${l||"not found"}`),!r||!l){console.error("âŒ ã‚¯ãƒªãƒ‹ãƒƒã‚¯æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"),window.location.href="./index.html";return}const m=`é·ç§»å…ˆURLï¼ˆ${d}ä½ï¼‰`;let s=window.dataManager.getClinicText(l,m,"");if(console.log("ğŸ” URLå–å¾—æƒ…å ±:"),console.log(`  ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰: ${l}`),console.log(`  ãƒ©ãƒ³ã‚­ãƒ³ã‚°é †ä½: ${d}`),console.log(`  URLãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å: ${m}`),console.log(`  å–å¾—ã—ãŸURL: ${s}`),s||(console.log("âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: 1ä½ã®URLã‚’ä½¿ç”¨"),s=window.dataManager.getClinicText(l,"é·ç§»å…ˆURLï¼ˆ1ä½ï¼‰",""),console.log(`  ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯URL: ${s}`)),!s){console.error("âŒ URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"),console.error("âŒ åˆ©ç”¨å¯èƒ½ãªURLãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:",Object.keys(window.dataManager.clinicTexts));const e={};for(let n=1;n<=5;n++){const u=`é·ç§»å…ˆURLï¼ˆ${n}ä½ï¼‰`,v=window.dataManager.getClinicText(l,u,"");v&&(e[u]=v)}console.log("âŒ åˆ©ç”¨å¯èƒ½ãªURL:",e),window.location.href="./index.html";return}const h=new URL(s),S=window.location.href.split("?")[0],p={click_section:a.searchParams.get("click_section")||"",click_clinic:a.searchParams.get("click_clinic")||l,source_page:a.searchParams.get("source_page")||"potenza",region_id:t||"013",referrer_url:S,timestamp:new Date().toISOString()};let w,x=new URLSearchParams;try{if(document.referrer&&document.referrer!==window.location.href)w=new URL(document.referrer),console.log("ğŸ” å…ƒãƒšãƒ¼ã‚¸URL (referrer):",w.toString());else throw new Error("referrer unavailable")}catch{console.log("âš ï¸ referrerå–å¾—å¤±æ•—"),w=a}try{const e=localStorage.getItem("redirectParams");if(e){const n=JSON.parse(e);console.log("ğŸ” localStorage params:",n),n.original_params&&(Object.entries(n.original_params).forEach(([u,v])=>{x.set(u,v)}),console.log("âœ… å…ƒURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¾©å…ƒ:",x.toString()))}}catch{console.log("âš ï¸ localStorage ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¾©å…ƒå¤±æ•—")}function _(e){const n=x.get(e);if(n)return console.log(`ğŸ” ${e} (å¾©å…ƒ):`,n),n;const u=w.searchParams.get(e);return u?(console.log(`ğŸ” ${e} (referrer):`,u),u):(console.log(`âš ï¸ ${e} å–å¾—å¤±æ•—`),"")}const c=_("utm_creative");c?(h.searchParams.set("param2",c),console.log("âœ… param2è¨­å®š:",c)):console.log("âš ï¸ utm_creativeãŒç©ºã®ãŸã‚param2ã¯è¨­å®šã•ã‚Œã¾ã›ã‚“");const f=_("gclid");f?(h.searchParams.set("param3",f),h.searchParams.set("gclid",f),console.log("âœ… param3è¨­å®š:",f),console.log("âœ… gclidè¨­å®š:",f)):console.log("âš ï¸ gclidãŒç©ºã®ãŸã‚param3ã¨gclidã¯è¨­å®šã•ã‚Œã¾ã›ã‚“"),h.searchParams.set("param4",encodeURIComponent(JSON.stringify(p))),t&&h.searchParams.set("region_id",t);function P(){const e=navigator.userAgent.toLowerCase();return e.includes("mobile")||e.includes("android")||e.includes("iphone")?"m":e.includes("tablet")||e.includes("ipad")?"t":"c"}const I={utm_source:"google",utm_medium:"cpc",utm_campaign:"{campaignid}",utm_term:"{keyword}"},R=P();h.searchParams.set("device",R),console.log("ğŸ“± deviceè¨­å®š:",R),Object.entries(I).forEach(([e,n])=>{const u=_(e),v=u||n;h.searchParams.set(e,v),console.log(`ğŸ·ï¸ ${e}è¨­å®š:`,v,u?"(å…ƒURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç”±æ¥)":"(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)")}),c?(h.searchParams.set("utm_creative",c),console.log("ğŸ·ï¸ utm_creativeè¨­å®š:",c,"(å…ƒãƒšãƒ¼ã‚¸URLç”±æ¥)")):(h.searchParams.set("utm_creative","{creative}"),console.log("ğŸ·ï¸ utm_creativeè¨­å®š: {creative} (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)")),["utm_content"].forEach(e=>{const n=w.searchParams.get(e);n&&(h.searchParams.set(e,n),console.log(`ğŸ·ï¸ ${e}è¨­å®š:`,n,"(å…ƒãƒšãƒ¼ã‚¸URLç”±æ¥)"))});const y=h.toString(),U=document.getElementById("clinic-logo"),T=document.getElementById("redirect-message"),j=document.getElementById("redirect-description"),$=document.getElementById("manual-link");T.textContent=`${r.name}å…¬å¼ã‚µã‚¤ãƒˆã¸ç§»å‹•ä¸­...`,j.innerHTML=`ã¾ã‚‚ãªãè‡ªå‹•çš„ã«${r.name}ã®å…¬å¼ã‚µã‚¤ãƒˆã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚<br>ç§»å‹•ã—ãªã„å ´åˆã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`,$.textContent=`${r.name}å…¬å¼ã‚µã‚¤ãƒˆã¸`,$.href=y,$.style.display="inline-block";try{const e=window.dataManager&&window.dataManager.getClinicText(l,"meta13","");U.src=e||`/images/clinics/${l}/${l}-logo.webp`}catch{U.src=`/images/clinics/${l}/${l}-logo.webp`}U.alt=r.name,U.style.display="block",U.onerror=function(){const e=`/images/clinics/${l}/${l}-logo.jpg`;this.src=e,this.onerror=function(){this.style.display="none"}},document.title=`${r.name}å…¬å¼ã‚µã‚¤ãƒˆã¸ç§»å‹•ä¸­...`;let k=2;const L=document.getElementById("countdown"),b=setInterval(()=>{k--,k>0?L.textContent=`${k}ç§’å¾Œã«ç§»å‹•ã—ã¾ã™...`:(L.textContent="ç§»å‹•ä¸­...",clearInterval(b),setTimeout(()=>{if(console.log("ğŸ“¤ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè¡Œæº–å‚™å®Œäº†"),console.log(`  é·ç§»å…ƒ: ${window.location.href}`),console.log(`  é·ç§»å…ˆ: ${y}`),console.log(`  æœ€çµ‚URLæ¤œè¨¼: ${y.startsWith("http")}`),y.includes("param4=")){const e=y.match(/param4=([^&]*)/);if(e&&e[1])try{const n=JSON.parse(decodeURIComponent(e[1]));console.log("âœ… param4è¨­å®šæ¸ˆã¿:",n)}catch{console.log("âœ… param4è¨­å®šæ¸ˆã¿ (ãƒ‡ã‚³ãƒ¼ãƒ‰ä¸å¯):",e[1])}else console.log("âš ï¸ param4ã¯å­˜åœ¨ã™ã‚‹ãŒå€¤ãŒç©º")}else console.log("âŒ param4ãŒURLã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“");if(!y||y==="#"||!y.startsWith("http")){console.error("âŒ ç„¡åŠ¹ãªURL:",y);return}try{console.log("ğŸš€ window.location.hrefå®Ÿè¡Œä¸­..."),window.location.href=y,console.log("âœ… ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‘½ä»¤å®Œäº†")}catch(e){console.error("âŒ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¨ãƒ©ãƒ¼:",e)}setTimeout(()=>{window.location.href.includes("/redirect.html")&&(console.log("âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè¡Œ"),window.location.replace(y))},100)},100))},100);setTimeout(()=>{window.location.href.includes("/redirect.html")&&(L.textContent="è‡ªå‹•ç§»å‹•ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚",L.style.color="#ff6b6b")},5e3),$.addEventListener("click",e=>{e.preventDefault(),clearInterval(b),window.location.href=y})}document.addEventListener("DOMContentLoaded",O);
